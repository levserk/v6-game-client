/*! v6-game-client 2015-03-27 14:39 */
!function(a,b,c){var d,e,f;!function(a){function b(a,b){return u.call(a,b)}function c(a,b){var c,d,e,f,g,h,i,j,k,l,m,n=b&&b.split("/"),o=s.map,p=o&&o["*"]||{};if(a&&"."===a.charAt(0))if(b){for(n=n.slice(0,n.length-1),a=a.split("/"),g=a.length-1,s.nodeIdCompat&&w.test(a[g])&&(a[g]=a[g].replace(w,"")),a=n.concat(a),k=0;k<a.length;k+=1)if(m=a[k],"."===m)a.splice(k,1),k-=1;else if(".."===m){if(1===k&&(".."===a[2]||".."===a[0]))break;k>0&&(a.splice(k-1,2),k-=2)}a=a.join("/")}else 0===a.indexOf("./")&&(a=a.substring(2));if((n||p)&&o){for(c=a.split("/"),k=c.length;k>0;k-=1){if(d=c.slice(0,k).join("/"),n)for(l=n.length;l>0;l-=1)if(e=o[n.slice(0,l).join("/")],e&&(e=e[d])){f=e,h=k;break}if(f)break;!i&&p&&p[d]&&(i=p[d],j=k)}!f&&i&&(f=i,h=j),f&&(c.splice(0,h,f),a=c.join("/"))}return a}function g(b,c){return function(){var d=v.call(arguments,0);return"string"!=typeof d[0]&&1===d.length&&d.push(null),n.apply(a,d.concat([b,c]))}}function h(a){return function(b){return c(b,a)}}function i(a){return function(b){q[a]=b}}function j(c){if(b(r,c)){var d=r[c];delete r[c],t[c]=!0,m.apply(a,d)}if(!b(q,c)&&!b(t,c))throw new Error("No "+c);return q[c]}function k(a){var b,c=a?a.indexOf("!"):-1;return c>-1&&(b=a.substring(0,c),a=a.substring(c+1,a.length)),[b,a]}function l(a){return function(){return s&&s.config&&s.config[a]||{}}}var m,n,o,p,q={},r={},s={},t={},u=Object.prototype.hasOwnProperty,v=[].slice,w=/\.js$/;o=function(a,b){var d,e=k(a),f=e[0];return a=e[1],f&&(f=c(f,b),d=j(f)),f?a=d&&d.normalize?d.normalize(a,h(b)):c(a,b):(a=c(a,b),e=k(a),f=e[0],a=e[1],f&&(d=j(f))),{f:f?f+"!"+a:a,n:a,pr:f,p:d}},p={require:function(a){return g(a)},exports:function(a){var b=q[a];return"undefined"!=typeof b?b:q[a]={}},module:function(a){return{id:a,uri:"",exports:q[a],config:l(a)}}},m=function(c,d,e,f){var h,k,l,m,n,s,u=[],v=typeof e;if(f=f||c,"undefined"===v||"function"===v){for(d=!d.length&&e.length?["require","exports","module"]:d,n=0;n<d.length;n+=1)if(m=o(d[n],f),k=m.f,"require"===k)u[n]=p.require(c);else if("exports"===k)u[n]=p.exports(c),s=!0;else if("module"===k)h=u[n]=p.module(c);else if(b(q,k)||b(r,k)||b(t,k))u[n]=j(k);else{if(!m.p)throw new Error(c+" missing "+k);m.p.load(m.n,g(f,!0),i(k),{}),u[n]=q[k]}l=e?e.apply(q[c],u):void 0,c&&(h&&h.exports!==a&&h.exports!==q[c]?q[c]=h.exports:l===a&&s||(q[c]=l))}else c&&(q[c]=e)},d=e=n=function(b,c,d,e,f){if("string"==typeof b)return p[b]?p[b](c):j(o(b,c).f);if(!b.splice){if(s=b,s.deps&&n(s.deps,s.callback),!c)return;c.splice?(b=c,c=d,d=null):b=a}return c=c||function(){},"function"==typeof d&&(d=e,e=f),e?m(a,b,c,d):setTimeout(function(){m(a,b,c,d)},4),n},n.config=function(a){return n(a)},d._defined=q,f=function(a,c,d){c.splice||(d=c,c=[]),b(q,a)||b(r,a)||(r[a]=[a,c,d])},f.amd={jQuery:!0}}(),f("lib/almond.js",function(){}),function(){function a(){}function b(a,b){for(var c=a.length;c--;)if(a[c].listener===b)return c;return-1}function c(a){return function(){return this[a].apply(this,arguments)}}var d=a.prototype,e=this,g=e.EventEmitter;d.getListeners=function(a){var b,c,d=this._getEvents();if(a instanceof RegExp){b={};for(c in d)d.hasOwnProperty(c)&&a.test(c)&&(b[c]=d[c])}else b=d[a]||(d[a]=[]);return b},d.flattenListeners=function(a){var b,c=[];for(b=0;b<a.length;b+=1)c.push(a[b].listener);return c},d.getListenersAsObject=function(a){var b,c=this.getListeners(a);return c instanceof Array&&(b={},b[a]=c),b||c},d.addListener=function(a,c){var d,e=this.getListenersAsObject(a),f="object"==typeof c;for(d in e)e.hasOwnProperty(d)&&-1===b(e[d],c)&&e[d].push(f?c:{listener:c,once:!1});return this},d.on=c("addListener"),d.addOnceListener=function(a,b){return this.addListener(a,{listener:b,once:!0})},d.once=c("addOnceListener"),d.defineEvent=function(a){return this.getListeners(a),this},d.defineEvents=function(a){for(var b=0;b<a.length;b+=1)this.defineEvent(a[b]);return this},d.removeListener=function(a,c){var d,e,f=this.getListenersAsObject(a);for(e in f)f.hasOwnProperty(e)&&(d=b(f[e],c),-1!==d&&f[e].splice(d,1));return this},d.off=c("removeListener"),d.addListeners=function(a,b){return this.manipulateListeners(!1,a,b)},d.removeListeners=function(a,b){return this.manipulateListeners(!0,a,b)},d.manipulateListeners=function(a,b,c){var d,e,f=a?this.removeListener:this.addListener,g=a?this.removeListeners:this.addListeners;if("object"!=typeof b||b instanceof RegExp)for(d=c.length;d--;)f.call(this,b,c[d]);else for(d in b)b.hasOwnProperty(d)&&(e=b[d])&&("function"==typeof e?f.call(this,d,e):g.call(this,d,e));return this},d.removeEvent=function(a){var b,c=typeof a,d=this._getEvents();if("string"===c)delete d[a];else if(a instanceof RegExp)for(b in d)d.hasOwnProperty(b)&&a.test(b)&&delete d[b];else delete this._events;return this},d.removeAllListeners=c("removeEvent"),d.emitEvent=function(a,b){var c,d,e,f,g=this.getListenersAsObject(a);for(e in g)if(g.hasOwnProperty(e))for(d=g[e].length;d--;)c=g[e][d],c.once===!0&&this.removeListener(a,c.listener),f=c.listener.apply(this,b||[]),f===this._getOnceReturnValue()&&this.removeListener(a,c.listener);return this},d.trigger=c("emitEvent"),d.emit=function(a){var b=Array.prototype.slice.call(arguments,1);return this.emitEvent(a,b)},d.setOnceReturnValue=function(a){return this._onceReturnValue=a,this},d._getOnceReturnValue=function(){return this.hasOwnProperty("_onceReturnValue")?this._onceReturnValue:!0},d._getEvents=function(){return this._events||(this._events={})},a.noConflict=function(){return e.EventEmitter=g,a},"function"==typeof f&&f.amd?f("EE",[],function(){return a}):"object"==typeof module&&module.exports?module.exports=a:e.EventEmitter=a}.call(this),f("modules/game_manager",["EE"],function(a){function b(a,b){if(this.data=a,this.id=a.room,this.owner=b.getUser(a.owner),this.players=[],this.score={games:0},"object"==typeof a.players[0])this.players=a.players;else for(var c=0;c<a.players.length;c++)this.players.push(b.getUser(a.players[c]));for(var c=0;c<this.players.length;c++)this.score[this.players[c].userId]=0}var c=function(a){this.client=a,this.currentRoom=null,this.client.on("disconnected",function(){})};return c.prototype=new a,c.prototype.onMessage=function(a){var b,c=a.data,d=this.client.getPlayer();switch(console.log("game_manager;","message",a),a.type){case"new_game":for(b=0;b<c.players.length;b++)if(c.players[b]==d||c.players[b]==d.userId){if(this.currentRoom){if(!this.currentRoom.isClosed)throw new Error("start game before current game finished! old: "+this.currentRoom.id+" new:"+c.room);this.leaveRoom()}this.onGameStart(c)}break;case"end_game":break;case"ready":console.log("game_manager;","user_ready",c);break;case"round_start":this.onRoundStart(c);break;case"turn":this.onTurn(c);break;case"event":var e=this.getPlayer(c.user);console.log("game_manager;","game event",c,e),this.onUserEvent(e,c);break;case"user_leave":var e=this.getPlayer(c);this.onUserLeave(e);break;case"round_end":this.onRoundEnd(c);break;case"game_restart":this.onGameRestart(c);break;case"error":console.log("game_manager;","error",c)}},c.prototype.onGameStart=function(a){a=new b(a,this.client),console.log("game_manager;","emit game_start",a),this.currentRoom=a,this.emit("game_start",a),this.sendReady()},c.prototype.onRoundStart=function(a){console.log("game_manager;","emit round_start",a),this.currentRoom.current=this.getPlayer(a.first),this.currentRoom.userTime=1e3*this.client.opts.turnTime,this.emit("round_start",{players:[this.getPlayer(a.players[0]),this.getPlayer(a.players[1])],first:this.getPlayer(a.first),id:a.id,inviteData:a.inviteData,score:this.currentRoom.score}),this.emitTime()},c.prototype.onGameRestart=function(a){console.log("game_manager;","game restart",a);var c=new b(a.roomInfo,this.client);console.log("game_manager;","emit game_start",c),this.currentRoom=c,this.emit("game_start",c),this.onRoundStart(a.initData),a.history="["+a.history+"]",a.history=a.history.replace(new RegExp("@","g"),",");var d=JSON.parse(a.history);0!=a.playerTurns.length&&(1==a.playerTurns.length&&(a.playerTurns=a.playerTurns[0]),d.push(a.playerTurns)),this.emit("game_load",d),a.nextPlayer=this.getPlayer(a.nextPlayer),a.nextPlayer&&(this.currentRoom.current=a.nextPlayer,this.currentRoom.userTime=1e3*this.client.opts.turnTime-a.userTime,this.currentRoom.userTime<0&&(this.currentRoom.userTime=0),this.emit("switch_player",this.currentRoom.current),this.emitTime(),this.timeInterval||(this.prevTime=null,this.timeInterval=setInterval(this.onTimeTick.bind(this),100)))},c.prototype.onRoundEnd=function(a){console.log("game_manager","emit round_end",a,this.currentRoom),clearInterval(this.timeInterval),a.mode=this.currentRoom.data.mode,this.timeInterval=null,this.prevTime=null,this.currentRoom.current=null,this.currentRoom.score=a.score,a.winner?a.winner==this.client.getPlayer().userId?(console.log("game_manager;","win",a),a.result="win"):(console.log("game_manager;","lose",a),a.result="lose"):"not_save"==a.winner?console.log("game_manager","not accepted",a):(a.result="draw",console.log("game_manager;","draw",a)),this.emit("round_end",a,this.client.getPlayer())},c.prototype.onUserLeave=function(a){this.currentRoom.isClosed=!0,console.log("game_manager;","user_leave",this.currentRoom,a),a!=this.client.getPlayer()?this.emit("user_leave",a):this.leaveRoom()},c.prototype.onTurn=function(a){console.log("game_manager;","emit turn",a),a.turn.nextPlayer&&(a.nextPlayer=this.getPlayer(a.turn.nextPlayer),delete a.turn.nextPlayer),this.emit("turn",a),a.nextPlayer&&(this.currentRoom.current=a.nextPlayer,this.currentRoom.userTime=1e3*this.client.opts.turnTime,this.emit("switch_player",this.currentRoom.current),this.emitTime(),this.timeInterval||(this.prevTime=null,this.timeInterval=setInterval(this.onTimeTick.bind(this),100)))},c.prototype.onUserEvent=function(a,b){switch(b.type){case"draw":if(a==this.client.getPlayer())return;switch(b.action){case"ask":this.emit("ask_draw",a);break;case"cancel":this.emit("cancel_draw",a)}break;case"timeout":b.nextPlayer&&(b.nextPlayer=this.getPlayer(b.nextPlayer),b.user=this.getPlayer(b.user),this.emit("timeout",b),this.currentRoom.current=b.nextPlayer,this.emit("switch_player",this.currentRoom.current));break;default:console.log("game_manager;","onUserEvent user:",a,"event:",b),this.emit("event",b)}},c.prototype.leaveGame=function(){return this.currentRoom?void this.client.send("game_manager","leave","server",!0):void console.error("game_manager;","leaveGame","game not started!")},c.prototype.leaveRoom=function(){if(!this.currentRoom)return void console.error("game_manager;","leaveRoom","game not started!");if(!this.currentRoom.isClosed)throw new Error("leave not closed room! "+this.currentRoom.id);console.log("game_manager;","emit game_leave;",this.currentRoom),this.emit("game_leave",this.currentRoom),this.currentRoom=null},c.prototype.sendReady=function(){return this.currentRoom?void this.client.send("game_manager","ready","server",!0):void console.error("game_manager;","sendReady","game not started!")},c.prototype.sendTurn=function(a){return this.currentRoom?this.currentRoom.userTime<1e3?void console.warn("game_manager;","your time is out!"):void this.client.send("game_manager","turn","server",a):void console.error("game_manager;","sendTurn","game not started!")},c.prototype.sendThrow=function(){return this.currentRoom?void this.client.send("game_manager","event","server",{type:"throw"}):void console.error("game_manager","sendThrow","game not started!")},c.prototype.sendDraw=function(){return this.currentRoom?void this.client.send("game_manager","event","server",{type:"draw",action:"ask"}):void console.error("game_manager;","sendDraw","game not started!")},c.prototype.sendEvent=function(a,b,c){return this.currentRoom?(console.log("game_manager;","sendEvent",a,b),b.type=a,c?b.target=c:c="server",void this.client.send("game_manager","event",c,b)):void console.error("game_manager;","sendEvent","game not started!")},c.prototype.acceptDraw=function(){return this.currentRoom?void this.client.send("game_manager","event","server",{type:"draw",action:"accept"}):void console.error("game_manager;","acceptDraw","game not started!")},c.prototype.cancelDraw=function(){return this.currentRoom?void this.client.send("game_manager","event","server",{type:"draw",action:"cancel"}):void console.error("game_manager;","cancelDraw","game not started!")},c.prototype.getPlayer=function(a){if(!this.currentRoom)return void console.error("game_manager;","getPlayer","game not started!");if(this.currentRoom)for(var b=0;b<this.currentRoom.players.length;b++)if(this.currentRoom.players[b].userId==a)return this.currentRoom.players[b];return null},c.prototype.inGame=function(){return null!=this.currentRoom},c.prototype.onTimeTick=function(){var a=Date.now();if(!this.prevTime)return void(this.prevTime=a);var b=a-this.prevTime;b>100&&(this.currentRoom.userTime-=b,this.currentRoom.userTime<0&&(this.currentRoom.userTime=0),this.emitTime(),this.prevTime=a)},c.prototype.emitTime=function(){var a=Math.floor(this.currentRoom.userTime/6e4),b=Math.floor((this.currentRoom.userTime-6e4*a)/1e3);10>a&&(a="0"+a),10>b&&(b="0"+b),this.emit("time",{user:this.currentRoom.current,userTimeMS:this.currentRoom.userTime,userTimeS:Math.floor(this.currentRoom.userTime/1e3),userTimePer:this.currentRoom.userTime/this.client.opts.turnTime/1e3,userTimeFormat:a+":"+b})},c}),f("modules/invite_manager",["EE"],function(a){var b=function(a){var b=this;this.client=a,this.invites={},this.invite=null,a.userList.on("leave_user",function(a){b.invite&&b.invite.target==a.userId&&(b.invite=null),b.removeInvite(a.userId)}),a.on("user_relogin",function(a){b.invite&&b.invite.target==a.userId&&(b.invite=null,a.isInvited=!1),b.removeInvite(a.userId)}),a.gameManager.on("game_start",function(){b.cancel(),b.rejectAll(),b.invite=null,b.isPlayRandom=!1,b.client.viewsManager.userListView._setRandomPlay()}),a.on("disconnected",function(){b.invite=null;for(var a in b.invites)b.invites.hasOwnProperty(a)&&b.removeInvite(a)})};return b.prototype=new a,b.prototype.onMessage=function(a){switch(console.log("invite_manager;","message",a),a.type){case"invite":this.onInvite(a.data);break;case"reject":this.onReject(a.data.target,a.data.from,"rejected");break;case"cancel":this.onCancel(a.data)}},b.prototype.onInvite=function(a){return this.invites[a.from]=a,this.isPlayRandom&&this.client.currentMode==a.mode?(console.log("invite_manager;","auto accept invite",a),void this.accept(a.from)):void this.emit("new_invite",{from:this.client.getUser(a.from),data:a})},b.prototype.onReject=function(a,b,c){this.invite.target==a&&this.client.getPlayer().userId==b?(this.emit("reject_invite",{user:this.client.userList.getUser(a),reason:c}),this.invite=null):console.warn("invite_manager; ","wrong user reject invite",a,b)},b.prototype.onCancel=function(a){this.invites[a.from]&&(this.emit("cancel_invite",this.invites[a.from]),this.removeInvite(a.from))},b.prototype.sendInvite=function(a,b){return a?(this.invite&&this.cancel(),b=b||{},b.mode?void console.error("invite param mode is reserved!"):(b.mode=this.client.currentMode,b.target=a,this.invite=b,void this.client.send("invite_manager","invite",a,this.invite))):void console.warn("invite_manager; ","wrong userId to send invite",a)},b.prototype.accept=function(a){if(this.invites[a]){var b=this.invites[a];delete this.invites[a],this.cancel(),this.rejectAll(),this.client.send("invite_manager","accept",a,b)}},b.prototype.reject=function(a){this.invites[a]&&(this.client.send("invite_manager","reject",a,this.invites[a]),this.removeInvite(a))},b.prototype.rejectAll=function(){for(var a in this.invites)this.invites.hasOwnProperty(a)&&(this.client.send("invite_manager","reject",a,this.invites[a]),this.removeInvite(a))},b.prototype.cancel=function(){this.invite&&(this.client.send("invite_manager","cancel",this.invite.target,this.invite),this.invite=null)},b.prototype.removeInvite=function(a){console.log("invite_manger;","removeInvite",a),this.invites[a]&&(this.emit("remove_invite",this.invites[a]),delete this.invites[a])},b.prototype.playRandom=function(a){if(this.client.gameManager.inGame())return void console.warn("You are already in game!");if(a)this.isPlayRandom=!1,this.client.send("invite_manager","random","server",!0);else{for(var b in this.invites)if(this.invites[b].mode==this.client.currentMode)return console.log("invite_manager;","auto accept invite",this.invites[b]),void this.accept(b);this.isPlayRandom=!0;var c="function"==this.client.opts.getUserParams?this.client.opts.getUserParams():{};if(c.mode)return void console.error("invite param mode is reserved!");c.mode=this.client.currentMode,this.client.send("invite_manager","random","server",c)}},b}),f("modules/user_list",["EE"],function(a){function b(a,b,c){if(!a||!a.userId||!a.userName)throw new Error("wrong user data!");for(var d in a)a.hasOwnProperty(d)&&(this[d]=a[d]);this.isPlayer=b||!1,this.getRank=function(a){return this[a||this._client.currentMode].rank||"—"},this._client=c}var c=function(a){var b=this;this.client=a,this.users=[],this.rooms=[],a.on("disconnected",function(){b.rooms=[],b.users=[]}),a.gameManager.on("round_end",function(a){if(a.ratings&&a.mode){for(var c in a.ratings)for(var d=0;d<b.users.length;d++)b.users[d].userId==c&&(b.users[d][a.mode]=a.ratings[c]);this.emit("update",a)}})};return c.prototype=new a,c.prototype.onMessage=function(a){switch(a.type){case"user_login":this.onUserLogin(a.data)}},c.prototype.onUserLogin=function(a,c){var d=new b(a,c,this.client);c&&(this.player=d);for(var e=0;e<this.users.length;e++)if(this.users[e].userId==d.userId)return console.warn("user_list;","user already in list!",d),!1;this.users.push(d),this.emit("new_user",d)},c.prototype.onUserLeave=function(a){for(var b=0;b<this.users.length;b++)if(this.users[b].userId==a){var c=this.users[b];return this.users.splice(b,1),void this.emit("leave_user",c)}console.warn("user_list;","no user in list",a)},c.prototype.onGameStart=function(a,b){for(var c=0;c<b.length;c++)b[c]=this.getUser(b[c]),b[c].isInRoom=!0;var d={room:a,players:b};this.rooms.push(d),this.emit("new_room",d)},c.prototype.onGameEnd=function(a,b){for(var c=0;c<this.rooms.length;c++)if(this.rooms[c].room==a){var d=this.rooms[c];this.rooms.splice(c,1);for(var e=0;e<d.players.length;e++)d.players[e].isInRoom=!1;return void this.emit("close_room",d)}console.warn("user_list;","no room in list",a,b)},c.prototype.getUser=function(a){for(var b=0;b<this.users.length;b++)if(this.users[b].userId==a)return this.users[b];return null},c.prototype.getUsers=function(){var a=this.client.inviteManager.invite;return a?_.map(this.users,function(b){return b.userId===a.target&&(b.isInvited=!0),b}):this.users},c.prototype.getUserList=function(){for(var a,b=[],c=this.client.inviteManager.invite,d=0;d<this.users.length;d++)a=this.users[d],c&&a.userId==c.target?a.isInvited=!0:delete a.isInvited,a.isInRoom||b.push(a);return b.sort(function(a,b){var c=a.getRank();isNaN(+c)&&(c=99999999,a.isPlayer&&(c=1e7));var d=b.getRank();return isNaN(+d)&&(d=99999999,b.isPlayer&&(d=1e8)),+(c>d)}),b},c.prototype.getRoomList=function(){return this.rooms},c}),f("modules/socket",["EE"],function(a){var b=function(a){a=a||{},this.port=a.port||"8080",this.domain=a.domain||document.domain,this.game=a.game||"test",this.url=a.url||this.game,this.https=a.https||!1,this.protocol=this.https?"wss":"ws",this.isConnecting=!0,this.isConnected=!1};return b.prototype=new a,b.prototype.init=function(){var a=this;a.isConnecting=!0,a.isConnected=!1;try{this.ws=new WebSocket(this.protocol+"://"+this.domain+":"+this.port+"/"+this.url),this.ws.onclose=function(b,c){console.log("socket;","ws closed",b,c),a.isConnected&&a.onDisconnect()},this.ws.onerror=function(b){a.onError(b)},this.ws.onmessage=function(b,c){if("ping"==b.data)return void a.ws.send("pong");console.log("socket;","ws message",b,c);try{b=JSON.parse(b.data)}catch(d){return void console.log("socket;","ws wrong data in message",d)}a.onMessage(b)},this.ws.onopen=function(){console.log("socket;",new Date,"ws open"),a.onConnect()}}catch(b){console.log("socket;","ws open error"),this.onError(b)}},b.prototype.onError=function(a){console.log("socket;","ws error",a),this.isConnecting&&(this.isConnecting=!1,console.log("socket;","ws connection failed!"),this.onConnectionFailed())},b.prototype.onConnect=function(){this.isConnected=!0,this.emit("connection")},b.prototype.onDisconnect=function(){this.isConnected=!1,this.emit("disconnection")},b.prototype.onMessage=function(a){this.emit("message",a)},b.prototype.onConnectionFailed=function(){this.isConnecting=!1,this.isConnected=!1,this.emit("failed")},b.prototype.send=function(a){try{a=JSON.stringify(a)}catch(b){return void console.warn("socket;","json stringify err",a,b)}this.ws.send(a)},b}),f("text",["module"],function(a){var b,c,d,f,g,h=["Msxml2.XMLHTTP","Microsoft.XMLHTTP","Msxml2.XMLHTTP.4.0"],i=/^\s*<\?xml(\s)+version=[\'\"](\d)*.(\d)*[\'\"](\s)*\?>/im,j=/<body[^>]*>\s*([\s\S]+)\s*<\/body>/im,k="undefined"!=typeof location&&location.href,l=k&&location.protocol&&location.protocol.replace(/\:/,""),m=k&&location.hostname,n=k&&(location.port||void 0),o={},p=a.config&&a.config()||{};return b={version:"2.0.12",strip:function(a){if(a){a=a.replace(i,"");var b=a.match(j);b&&(a=b[1])}else a="";return a},jsEscape:function(a){return a.replace(/(['\\])/g,"\\$1").replace(/[\f]/g,"\\f").replace(/[\b]/g,"\\b").replace(/[\n]/g,"\\n").replace(/[\t]/g,"\\t").replace(/[\r]/g,"\\r").replace(/[\u2028]/g,"\\u2028").replace(/[\u2029]/g,"\\u2029")},createXhr:p.createXhr||function(){var a,b,c;if("undefined"!=typeof XMLHttpRequest)return new XMLHttpRequest;if("undefined"!=typeof ActiveXObject)for(b=0;3>b;b+=1){c=h[b];try{a=new ActiveXObject(c)}catch(d){}if(a){h=[c];break}}return a},parseName:function(a){var b,c,d,e=!1,f=a.indexOf("."),g=0===a.indexOf("./")||0===a.indexOf("../");return-1!==f&&(!g||f>1)?(b=a.substring(0,f),c=a.substring(f+1,a.length)):b=a,d=c||b,f=d.indexOf("!"),-1!==f&&(e="strip"===d.substring(f+1),d=d.substring(0,f),c?c=d:b=d),{moduleName:b,ext:c,strip:e}},xdRegExp:/^((\w+)\:)?\/\/([^\/\\]+)/,useXhr:function(a,c,d,e){var f,g,h,i=b.xdRegExp.exec(a);return i?(f=i[2],g=i[3],g=g.split(":"),h=g[1],g=g[0],!(f&&f!==c||g&&g.toLowerCase()!==d.toLowerCase()||(h||g)&&h!==e)):!0},finishLoad:function(a,c,d,e){d=c?b.strip(d):d,p.isBuild&&(o[a]=d),e(d)},load:function(a,c,d,e){if(e&&e.isBuild&&!e.inlineText)return void d();p.isBuild=e&&e.isBuild;var f=b.parseName(a),g=f.moduleName+(f.ext?"."+f.ext:""),h=c.toUrl(g),i=p.useXhr||b.useXhr;return 0===h.indexOf("empty:")?void d():void(!k||i(h,l,m,n)?b.get(h,function(c){b.finishLoad(a,f.strip,c,d)},function(a){d.error&&d.error(a)}):c([g],function(a){b.finishLoad(f.moduleName+"."+f.ext,f.strip,a,d)}))},write:function(a,c,d){if(o.hasOwnProperty(c)){var e=b.jsEscape(o[c]);d.asModule(a+"!"+c,"define(function () { return '"+e+"';});\n")}},writeFile:function(a,c,d,e,f){var g=b.parseName(c),h=g.ext?"."+g.ext:"",i=g.moduleName+h,j=d.toUrl(g.moduleName+h)+".js";b.load(i,d,function(){var c=function(a){return e(j,a)};c.asModule=function(a,b){return e.asModule(a,j,b)},b.write(a,i,c,f)},f)}},"node"===p.env||!p.env&&"undefined"!=typeof process&&process.versions&&process.versions.node&&!process.versions["node-webkit"]?(c=e.nodeRequire("fs"),b.get=function(a,b,d){try{var e=c.readFileSync(a,"utf8");0===e.indexOf("﻿")&&(e=e.substring(1)),b(e)}catch(f){d&&d(f)}}):"xhr"===p.env||!p.env&&b.createXhr()?b.get=function(a,c,d,e){var f,g=b.createXhr();if(g.open("GET",a,!0),e)for(f in e)e.hasOwnProperty(f)&&g.setRequestHeader(f.toLowerCase(),e[f]);p.onXhr&&p.onXhr(g,a),g.onreadystatechange=function(){var b,e;4===g.readyState&&(b=g.status||0,b>399&&600>b?(e=new Error(a+" HTTP status: "+b),e.xhr=g,d&&d(e)):c(g.responseText),p.onXhrComplete&&p.onXhrComplete(g,a))},g.send(null)}:"rhino"===p.env||!p.env&&"undefined"!=typeof Packages&&"undefined"!=typeof java?b.get=function(a,b){var c,d,e="utf-8",f=new java.io.File(a),g=java.lang.System.getProperty("line.separator"),h=new java.io.BufferedReader(new java.io.InputStreamReader(new java.io.FileInputStream(f),e)),i="";try{for(c=new java.lang.StringBuffer,d=h.readLine(),d&&d.length()&&65279===d.charAt(0)&&(d=d.substring(1)),null!==d&&c.append(d);null!==(d=h.readLine());)c.append(g),c.append(d);i=String(c.toString())}finally{h.close()}b(i)}:("xpconnect"===p.env||!p.env&&"undefined"!=typeof Components&&Components.classes&&Components.interfaces)&&(d=Components.classes,f=Components.interfaces,Components.utils["import"]("resource://gre/modules/FileUtils.jsm"),g="@mozilla.org/windows-registry-key;1"in d,b.get=function(a,b){var c,e,h,i={};g&&(a=a.replace(/\//g,"\\")),h=new FileUtils.File(a);try{c=d["@mozilla.org/network/file-input-stream;1"].createInstance(f.nsIFileInputStream),c.init(h,1,0,!1),e=d["@mozilla.org/intl/converter-input-stream;1"].createInstance(f.nsIConverterInputStream),e.init(c,"utf-8",c.available(),f.nsIConverterInputStream.DEFAULT_REPLACEMENT_CHARACTER),e.readString(c.available(),i),e.close(),c.close(),b(i.value)}catch(j){throw new Error((h&&h.path||"")+": "+j)}}),b}),f("text!tpls/userListFree.ejs",[],function(){return'<% _.each(users, function(user) { %>\r\n<tr>\r\n    <td class="userName" data-userId="<%= user.userId %>" title="<%= user.userName %>"><%= user.userName %></td>\r\n    <td class="userRank"><%= user.getRank() %></td>\r\n    <% if (user.isPlayer) { %>\r\n    <td></td>\r\n    <% } else if (user.isInvited) { %>\r\n    <td class="inviteBtn activeInviteBtn" data-userId="<%= user.userId %>">Отмена</td>\r\n    <% } else { %>\r\n    <td class="inviteBtn" data-userId="<%= user.userId %>">Пригласить</td>\r\n    <% } %>\r\n\r\n</tr>\r\n\r\n<% }) %>'}),f("text!tpls/userListInGame.ejs",[],function(){return'<% _.each(rooms, function(room) { %>\r\n<tr data-id="<%= room.room %>">\r\n    <td class="userName" title="<%= room.players[0].userName + \' (\' +  room.players[0].getRank(room.mode) + \')\' %>" ><%= room.players[0].userName %></td>\r\n    <td class="userName" title="<%= room.players[1].userName + \' (\' +  room.players[1].getRank(room.mode) + \')\' %>" ><%= room.players[1].userName %></td>\r\n</tr>\r\n<% }) %>'}),f("text!tpls/userListMain.ejs",[],function(){return'<div class="tabs">\r\n    <div data-type="free">Свободны <span></span></div>\r\n    <div data-type="inGame">Играют <span></span></div>\r\n</div>\r\n<div id="userListSearch">\r\n    <label for="userListSearch">Поиск по списку:</label><input type="text" id="userListSearch"/>\r\n</div>\r\n<div class="tableWrap">\r\n    <table class="playerList"></table>\r\n</div>\r\n\r\n<div class="btn" id="randomPlay">\r\n    <span>Играть с любым</span>\r\n</div>'}),f("views/user_list",["underscore","backbone","text!tpls/userListFree.ejs","text!tpls/userListInGame.ejs","text!tpls/userListMain.ejs"],function(a,b,c,d,e){var f=b.View.extend({tagName:"div",id:"userList",tplFree:a.template(c),tplInGame:a.template(d),tplMain:a.template(e),events:{"click .inviteBtn":"_inviteBtnClicked","click .userName":"userClick","click .tabs div":"clickTab","click .disconnectButton":"_reconnect","click #randomPlay":"playClicked"},_reconnect:function(){return this.client.opts.reload?void location.reload(!1):(this.$list.html(this.$loadingTab),void this.client.socket.init())},clickTab:function(a){if(this.client.socket.isConnected){var b=$(a.currentTarget),c=b.attr("data-type");c!==this.currentActiveTabName&&(this.currentActiveTabName=c,this._setActiveTab(this.currentActiveTabName),this.render())}},userClick:function(a){var b=$(a.currentTarget),c=b.attr("data-userId");this.client.onShowProfile(c)},_inviteBtnClicked:function(a){var b=$(a.currentTarget),c=b.attr("data-userId");this.invitePlayer(c)},invitePlayer:function(a){if(this.client.gameManager.currentRoom)return void console.log("you already in game!");var b=this.$el.find('.inviteBtn[data-userId="'+a+'"]');b.hasClass(this.ACTIVE_INVITE_CLASS)?(this.client.inviteManager.cancel(),b.removeClass(this.ACTIVE_INVITE_CLASS),b.html("Пригласить")):(this.$el.find("."+this.ACTIVE_INVITE_CLASS).html("Пригласить").removeClass(this.ACTIVE_INVITE_CLASS),this.client.inviteManager.sendInvite(a,"function"==typeof this.client.opts.getUserParams?this.client.opts.getUserParams():{}),b.addClass(this.ACTIVE_INVITE_CLASS),b.html("Отмена")),console.log("invite user",a)},playClicked:function(){this.client.inviteManager.playRandom(this.client.inviteManager.isPlayRandom),this._setRandomPlay()},initialize:function(a){var b=this.render.bind(this);this.client=a,this.$disconnectedTab=$('<tr class="disconnected"><td><div><span class="disconnectText">Соединение с сервером отсутствует</span><br><br><span class="disconnectButton">Переподключиться</span></div></td></tr>'),this.$loadingTab=$("<tr><td>Загрузка..</td></tr>"),this.$el.html(this.tplMain()),a.opts.blocks.userListId?$("#"+a.opts.blocks.userListId).append(this.el):$("body").append(this.el),this.ACTIVE_INVITE_CLASS="activeInviteBtn",this.ACTIVE_TAB_CLASS="activeTab",this.TEXT_PLAY_ACTIVE="Идет подбор игрока...",this.TEXT_PLAY_UNACTIVE="Играть с любым",this.$list=this.$el.find(".tableWrap table"),this.$counterFree=this.$el.find('.tabs div[data-type="free"]').find("span"),this.$counterinGame=this.$el.find('.tabs div[data-type="inGame"]').find("span"),this.$btnPlay=this.$el.find("#randomPlay"),this.listenTo(this.client.userList,"new_user",b),this.listenTo(this.client,"mode_switch",b),this.listenTo(this.client.userList,"update",b),this.listenTo(this.client.userList,"leave_user",b),this.listenTo(this.client.inviteManager,"reject_invite",this.onRejectInvite.bind(this)),this.listenTo(this.client.userList,"new_room",b),this.listenTo(this.client.userList,"close_room",b),this.listenTo(this.client,"disconnected",b),this.listenTo(this.client,"user_relogin",b),this.currentActiveTabName="free",this._setActiveTab(this.currentActiveTabName),this.$list.html(this.$loadingTab),this.randomPlay=!1},_setRandomPlay:function(){this.client.inviteManager.isPlayRandom?(this.$btnPlay.html(this.TEXT_PLAY_ACTIVE),this.$btnPlay.addClass("active")):(this.$btnPlay.html(this.TEXT_PLAY_UNACTIVE),this.$btnPlay.removeClass("active"))},_setActiveTab:function(a){this.$el.find(".tabs div").removeClass(this.ACTIVE_TAB_CLASS),this.$el.find('.tabs div[data-type="'+a+'"]').addClass(this.ACTIVE_TAB_CLASS)},_setCounters:function(){return this.client.socket.isConnected?(this.$counterFree.html("("+this.client.userList.getUserList().length+")"),void this.$counterinGame.html("("+2*this.client.userList.getRoomList().length+")")):(this.$counterFree.html(""),void this.$counterinGame.html(""))},_showPlayerListByTabName:function(){return this.client.socket.isConnected?void("free"===this.currentActiveTabName?this.$list.html(this.tplFree({users:this.client.userList.getUserList()})):"inGame"===this.currentActiveTabName?this.$list.html(this.tplInGame({rooms:this.client.userList.getRoomList()})):console.warn("unknown tab",this.currentActiveTabName)):void this.$list.html(this.$disconnectedTab)},onRejectInvite:function(a){this.$el.find("."+this.ACTIVE_INVITE_CLASS+'[data-userId="'+a.user.userId+'"]').html("Пригласить").removeClass(this.ACTIVE_INVITE_CLASS)},render:function(){return this.client.unload?void 0:(setTimeout(this._showPlayerListByTabName.bind(this),1),this._setCounters(),this)}});return f}),f("views/dialogs",[],function(){var a=function(){function a(a){n=a,n.inviteManager.on("new_invite",b),n.inviteManager.on("reject_invite",c),n.inviteManager.on("cancel_invite",d),n.inviteManager.on("remove_invite",e),n.gameManager.on("user_leave",f),n.gameManager.on("game_start",l),n.gameManager.on("round_end",i),n.gameManager.on("game_leave",l),n.gameManager.on("ask_draw",g),n.gameManager.on("cancel_draw",h),n.chatManager.on("show_ban",k),n.on("login_error",j)}function b(a){var b=$("<div>");b.addClass(q),b.attr("data-userId",a.from.userId);var c="Вас пригласил в игру пользователь "+a.from.userName;"function"==typeof this.client.opts.generateInviteText&&(c=this.client.opts.generateInviteText(a)),b.html(c).dialog({resizable:!0,draggable:!1,modal:!1,buttons:{"Принять":function(){n.inviteManager.accept($(this).attr("data-userId")),$(this).remove()
},"Отклонить":function(){n.inviteManager.reject($(this).attr("data-userId")),$(this).remove()}},close:function(){n.inviteManager.reject($(this).attr("data-userId")),$(this).remove()}}).parent().draggable()}function c(a){var b=$("<div>");b.addClass(q),b.addClass(p),b.html("Пользователь "+a.user.userName+" отклонил ваше приглашение").dialog({resizable:!1,modal:!1,buttons:{"Ок":function(){$(this).remove()}}})}function d(a){console.log("cancel invite",a)}function e(a){var b=a.from;console.log("remove invite",b),$("."+q+'[data-userId="'+b+'"]').remove()}function f(a){l();var b=$("<div>");b.addClass(q),b.addClass(p),b.html("Пользователь "+a.userName+" покинул игру").dialog({resizable:!1,modal:!1,buttons:{"Ок":function(){$(this).remove(),n.gameManager.leaveRoom()}}})}function g(a){console.log("ask draw",a);var b=$("<div>");b.addClass(p),b.html("Пользователь "+a.userName+" предлагает ничью").dialog({resizable:!1,modal:!1,buttons:{"Принять":function(){n.gameManager.acceptDraw(),$(this).remove()},"Отклонить":function(){n.gameManager.cancelDraw(),$(this).remove()}},close:function(){n.gameManager.cancelDraw(),$(this).remove()}}).parent().draggable()}function h(a){console.log("cancel draw",a);var b=$("<div>");b.addClass(p),b.html("Пользователь "+a.userName+" отклонил ваше предложение о ничье").dialog({resizable:!1,modal:!1,buttons:{"Ок":function(){$(this).remove()}}})}function i(a){l();var b=$("<div>");b.addClass(r);var c="";switch(a.result){case"win":c="Победа";break;case"lose":c="Поражение";break;case"draw":c="Ничья";break;default:c="игра окночена"}o=setTimeout(function(){b.html(c+"<br><br> Сыграть с соперником еще раз?").dialog({resizable:!1,modal:!1,width:350,buttons:{"Да, начать новую игру":function(){$(this).remove(),n.gameManager.sendReady()},"Нет, выйти":function(){$(this).remove(),n.gameManager.leaveGame()}},close:function(){$(this).remove(),n.gameManager.leaveGame()}})},n.opts.resultDialogDelay)}function j(){var a=$("<div>");a.addClass(p),a.html("Ошибка авторизации. Обновите страницу").dialog({resizable:!1,modal:!1,buttons:{"Ок":function(){$(this).remove()}}})}function k(a){var b=$("<div>");b.addClass(p);var c="Вы не можете писать сообщения в чате, т.к. добавлены в черный список ";c+=a.reason&&""!=a.reason?"за "+a.reason:"за употребление нецензурных выражений и/или спам ",a.timeEnd&&(c+=a.timeEnd>228e10?" навсегда":" до "+m(a.timeEnd)),b.html(c).dialog({resizable:!1,modal:!1,buttons:{"Ок":function(){$(this).remove()}}})}function l(){$("."+p).remove(),$("."+r).remove(),$("."+q).remove(),clearTimeout(o)}function m(a){function b(a,b,c){for(a=""+a;a.length<b;)a=c+a;return a}var c=new Date(a),d=c.getDate(),e=c.getMonth()+1,f=(""+c.getFullYear()).substr(2,2);return b(d,2,"0")+"."+b(e,2,"0")+"."+f}var n,o,p="dialogNotification",q="dialogInvite",r="dialogRoundResult";return{init:a}}();return a}),f("text!tpls/v6-chatMain.ejs",[],function(){return'<div class="tabs">\r\n    <div class="tab" data-type="public">Общий чат</div>\r\n    <div class="tab" data-type="private" style="display: none;">игрок</div>\r\n</div>\r\n<div class="clear"></div>\r\n<div class="messagesWrap"><ul></ul></div>\r\n<div class="inputMsg" contenteditable="true"></div>\r\n<div class="layer1">\r\n    <div class="sendMsgBtn">Отправить</div>\r\n    <select id="chat-select">\r\n        <option selected>Готовые сообщения</option>\r\n        <option>Привет!</option>\r\n        <option>Молодец!</option>\r\n        <option>Здесь кто-нибудь умеет играть?</option>\r\n        <option>Кто со мной?</option>\r\n        <option>Спасибо!</option>\r\n        <option>Спасибо! Интересная игра!</option>\r\n        <option>Спасибо, больше играть не могу. Ухожу!</option>\r\n        <option>Спасибо, интересная игра! Сдаюсь!</option>\r\n        <option>Отличная партия. Спасибо!</option>\r\n        <option>Ты мог выиграть</option>\r\n        <option>Ты могла выиграть</option>\r\n        <option>Ходи!</option>\r\n        <option>Дай ссылку на твою страницу вконтакте</option>\r\n        <option>Снимаю шляпу!</option>\r\n        <option>Красиво!</option>\r\n        <option>Я восхищен!</option>\r\n        <option>Где вы так научились играть?</option>\r\n        <option>Еще увидимся!</option>\r\n        <option>Ухожу после этой партии. Спасибо!</option>\r\n        <option>Минуточку</option>\r\n    </select>\r\n</div>\r\n<div class="layer2">\r\n    <span class="chatAdmin">\r\n        <input type="checkbox" id="chatIsAdmin"/><label for="chatIsAdmin">От админа</label>\r\n    </span>\r\n\r\n    <span class="chatRules">Правила чата</span>\r\n</div>\r\n\r\n<ul class="menuElement noselect">\r\n    <li data-action="invite"><span>Пригласить в игру</span></li>\r\n    <li data-action="showProfile"><span>Показать профиль</span></li>\r\n    <li data-action="ban"><span>Забанить в чате</span></li>\r\n</ul>'}),f("text!tpls/v6-chatMsg.ejs",[],function(){return'<li class="chatMsg" data-msgId="<%= msg.time %>">\r\n    <div class="msgRow1">\r\n        <div class="smallRight time"><%= msg.t %></div>\r\n        <div class="smallRight rate"><%= (msg.rank || \'—\') %></div>\r\n        <div class="chatUserName" data-userId="<%= msg.userId%>" title="<%= msg.userName %>">\r\n            <span class="userName"><%= msg.userName %></span>\r\n        </div>\r\n    </div>\r\n    <div class="msgRow2">\r\n        <div class="delete" title="Удалить сообщение" style="background-image: url(<%= imgDel %>);"></div>\r\n        <div class="msgTextWrap">\r\n            <span class="v6-msgText"><%= _.escape(msg.text) %></span>\r\n        </div>\r\n    </div>\r\n</li>'}),f("text!tpls/v6-chatDay.ejs",[],function(){return'<li class="chatDay" data-day-msgId="<%= time %>">\r\n    <div>\r\n        <%= d %>\r\n    </div>\r\n</li>'}),f("text!tpls/v6-chatRules.ejs",[],function(){return'<div id="chat-rules" class="aboutPanel">\r\n    <img class="closeIcon" src="<%= close %>">\r\n\r\n    <div style="padding: 10px 12px 15px 25px;">\r\n        <h2>Правила чата</h2>\r\n        <p style="line-height: 16px;">В чате запрещено:<br>\r\n            <span style="margin-left:5px;">1. использование ненормативной лексики и оскорбительных выражений</span><br>\r\n            <span style="margin-left:5px;">2. хамское и некорректное общение с другими участниками</span><br>\r\n            <span style="margin-left:5px;">3. многократная публикация бессмысленных, несодержательных или одинаковых сообщений.</span>\r\n        </p>\r\n\r\n        <p style="line-height: 16px;"><span style="margin-left:5px;">Баны</span> выносятся: на 1 день, на 3 дня, на 7 дней,на\r\n            месяц или навсегда, в зависимости от степени тяжести нарушения.\r\n        </p>\r\n\r\n        <p style="line-height: 16px;"><span style="margin-left:5px;">Бан</span> снимается автоматически по истечении срока.\r\n        </p>\r\n\r\n    </div>\r\n</div>'}),f("text!tpls/v6-chatBan.ejs",[],function(){return'<div>\r\n    <span class="ban-username" style="font-weight:bold;">Бан игрока <i><%= userName%></i></span><br><br>\r\n    <span>Причина бана:</span>\r\n    <br>\r\n    <div class="inputTextField" id="ban-reason" contenteditable="true" style="height:54px; border: 1px solid #aaaaaa;"></div><br>\r\n\r\n    <span>Длительность бана:</span><br>\r\n    <select id="ban-duration">\r\n        <option value="1">1 день</option>\r\n        <option value="3">3 дня</option>\r\n        <option value="7" selected="">7 дней</option>\r\n        <option value="30">30 дней</option>\r\n        <option value="9999">Навсегда</option>\r\n    </select>\r\n\r\n</div>'}),f("views/chat",["underscore","backbone","text!tpls/v6-chatMain.ejs","text!tpls/v6-chatMsg.ejs","text!tpls/v6-chatDay.ejs","text!tpls/v6-chatRules.ejs","text!tpls/v6-chatBan.ejs"],function(a,b,c,d,e,f,g){var h=b.View.extend({tagName:"div",id:"v6Chat",tplMain:a.template(c),tplMsg:a.template(d),tplDay:a.template(e),tplRules:a.template(f),tplBan:a.template(g),events:{"click .chatMsg":"_deleteMsg","click .tab":"clickTab","blur .inputMsg":"blurInputMsg","click .inputMsg":"clickInputMsg","click .sendMsgBtn":"sendMsgEvent","keyup .inputMsg":"sendMsgEvent","change #chat-select":"changeChatSelect","click .chatMsg div[data-userid]":"showMenu","click li[data-action]":"clickDialogAction","click .chatRules":"showChatRules"},banUser:function(a,b){{var c=this.client.chatManager;$(this.tplBan({userName:b})).attr("data-userId",a).dialog({buttons:{"Добавить в бан":function(){c.banUser($(this).attr("data-userId"),$(this).find("#ban-duration")[0].value,$(this).find("#ban-reason").html()),$(this).remove()},"Отмена":function(){$(this).remove()}},close:function(){$(this).remove()}}).parent().draggable()}},showChatRules:function(){this.$rules.css({top:$(window).height()/2-this.$rules.outerHeight()/2,left:$(window).width()/2-this.$rules.outerWidth()/2}).show()},clickDialogAction:function(a){var b={action:$(a.currentTarget).attr("data-action"),userId:this.$menu.attr("data-userId"),userName:this.$menu.attr("data-userName")};switch(b.action){case"showProfile":this.client.onShowProfile(b.userId,b.userName);break;case"invite":this.client.viewsManager.userListView.invitePlayer(b.userId);break;case"ban":this.banUser(b.userId,b.userName)}},showMenu:function(a){var b=a.target.getBoundingClientRect(),c=20;setTimeout(function(){this.$menu.attr("data-userId",$(a.target).parent().attr("data-userid")),this.$menu.attr("data-userName",$(a.target).html()),this.$menu.css({left:c,top:b.top-document.getElementById("v6Chat").getBoundingClientRect().top+c}).slideDown()}.bind(this),0)},hideMenuElement:function(){this.$menu.removeAttr("data-userId"),this.$menu.hide()},changeChatSelect:function(a){var b=a.target.options[a.target.selectedIndex].innerHTML;this.$SELECTED_OPTION.attr("selected",!0),this.$inputMsg.text(b)},sendMsgEvent:function(a){("keyup"!==a.type||13===a.keyCode)&&(this.$inputMsg.has(this.$placeHolderSpan).length||this._sendMsg(this.$inputMsg.text()))},scrollEvent:function(){this.$messagesWrap[0].scrollHeight-this.$messagesWrap.height()!=0&&this.$messagesWrap.scrollTop()<5&&!this.client.chatManager.fullLoaded[this.client.chatManager.current]&&(this._setLoadingState(),this.client.chatManager.loadMessages())},_sendMsg:function(a){if(""!==a&&"string"==typeof a){if(a.length>this.MAX_MSG_LENGTH)return void alert(this.MAX_LENGTH_MSG);this.client.chatManager.sendMessage(a,null,$("#chatIsAdmin")[0].checked),this.$inputMsg.empty(),this.$inputMsg.focus()}},blurInputMsg:function(a){var b=$(a.currentTarget);""===b.text()&&b.empty().append(this.$placeHolderSpan)},clickInputMsg:function(a){var b=$(a.currentTarget);b.has(this.$placeHolderSpan).length&&b.empty()},clickTab:function(a){var b=$(a.target),c=b.attr("data-type");c!==this.currentActiveTabName&&(this.currentActiveTabName=c,this._setActiveTab(this.currentActiveTabName),this.client.chatManager.loadCachedMessages(this.tabs[c].target))},initialize:function(a){this.client=a,this.images=a.opts.images,this.$el.html(this.tplMain()),this.MAX_MSG_LENGTH=128,this.SCROLL_VAL=40,this.MAX_LENGTH_MSG="Сообщение слишком длинное (максимальная длина - 128 символов). Сократите его попробуйте снова",this.CLASS_DISABLED="disabled",this.CLASS_CHATADMIN="chatAdmin",this.CLASS_DELETE_CHAT_MESSAGE="delete",this.CLASS_NEW_MSG="newMsg",this.CLASS_ADMIN_MSG="isAdmin",this.ACTIVE_TAB_CLASS="activeTab",this.CLASS_MENU_ELEMENT="menuElement",this.$menu=this.$el.find("."+this.CLASS_MENU_ELEMENT),this.client.isAdmin||this.$menu.find('li[data-action="ban"]').remove(),window.document.body.addEventListener("click",this.hideMenuElement.bind(this)),this.$rules=$(this.tplRules({close:this.images.close})),window.document.body.appendChild(this.$rules[0]),this.$rules.find("img.closeIcon").on("click",function(){this.$rules.hide()}.bind(this)),this.$placeHolderSpan=$('<span class="placeHolderSpan">Введите ваше сообщение..</span>'),this.$spinnerWrap=$('<li class="spinnerWrap"><div class="spinner" style="background: url('+this.images.spin+');"></div></li>'),this.$messagesWrap=this.$el.find(".messagesWrap"),this.$msgsList=this.$messagesWrap.find("ul"),this.$inputMsg=this.$el.find(".inputMsg"),this.$SELECTED_OPTION=this.$el.find("select option:selected"),this.currentActiveTabName="public",this.currentActiveTabTitle=a.game,this.tabs={"public":{target:a.game,title:"Общий чат"},"private":null},this._setActiveTab(this.currentActiveTabName),a.opts.blocks.chatId?$("#"+a.opts.blocks.chatId).append(this.el):$("body").append(this.el),this.$inputMsg.empty().append(this.$placeHolderSpan),this._setLoadingState(),this.client.isAdmin&&this.$el.find("."+this.CLASS_CHATADMIN).removeClass(this.CLASS_CHATADMIN),this.listenTo(this.client.chatManager,"message",this._addOneMsg.bind(this)),this.listenTo(this.client.chatManager,"load",this._preaddMsgs.bind(this)),this.listenTo(this.client.chatManager,"open_dialog",this._openDialog.bind(this)),this.listenTo(this.client.chatManager,"close_dialog",this._closeDialog.bind(this)),this.$messagesWrap.scroll(this.scrollEvent.bind(this))},setPublicTab:function(a){this.tabs["public"].target=a,this.currentActiveTabName="public",this._setActiveTab("public")},_setActiveTab:function(a){var b=this.$el.find('.tabs div[data-type="'+a+'"]');this.$el.find(".tabs div").removeClass(this.ACTIVE_TAB_CLASS),b.addClass(this.ACTIVE_TAB_CLASS),b.html(this.tabs[a].title),b.show(),this.$msgsList.html(""),this._setLoadingState(),this.currentActiveTabTitle=this.tabs[a].target},render:function(){return this},_openDialog:function(a){a.userId&&(this.tabs["private"]={target:a.userId,title:a.userName}),this.currentActiveTabName="private",this._setActiveTab("private")},_closeDialog:function(){this.currentActiveTabName="public",this._setActiveTab("public"),this.$el.find('.tabs div[data-type="private"]').hide()},_deleteMsg:function(a){var b,c;if(isNaN(+a)||"number"!=typeof+a){if(!$(a.target).hasClass(this.CLASS_DELETE_CHAT_MESSAGE))return;b=$(a.currentTarget),c=b.attr("data-msgId")}else c=a;return c&&this.client.chatManager.deleteMessage(parseFloat(c)),b||(b=this.$el.find('li[data-msgId="'+c+'"]').remove()),b?void b.remove():void console.warn("cannot find msg with  id",c,a)},_addOneMsg:function(a){if(a.target==this.currentActiveTabTitle){var b=this.tplMsg({msg:a,imgDel:this.images.del}),c=this.$messagesWrap[0].scrollHeight-this.$messagesWrap.height()-this.$messagesWrap.scrollTop()<this.SCROLL_VAL;this.client.chatManager.last[a.target]&&this.client.chatManager.last[a.target].d==a.d||this.$msgsList.append(this.tplDay(a)),this.$msgsList.append(b),b=this.$el.find('li[data-msgId="'+a.time+'"]'),a.admin&&b.addClass(this.CLASS_ADMIN_MSG),b.addClass(this.CLASS_NEW_MSG),setTimeout(function(){this.$el.find('li[data-msgId="'+a.time+'"]').removeClass(this.CLASS_NEW_MSG)}.bind(this),2500),c&&this.$messagesWrap.scrollTop(this.$messagesWrap[0].scrollHeight)}},_preaddMsgs:function(a){if((!a||a.target==this.currentActiveTabTitle)&&(this._removeLoadingState(),a)){var b=this.$messagesWrap.scrollTop(),c=this.$messagesWrap[0].scrollHeight,d=this.$el.find('li[data-day-msgId="'+this.client.chatManager.first[a.target].time+'"]');d&&d.remove(),this.client.chatManager.first[a.target].d!=a.d&&this.$msgsList.prepend(this.tplDay(this.client.chatManager.first[a.target]));var e=this.tplMsg({msg:a,imgDel:this.images.del});this.$msgsList.prepend(e),this.$msgsList.prepend(this.tplDay(a)),e=this.$el.find('li[data-msgId="'+a.time+'"]'),a.admin&&e.addClass(this.CLASS_ADMIN_MSG),this.$messagesWrap.scrollTop(b+this.$messagesWrap[0].scrollHeight-c)}},_setLoadingState:function(){this.$msgsList.prepend(this.$spinnerWrap),this.$messagesWrap.addClass(this.CLASS_DISABLED)},_removeLoadingState:function(){this.$spinnerWrap.remove(),this.$messagesWrap.removeClass(this.CLASS_DISABLED)}});return h}),f("text!tpls/v6-settingsMain.ejs",[],function(){return'\r\n    <img class="closeIcon" src="<%= close %>">\r\n    <div class="settingsContainer">\r\n    <%= settings %>\r\n    </div>\r\n    <div >\r\n        <div class="confirmBtn">OK</div>\r\n    </div>\r\n'}),f("text!tpls/v6-settingsDefault.ejs",[],function(){return'<p>Настройки игры</p>\r\n<div>\r\n    <div class="option">\r\n        <label><input type="checkbox" name="sounds">\r\n            Включить звук</label>\r\n    </div>\r\n    <div class="option">\r\n        <label><input type="checkbox" name="disableInvite">\r\n            Запретить приглашать меня в игру</label>\r\n    </div>\r\n</div>\r\n'}),f("views/settings",["underscore","backbone","text!tpls/v6-settingsMain.ejs","text!tpls/v6-settingsDefault.ejs"],function(a,b,c,d){var e=b.View.extend({tagName:"div",id:"v6-settings",tplMain:a.template(c),tplDefault:a.template(d),events:{"click .closeIcon":"close","change input":"changed","click .confirmBtn":"save"},initialize:function(b){this.client=b,this.images=b.opts.images,this.changedProperties=[],this.$el.html(this.tplMain({close:this.images.close,settings:b.opts.settingsTemplate?a.template(b.opts.settingsTemplate)():this.tplDefault()})),$("body").append(this.$el),this.$el.hide()},changed:function(a){var b=$(a.target),c=b.prop("type"),d=b.prop("name"),e="radio"==c?b.val():b.prop("checked"),f=(this.client.settings,this.client.defaultSettings);f.hasOwnProperty(d)?(console.log("settings; changed",{property:d,value:e,type:c}),-1==this.changedProperties.indexOf(d)&&this.changedProperties.push(d),this.client._onSettingsChanged({property:d,value:e,type:c})):console.warn("settings;","default settings does not have property",d)},save:function(){this.$el.hide(),this.isClosed=!0;var a,b,c=this.client.defaultSettings,d=this.client.settings;if(0==this.changedProperties.length)return void console.log("settings; nothing changed");for(var e in c)c.hasOwnProperty(e)&&(a=d[e],"boolean"==typeof a?(b=this.$el.find("input[name="+e+"]"),a=b.prop("checked")):(b=this.$el.find("input[name="+e+"]:checked"),a=b.val()),b?(console.log("settings; save",e,a,b.prop("type")),d[e]=a):console.error("settings;","input element not found! ",e));this.client.saveSettings()},load:function(){this.changedProperties=[];var a,b,c=this.client.defaultSettings,d=this.client.settings;for(var e in c)c.hasOwnProperty(e)&&(a=d[e],b=this.$el.find("boolean"==typeof a?"input[name="+e+"]":"input[name="+e+"][value="+a+"]"),b?(console.log("settings; load",e,a,b.prop("type")),b.prop("checked",!!a)):console.error("settings;","input element not found! ",e,a))},close:function(){this.$el.hide(),this.isClosed=!0;for(var a,b,c,d=this.client.settings,e=0;e<this.changedProperties.length;e++)c=this.changedProperties[e],b=d[c],a=this.$el.find("boolean"==typeof b?"input[name="+c+"]":"input[name="+c+"][value="+b+"]"),a?(console.log("settings; default",{property:c,value:b,type:a.prop("type")}),this.client._onSettingsChanged({property:c,value:b,type:a.prop("type")})):console.error("settings;","input element not found! ",c,b)},show:function(){this.$el.css({top:$(window).height()/2-this.$el.outerHeight()/2,left:$(window).width()/2-this.$el.outerWidth()/2}).show(),this.load()}});return e}),f("modules/views_manager",["views/user_list","views/dialogs","views/chat","../views/settings"],function(a,b,c,d){var e=function(a){this.client=a,this.userListView=null,this.dialogsView=b,this.chat=null};return e.prototype.init=function(){this.userListView=new a(this.client),this.dialogsView.init(this.client),this.v6ChatView=new c(this.client),this.settingsView=new d(this.client)},e.prototype.closeAll=function(){this.client.ratingManager.close(),this.client.historyManager.close(),this.settingsView.close()},e.prototype.showSettings=function(){this.settingsView.show()},e}),f("modules/chat_manager",["EE"],function(a){var b=function(a){this.client=a,this.first={},this.last={},this.fullLoaded={},this.messages={},this.current=a.game,this.MSG_COUNT=10,a.on("login",function(){this.current=a.game,a.viewsManager.v6ChatView.setPublicTab(a.game),this.loadMessages()}.bind(this)),a.gameManager.on("game_start",function(a){for(var b=0;b<a.players.length;b++)a.players[b].isPlayer||this.openDialog(a.players[b].userId,a.players[b].userName)}.bind(this)),a.gameManager.on("game_leave",function(a){for(var b=0;b<a.players.length;b++)a.players[b].isPlayer||this.closeDialog(a.players[b].userId)}.bind(this))};return b.prototype=new a,b.initMessage=function(a,c,d){a.userData[d]&&(a.rank=a.userData[d].rank),(!a.rank||a.rank<1)&&(a.rank="—"),a.target==c.userId&&(a.target=a.userId),a.admin&&(a.rank="",a.userId=0,a.userName="Админ"),a.date=new Date(a.time);var e=a.date.getHours(),f=a.date.getMinutes();return 10>e&&(e="0"+e),10>f&&(f="0"+f),a.t=e+":"+f,a.d=a.date.getDate()+" "+b.months[a.date.getMonth()]+" "+a.date.getFullYear(),a},b.months=["Января","Февраля","Марта","Апреля","Мая","Июня","Июля","Сентября","Октября","Ноября","Декабря"],b.prototype.onMessage=function(a){var c,d,e=a.data,f=this.client.getPlayer();switch(console.log("chat_manager;","message",a),a.type){case"message":a=b.initMessage(e,f,this.client.currentMode),this.first[a.target]||(this.first[a.target]=a),this.messages[a.target]||(this.messages[a.target]=[]),d=this.messages[a.target],d.push(a),d.length>100&&d.shift(),this.emit("message",a),this.last[a.target]=a,a.target!=this.client.game&&a.target!=this.current&&this.openDialog(a.userId,a.userName);break;case"load":if(!e.length||e.length<1)return this.fullLoaded[this.current]=!0,void this.emit("load",null);for(a=b.initMessage(e[0],f,this.client.currentMode),this.messages[a.target]||(this.messages[a.target]=[]),d=this.messages[a.target],c=0;c<e.length;c++)this.onMessageLoad(b.initMessage(e[c],f,this.client.currentMode),d);break;case"ban":this.ban=a.data,this.emit("show_ban",a.data)}},b.prototype.sendMessage=function(a,b,c){if(this.ban)return void this.emit("show_ban",this.ban);var d={text:a};c&&(d.admin=!0),b||(d.target=this.current),this.client.send("chat_manager","message","server",d)},b.prototype.loadMessages=function(a,b,c){return this.fullLoaded[this.current]?(console.log("chat_manager;","all messages loaded!",a,b,this.first),void this.emit("load",null)):(a=a||this.MSG_COUNT,c||(c=this.current),b=b||(this.first[c]?this.first[c].time:null),console.log("chat_manager;","loading messages",a,b,this.first),void this.client.send("chat_manager","load","server",{count:a,time:b,target:c}))},b.prototype.onMessageLoad=function(a,b){b&&b.length<100&&b.unshift(a),this.first[a.target]||(this.first[a.target]=a),this.last[a.target]||(this.last[a.target]=a),this.emit("load",a),this.first[a.target]=a},b.prototype.openDialog=function(a,b){this.current=a,this.emit("open_dialog",{userId:a,userName:b}),this.loadCachedMessages(a)},b.prototype.closeDialog=function(a){this.emit("close_dialog",a||this.current),this.loadCachedMessages(this.client.game)},b.prototype.loadCachedMessages=function(a){if(this.current=a,this.first[a]=this.last[a]=null,this.messages[a]&&this.messages[a].length>0)for(var b=this.messages[a].length-1;b>=0;b--)this.onMessageLoad(this.messages[a][b]);this.messages[a]&&this.messages[a].length>0&&this.messages[a].length<this.MSG_COUNT?this.loadMessages(this.MSG_COUNT,this.messages[a][0],a):this.loadMessages(this.MSG_COUNT,null,a)},b.prototype.banUser=function(a,b,c){console.log("chat_manager;","banUser",a,b,c),this.client.send("chat_manager","ban","server",{userId:a,days:b,reason:c})},b.prototype.deleteMessage=function(a){console.log("chat_manager;","deleteMessage",a),this.client.send("chat_manager","delete","server",{time:a})},b}),f("text!tpls/v6-historyMain.ejs",[],function(){return'<div id="v6-history">\r\n    <div class="historyHeader"><img class="closeIcon" src="<%= close %>" title="Закрыть окно истории"></div>\r\n    <div class="historyWrapper">\r\n        <table class="historyTable">\r\n            <thead>\r\n                <tr></tr>\r\n            </thead>\r\n            <tbody>\r\n            </tbody>\r\n        </table>\r\n        <div class="noHistory">Сохранения отсутствуют</div>\r\n        <div class="loading"><img src="<%= spin %>"></div>\r\n    </div>\r\n</div>'}),f("text!tpls/v6-historyHeaderTD.ejs",[],function(){return'<td class="sessionHeader historyDate" rowspan="<%= rows %>"> <%= date %> </td>\r\n<td class="sessionHeader historyName" rowspan="<%= rows %>">\r\n    <span class="userName" data-userid="<%= userId %>"><%= userName %></span>\r\n    <span class="userRank">(<%= rank %>)</span>\r\n    <span class="userScore"><%= score %></span>\r\n    <div class="eloDiff <%= (eloDiff>-1?\'diffPositive\':\'diffNegative\')%>"><%= eloDiff ===\'\'?\'\':(eloDiff>-1?\'+\'+eloDiff:eloDiff)%></div>\r\n</td>'}),f("text!tpls/v6-historyTH.ejs",[],function(){return'<th colspan="<%= colspan %>" title="<%= title %>"><%= value %></th>'}),f("text!tpls/v6-historyTR.ejs",[],function(){return'<tr title="<%= title %>" class="<%= trclass %>" data-id="<%= id %>" ><%= value %></tr>'}),f("text!tpls/v6-ratingTab.ejs",[],function(){return'<span class="unactiveLink"  data-idtab="<%= id %>"><%= title %></span>&nbsp;&nbsp;'}),f("views/history",["underscore","backbone","text!tpls/v6-historyMain.ejs","text!tpls/v6-historyHeaderTD.ejs","text!tpls/v6-historyTH.ejs","text!tpls/v6-historyTR.ejs","text!tpls/v6-ratingTab.ejs"],function(a,b,c,d,e,f,g){var h=b.View.extend({tagName:"div",id:"v6History",tplMain:a.template(c),tplHeadTD:a.template(d),tplTD:function(a){return"<td>"+a+"</td>"},tplTH:a.template(e),tplTR:a.template(f),tplTab:a.template(g),events:{"click .closeIcon":"close","click .historyTable tr":"trClicked","click .historyTable .userName":"userClicked","click .historyHeader span":"tabClicked"},initialize:function(a,b){this.conf=a,this._manager=b,this.tabs=a.tabs,this.columns=a.columns,this.$el.html(this.tplMain({close:a.images.close,spin:a.images.spin})),this.$head=this.$el.find(".historyHeader"),this.$titles=$(this.$el.find(".historyTable thead tr")[0]),this.$tbody=$(this.$el.find(".historyTable tbody")[0]),this.$noHistory=$(this.$el.find(".noHistory")),this.ACTIVE_TAB="activeLink",this.UNACTIVE_TAB="unactiveLink",this.WIN_CLASS="historyWin",this.LOSE_CLASS="historyLose",this.DRAW_CLASS="historyDraw",this.renderTabs(),this.renderHead(),this.isClosed=!1},trClicked:function(a){if(!$(a.target).hasClass("sessionHeader")&&!$(a.target).hasClass("userName")){var b=$(a.currentTarget).attr("data-id");this._manager.getGame(b)}},userClicked:function(a){var b=$(a.currentTarget).attr("data-userid"),c=$(a.currentTarget).html();this._manager.client.onShowProfile(b,c)},tabClicked:function(a){var b=$(a.currentTarget).attr("data-idtab");this.setActiveTab(b),this._manager.getHistory(b,!0)},close:function(){this.$el.hide(),this.isClosed=!0},renderTabs:function(){for(var a in this.tabs)this.$head.append(this.tplTab(this.tabs[a])),this.setActiveTab(this.tabs[0].id)},renderHead:function(){for(var a=0;a<this.columns.length;a++)this.$titles.append(this.tplTH({title:this.columns[a].title,value:this.columns[a].title,colspan:this.columns[a].dynamic?2:1}))},renderHistory:function(a,b){for(var c=0;c<b.length;c++)this.renderSession(a,b[c])},renderSession:function(a,b){for(var c,d,e=0;e<b.length;e++)c=this.renderRow(a,b[e],0==e,b.length),d="draw"==b[e].result?this.DRAW_CLASS:"win"==b[e].result?this.WIN_CLASS:this.LOSE_CLASS,this.$tbody.append(this.tplTR({title:b[e].result,trclass:d,id:b[e].id,value:c}))},renderRow:function(a,b,c,d){var e,f="";c&&(f=this.tplHeadTD({rows:d,date:b.date,userId:b.opponent.userId,userName:b.opponent.userName,rank:b.opponent[a].rank,eloDiff:d>1?b.elo.diff:"",score:b.gameScore}));for(var g=2;g<this.columns.length;g++)e=b[this.columns[g].source],void 0==e&&(e=this.columns[g].undef),this.columns[g].dynamic?(f+=this.tplTD((e.dynamic>-1&&""!==e.dynamic?"+":"")+e.dynamic),f+=this.tplTD(e.value)):f+=this.tplTD(e);return f},render:function(a,b,c){return this.$tbody.children().remove(),this.$el.show(),this.setActiveTab(a),c===!0&&this.$el.find(".closeIcon").hide(),c===!1&&this.$el.find(".closeIcon").show(),b?(0==b.length&&this.$noHistory.show(),this.$el.find(".loading").hide(),console.log("render history",b),this.renderHistory(a,b)):(this.isClosed=!1,this.$el.find(".loading").show(),this.$noHistory.hide()),this},setActiveTab:function(a){if(a&&this.tabs&&!(this.tabs.length<2))for(var b=0;b<this.tabs.length;b++)this.tabs[b].active=!1,this.tabs[b].id!=a?this.$head.find('span[data-idtab="'+this.tabs[b].id+'"]').removeClass(this.ACTIVE_TAB).addClass(this.UNACTIVE_TAB):(this.$head.find('span[data-idtab="'+this.tabs[b].id+'"]').removeClass(this.UNACTIVE_TAB).addClass(this.ACTIVE_TAB),this.currentTab=this.tabs[b])}});return h}),f("modules/history_manager",["EE","views/history"],function(a,b){function c(a){var b=["янв","фев","мар","апр","май","июн","июл","сен","окт","ноя","дек"],c=new Date(a),d=c.getDate(),e=b[c.getMonth()],f=c.getFullYear();return 10>d&&(d="0"+d),d+" "+e+" "+f}function d(a){var b=new Date(a),c=b.getHours(),d=b.getMinutes();return 10>c&&(c="0"+c),10>d&&(d="0"+d),c+":"+d}var e=function(a){this.client=a,this.currentRoom=null,this.conf={tabs:[],subTabs:[],columns:[{id:"date",source:"date",title:"Дата"},{id:"opponent",source:"opponent",title:"Противник"},{id:"time",source:"time",title:"Время"},{id:"number",source:"number",title:"#"},{id:"elo",source:"elo",title:"Рейтинг",dynamic:!0,startValue:1600}]},"function"==typeof a.opts.initHistory&&(this.conf=a.opts.initHistory(this.conf)),this.conf.images=a.opts.images,this.$container=$(a.opts.blocks.historyId?"#"+a.opts.blocks.historyId:"body"),this.isCancel=!1,this.userId=!1,this.currentMode=!1};return e.prototype=new a,e.prototype.init=function(){if(this.client.modes.length>1)for(var a=0;a<this.client.modes.length;a++)this.conf.tabs.push({id:this.client.modes[a],title:this.client.getModeAlias(this.client.modes[a])});this.historyView=new b(this.conf,this)},e.prototype.onMessage=function(a){var b=a.data;switch(console.log("history_manager;","message",a),a.type){case"history":this.onHistoryLoad(b.mode,b.history,b.userId);break;case"game":this.onGameLoad(b.mode,b.game)}},e.prototype.onHistoryLoad=function(a,b,c){console.log("history_manager;","history load",c,b),setTimeout(function(){if(!this.historyView.isClosed){var d=[];this.userId=c,this.currentMode=a;for(var e=b.length-1;e>-1;e--)this.formatHistoryRow(b[e],d,a,b.length-e,c);this.$container.append(this.historyView.render(a,d).$el)}}.bind(this),200)},e.prototype.onGameLoad=function(a,b){console.log("history_manager;","game load",b),b.history="["+b.history+"]",b.history=b.history.replace(new RegExp("@","g"),","),b.history=JSON.parse(b.history),b.initData=JSON.parse(b.initData),b.userData=JSON.parse(b.userData);for(var c=[],d=0;d<b.players.length;d++)c.push(b.userData[b.players[d]]);if(c.length!=c.length)throw new Error("UserData and players are different!");b.players=c,console.log("history_manager;","game parsed",b),setTimeout(function(){this.isCancel||this.emit("game_load",b)}.bind(this),200)},e.prototype.formatHistoryRow=function(a,b,e,f,g){var h,i,j,k={win:0,lose:0,id:a._id,number:f},l=JSON.parse(a.userData);0==b.length?(h=[],i=null):(h=b[0],i=h[0]),j=g==a.players[0]?a.players[1]:a.players[0];for(var m=0;m<this.conf.columns.length;m++){var n=this.conf.columns[m];-1==["date","opponent","time","number","elo"].indexOf(n.id)&&(k[n.source]=l[g][e][n.source])}k.opponent=l[j],k.date=c(a.timeStart),k.time=d(a.timeStart),a.winner?a.winner==g?(k.result="win",k.win++):(k.result="lose",k.lose++):k.result="draw",i&&i.date==k.date&&i.opponent.userId==k.opponent.userId&&(k.win+=i.win,k.lose+=i.lose),k.gameScore=k.win+":"+k.lose,k.elo={value:l[g][e].ratingElo},k.elo.dynamic=i?k.elo.value-i.elo.value:"",i&&i.date==k.date&&i.opponent.userId==k.opponent.userId?(k.elo.diff=i.elo.diff+k.elo.dynamic,h.unshift(k)):(k.elo.diff=k.elo.dynamic||0,h=[],h.unshift(k),b.unshift([]),b[0]=h)},e.prototype.getHistory=function(a,b,c){b||(this.$container=$(this.client.opts.blocks.historyId?"#"+this.client.opts.blocks.historyId:"body")),this.$container.append(this.historyView.render(a||this.client.currentMode,!1,c).$el),this.client.send("history_manager","history","server",{mode:a||this.client.currentMode,userId:b?this.userId:!1})},e.prototype.getProfileHistory=function(a,b,c){if(c&&(this.$container=$("#"+c)),!this.$container)throw new Error("wrong history container id! "+c);
this.$container.append(this.historyView.render(a,!1,!0).$el),this.userId=b,this.client.send("history_manager","history","server",{mode:a||this.client.currentMode,userId:b})},e.prototype.getGame=function(a,b,c){b=b||this.userId||this.client.getPlayer().userId,c=c||this.currentMode||this.client.currentMode,this.isCancel=!1,this.client.send("history_manager","game","server",{mode:c,id:a,userId:b})},e.prototype.close=function(){this.historyView.close()},e.prototype.testHistory=[{timeStart:1424080866344,timeEnd:1424080868891,players:["22050161915831","95120799727737"],mode:"default",winner:"22050161915831",action:"game_over",userData:'{"22050161915831":{"userId":"22050161915831","userName":"us_22050161915831","dateCreate":1424080636958,"default":{"win":4,"lose":2,"draw":0,"games":6,"rank":1,"ratingElo":1627}},"95120799727737":{"userId":"95120799727737","userName":"us_95120799727737","dateCreate":1424080722018,"default":{"win":1,"lose":2,"draw":0,"games":3,"rank":5,"ratingElo":1587}}}'},{timeStart:1424080860196,timeEnd:1424080862868,players:["22050161915831","95120799727737"],mode:"default",winner:"22050161915831",action:"game_over",userData:'{"22050161915831":{"userId":"22050161915831","userName":"us_22050161915831","dateCreate":1424080636958,"default":{"win":3,"lose":2,"draw":0,"games":5,"rank":3,"ratingElo":1613}},"95120799727737":{"userId":"95120799727737","userName":"us_95120799727737","dateCreate":1424080722018,"default":{"win":1,"lose":1,"draw":0,"games":2,"rank":5,"ratingElo":1600}}}'},{timeStart:1424080754813,timeEnd:1424080762501,players:["95120799727737","22050161915831"],mode:"default",winner:"95120799727737",action:"game_over",userData:'{"95120799727737":{"userId":"95120799727737","userName":"us_95120799727737","dateCreate":1424080722018,"default":{"win":1,"lose":0,"draw":0,"games":1,"rank":3,"ratingElo":1615}},"22050161915831":{"userId":"22050161915831","userName":"us_22050161915831","dateCreate":1424080636958,"default":{"win":2,"lose":2,"draw":0,"games":4,"rank":5,"ratingElo":1598}}}'},{timeStart:1424080713717,timeEnd:1424080715662,players:["98637392232194","22050161915831"],mode:"default",winner:"98637392232194",action:"game_over",userData:'{"98637392232194":{"userId":"98637392232194","userName":"us_98637392232194","dateCreate":1424080704161,"default":{"win":1,"lose":0,"draw":0,"games":1,"rank":1,"ratingElo":1616}},"22050161915831":{"userId":"22050161915831","userName":"us_22050161915831","dateCreate":1424080636958,"default":{"win":2,"lose":1,"draw":0,"games":3,"rank":3,"ratingElo":1612}}}'},{timeStart:1424080696911,timeEnd:1424080698325,players:["22050161915831","21508051152341"],mode:"default",winner:"22050161915831",action:"game_over",userData:'{"22050161915831":{"userId":"22050161915831","userName":"us_22050161915831","dateCreate":1424080636958,"default":{"win":2,"lose":0,"draw":0,"games":2,"rank":1,"ratingElo":1627}},"21508051152341":{"userId":"21508051152341","userName":"us_21508051152341","dateCreate":1423834457435,"default":{"win":0,"lose":3,"draw":0,"games":3,"rank":4,"ratingElo":1561}}}'},{timeStart:1424080690059,timeEnd:1424080692709,players:["22050161915831","21508051152341"],mode:"default",winner:"22050161915831",action:"game_over",userData:'{"22050161915831":{"userId":"22050161915831","userName":"us_22050161915831","dateCreate":1424080636958,"default":{"win":1,"lose":0,"draw":0,"games":1,"rank":2,"ratingElo":1614}},"21508051152341":{"userId":"21508051152341","userName":"us_21508051152341","dateCreate":1423834457435,"default":{"win":0,"lose":2,"draw":0,"games":2,"rank":4,"ratingElo":1573}}}'}],e}),f("text!tpls/v6-ratingMain.ejs",[],function(){return'<div id="v6-rating">\r\n    <img class="closeIcon" src="<%= close %>" title="Закрыть окно рейтинга">\r\n    <div>\r\n        <!-- rating filter panel -->\r\n        <div class="filterPanel">\r\n            <div style="margin-left: 8px;">\r\n\r\n            </div>\r\n        </div>\r\n        <!-- rating table -->\r\n        <table class="ratingTable" cellspacing="0">\r\n            <thead>\r\n                <tr class="headTitles">\r\n\r\n                </tr>\r\n                <tr class="headIcons">\r\n\r\n                </tr>\r\n            </thead>\r\n            <tbody class="ratingTBody">\r\n\r\n            </tbody>\r\n        </table>\r\n\r\n        <div class="loading"><img src="<%= spin %>"></div>\r\n\r\n        <!-- div show more -->\r\n        <div class="chat-button chat-post" id="ratingShowMore">\r\n            <span>Ещё 500 игроков</span>\r\n        </div>\r\n\r\n        <!-- div bottom buttons -->\r\n        <div class="footButtons">\r\n            <div style="float:left"><span class="activeLink" id="jumpTop">[в начало рейтинга]</span></div>\r\n            <div style="float:right"><span class="activeLink" id="closeRatingBtn">[закрыть]</span> </div>\r\n        </div>\r\n    </div>\r\n</div>'}),f("text!tpls/v6-ratingTD.ejs",[],function(){return'<td data-idcol="<%= id %>" class="rating<%= id %>"><div><%= value %><sup class="greenSup"><%= sup %></sup></div></td>'}),f("text!tpls/v6-ratingTH.ejs",[],function(){return'<th data-idcol="<%= id %>" class="ratingTH<%= id %>" title="<%= title %>"><%= value %></th>'}),f("text!tpls/v6-ratingTR.ejs",[],function(){return'<tr class="<%= trclass %>" data-userId="<%= userId %>" data-userName="<%= userName %>"><%= value %></tr>'}),f("text!tpls/v6-ratingSearch.ejs",[],function(){return'<div style="padding-bottom:2px;">\r\n    <div style="float:left;margin-top:4px;">Поиск:</div>\r\n    <input type="text" placeholder="Поиск по имени" id="ratingAutoComplete" value="">\r\n</div>'}),f("text!tpls/v6-ratingPhoto.ejs",[],function(){return'<div style="float:right;margin-top:2px;">\r\n    <a href="<%= photo %>" rel="lightbox" data-lightbox="<%= photo %>"><img src="i/camera.png"></a>\r\n</div>'}),f("text!tpls/v6-ratingUser.ejs",[],function(){return'<span class="userName" data-userid="<%= userId %>"><%= userName %></span>'}),f("views/rating",["underscore","backbone","text!tpls/v6-ratingMain.ejs","text!tpls/v6-ratingTD.ejs","text!tpls/v6-ratingTH.ejs","text!tpls/v6-ratingTR.ejs","text!tpls/v6-ratingTab.ejs","text!tpls/v6-ratingSearch.ejs","text!tpls/v6-ratingPhoto.ejs","text!tpls/v6-ratingUser.ejs"],function(a,b,c,d,e,f,g,h,i,j){var k=b.View.extend({tagName:"div",id:"v6Rating",tplMain:a.template(c),tplTD:a.template(d),tplTH:a.template(e),tplTR:a.template(f),tplTab:a.template(g),tplSearch:a.template(h),tplUser:a.template(j),tplPhoto:a.template(i),events:{"click .closeIcon":"close","click #closeRatingBtn":"close","click .headTitles th":"thClicked","click .headIcons th":"thClicked","click .filterPanel span":"tabClicked","click .ratingTable .userName":"userClicked"},thClicked:function(a){for(var b=$(a.currentTarget).attr("data-idcol"),c=0;c<this.columns.length;c++)if(this.columns[c].id==b&&this.columns[c].canOrder){this.setColumnOrder(b),console.log("log; rating col clicked",this.columns[c]),this.manager.getRatings(this.currentSubTab.id,this.currentCollumn.id,this.currentCollumn.order<0?"desc":"asc");break}},tabClicked:function(a){for(var b=$(a.currentTarget).attr("data-idtab"),c=0;c<this.subTabs.length;c++)if(this.subTabs[c].id==b)return this.setActiveSubTab(b),void this.manager.getRatings(this.currentSubTab.id,this.currentCollumn.id,this.currentCollumn.order<0?"desc":"asc")},userClicked:function(a){var b=$(a.currentTarget).attr("data-userid"),c=$(a.currentTarget).html();this.manager.client.onShowProfile(b,c)},initialize:function(a,b){this.conf=a,this.manager=b,this.tabs=a.tabs,this.subTabs=a.subTabs,this.columns=a.columns,this.$el.html(this.tplMain({close:this.conf.images.close,spin:this.conf.images.spin})),this.$tabs=$(this.$el.find(".filterPanel").children()[0]),this.$titles=this.$el.find(".headTitles"),this.$icons=this.$el.find(".headIcons"),this.$head=this.$icons.parent(),this.$tbody=$(this.$el.find(".ratingTable tbody")[0]),this.NOVICE='<span style="color: #C42E21 !important;">новичок</span>',this.IMG_BOTH='<img src="'+a.images.sortBoth+'">',this.IMG_ASC='<img src="'+a.images.sortAsc+'">',this.IMG_DESC='<img src="'+a.images.sortDesc+'">',this.ACTIVE_TAB="activeLink",this.UNACTIVE_TAB="unactiveLink",this.SORT="sorted",this.YOU="Вы:",this.HEAD_USER_CLASS="headUser",this.ACTIVE_CLASS="active",this.ONLINE_CLASS="online",this.USER_CLASS="user",this.renderTabs(),this.renderHead(),this.isClosed=!1},close:function(){this.$el.hide(),this.isClosed=!0},renderTabs:function(){for(var a in this.tabs)this.$tabs.append(this.tplTab(this.tabs[a])),this.setActiveTab(this.tabs[0].id);if(this.subTabs.length>1){this.$tabs.append("<br>");for(var a in this.subTabs)this.$tabs.append(this.tplTab(this.subTabs[a])),this.setActiveSubTab(this.subTabs[0].id)}},renderHead:function(){var a,b;for(var c in this.columns)a=this.columns[c],a.canOrder&&(a.order="ratingElo"==a.id?1:0),b={id:a.id,title:a.topTitle||"",value:a.title},this.$titles.append(this.tplTH(b)),b.value=a.canOrder?this.IMG_BOTH:"","rank"==a.id&&(b.value=""),"userName"==a.id&&(b.value=this.tplSearch()),this.$icons.append(this.tplTH(b));this.setColumnOrder("ratingElo")},renderRatings:function(a){var b;if(a.infoUser&&(b=a.infoUser,this.$head.append(this.tplTR({trclass:this.HEAD_USER_CLASS,userId:b.userId,userName:b.userName,value:this.renderRow(b,!0)}))),a.allUsers)for(var c=0;c<a.allUsers.length;c++){b=a.allUsers[c];var d="";b.user&&(d+=this.USER_CLASS+" "),b.active&&(d+=this.ACTIVE_CLASS),this.$tbody.append(this.tplTR({trclass:d,userId:b.userId,userName:b.userName,value:this.renderRow(b)}))}},renderRow:function(a,b){for(var c,d="",e=0;e<this.columns.length;e++)void 0==a[this.columns[e].source]&&(a[this.columns[e].source]=this.columns[e].undef),c={id:this.columns[e].id,value:a[this.columns[e].source],sup:""},"userName"==c.id&&(c.value=this.tplUser({userName:a.userName,userId:a.userId})),b&&("rank"==c.id&&(c.value=this.YOU),"userName"==c.id&&(c.value+=" ("+(a.rank>0?a.rank:"-")+" место)")),"userName"==c.id&&a.photo&&(c.value+=this.tplPhoto(a.photo)),d+=this.tplTD(c);return d},setActiveTab:function(a){for(var b=0;b<this.tabs.length;b++)this.tabs[b].active=!1,this.tabs[b].id!=a?this.$tabs.find('span[data-idtab="'+this.tabs[b].id+'"]').removeClass(this.ACTIVE_TAB).addClass(this.UNACTIVE_TAB):(this.$tabs.find('span[data-idtab="'+this.tabs[b].id+'"]').removeClass(this.UNACTIVE_TAB).addClass(this.ACTIVE_TAB),this.currentTab=this.tabs[b])},setActiveSubTab:function(a){for(var b=0;b<this.subTabs.length;b++)this.subTabs[b].active=!1,this.subTabs[b].id!=a?this.$tabs.find('span[data-idtab="'+this.subTabs[b].id+'"]').removeClass(this.ACTIVE_TAB).addClass(this.UNACTIVE_TAB):(this.$tabs.find('span[data-idtab="'+this.subTabs[b].id+'"]').removeClass(this.UNACTIVE_TAB).addClass(this.ACTIVE_TAB),this.currentSubTab=this.subTabs[b])},setColumnOrder:function(a,b){for(var c=2;c<this.columns.length;c++)this.columns[c].id!=a?(this.columns[c].order=0,this.$titles.find('th[data-idcol="'+this.columns[c].id+'"]').removeClass(this.SORT),this.$icons.find('th[data-idcol="'+this.columns[c].id+'"]').removeClass(this.SORT).html(this.columns[c].canOrder?this.IMG_BOTH:"")):(this.currentCollumn=this.columns[c],this.columns[c].order=b?"desc"==b?-1:1:this.columns[c].order<1?1:-1,this.$titles.find('th[data-idcol="'+this.columns[c].id+'"]').addClass(this.SORT),this.$icons.find('th[data-idcol="'+this.columns[c].id+'"]').addClass(this.SORT).html(this.columns[c].order>0?this.IMG_ASC:this.IMG_DESC))},render:function(a,b,c,d){return this.$head.find("."+this.HEAD_USER_CLASS).remove(),this.$tbody.children().remove(),this.$el.show(),this.setColumnOrder(c,d),b&&this.setActiveSubTab(b),a?(this.$head.show(),this.$el.find(".loading").hide(),console.log("render ratings",a),this.renderRatings(a)):(this.isClosed=!1,this.$el.find(".loading").show(),this.$head.hide()),this}});return k}),f("modules/rating_manager",["EE","views/rating"],function(a,b){function c(a){function b(a,b,c){for(a=""+a;a.length<b;)a=c+a;return a}var c=new Date(a),d=c.getDate(),e=c.getMonth()+1,f=(""+c.getFullYear()).substr(2,2);return b(d,2,"0")+"."+b(e,2,"0")+"."+f}var d=function(a){this.client=a,this.currentRoom=null,this.conf={tabs:[{id:"all_players",title:"все игроки"}],subTabs:[],columns:[{id:"rank",source:"rank",title:"Место",canOrder:!1},{id:"userName",source:"userName",title:"Имя",canOrder:!1},{id:"ratingElo",source:"ratingElo",title:"Рейтинг <br> Эло",canOrder:!0},{id:"win",source:"win",title:"Выиграл <br> у соперников",canOrder:!0},{id:"percent",source:"percent",title:" % ",canOrder:!1},{id:"dateCreate",source:"dateCreate",title:"Дата <br> регистрации",canOrder:!0}]},"function"==typeof a.opts.initRating&&(this.conf=a.opts.initRating(this.conf)),this.conf.images=a.opts.images,this.$container=$(a.opts.blocks.ratingId?"#"+a.opts.blocks.ratingId:"body")};return d.prototype=new a,d.prototype.init=function(){for(var a=0;a<this.client.modes.length;a++)this.conf.subTabs.push({id:this.client.modes[a],title:this.client.getModeAlias(this.client.modes[a])});this.ratingView=new b(this.conf,this)},d.prototype.onMessage=function(a){var b=a.data;switch(console.log("rating_manager;","message",a),a.type){case"ratings":this.onRatingsLoad(b.mode,b.ratings,b.column,b.order)}},d.prototype.onRatingsLoad=function(a,b,c,d){var e=!1;if(!this.ratingView.isClosed){b.infoUser&&(b.infoUser=this.formatRatingsRow(a,b.infoUser,b.infoUser[a].rank));for(var f=0;f<b.allUsers.length;f++)"ratingElo"==c&&"desc"==d&&(e=f+1),b.allUsers[f]=this.formatRatingsRow(a,b.allUsers[f],e);setTimeout(function(){this.$container.append(this.ratingView.render(b,a,c,d).$el)}.bind(this),200)}},d.prototype.formatRatingsRow=function(a,b,d){var e={userId:b.userId,userName:b.userName,photo:void 0};for(var f in b[a])e[f]=b[a][f];return e.rank=d!==!1?d:"",this.client.getPlayer()&&b.userId==this.client.getPlayer().userId&&(e.user=!0),this.client.userList.getUser(b.userId)&&(e.active=!0),e.percent=e.games>0?Math.floor(e.win/e.games*100):0,e.dateCreate=Date.now()-b.dateCreate<864e5?this.ratingView.NOVICE:c(b.dateCreate),e},d.prototype.getRatings=function(a,b,c){this.$container.append(this.ratingView.render(!1).$el),this.client.send("rating_manager","ratings","server",{mode:a||this.client.currentMode,column:b,order:c})},d.prototype.close=function(){this.ratingView.close()},d.prototype.testRatings={allUsers:[{userId:"95514",userName:"us_95514",dateCreate:1423486149906,mode1:{win:2,lose:0,draw:0,games:2,rank:1,ratingElo:1627},mode2:{win:1,lose:0,draw:0,games:1,rank:1,ratingElo:1615}},{userId:"93361",userName:"us_93361",dateCreate:1423486098554,mode1:{win:1,lose:0,draw:0,games:1,rank:2,ratingElo:1615},mode2:{win:0,lose:0,draw:0,games:0,rank:0,ratingElo:1600}},{userId:"99937",userName:"us_99937",dateCreate:1423486099570,mode1:{win:0,lose:3,draw:0,games:3,rank:3,ratingElo:1561},mode2:{win:0,lose:1,draw:0,games:1,rank:2,ratingElo:1586}}],infoUser:{userId:"99937",userName:"us_99937",dateCreate:1423486099570,mode1:{win:0,lose:3,draw:0,games:3,rank:3,ratingElo:1561},mode2:{win:0,lose:1,draw:0,games:1,rank:2,ratingElo:1586}}},d}),f("client",["modules/game_manager","modules/invite_manager","modules/user_list","modules/socket","modules/views_manager","modules/chat_manager","modules/history_manager","modules/rating_manager","EE"],function(a,b,c,d,e,f,g,h,i){var j=function(i){this.version="0.7.4",i.resultDialogDelay=i.resultDialogDelay||0,i.modes=i.modes||i.gameModes||["default"],i.reload=i.reload||!1,i.turnTime=i.turnTime||60,i.blocks=i.blocks||{},i.images=i.images||{close:"i/close.png",spin:"i/spin.gif",sortAsc:"i/sort-asc.png",sortDesc:"i/sort-desc.png",sortBoth:"i/sort-both.png",del:"i/delete.png"},i.settings=i.settings||{};try{this.isAdmin=i.isAdmin||LogicGame.isSuperUser()}catch(j){this.isAdmin=!1,console.error(j)}var l=this;this.opts=i,this.game=i.game||"test",this.defaultSettings=$.extend(k,i.settings),this.modesAlias={},this.gameManager=new a(this),this.userList=new c(this),this.inviteManager=new b(this),this.chatManager=new f(this),this.viewsManager=new e(this),this.historyManager=new g(this),this.ratingManager=new h(this),this.currentMode=null,this.socket=new d(i),this.socket.on("connection",function(){console.log("client;","socket connected")}),this.socket.on("disconnection",function(){console.log("client;","socket disconnected"),l.isLogin=!1,l.emit("disconnected")}),this.socket.on("failed",function(){console.log("client;","socket connection failed"),l.emit("disconnected")}),this.socket.on("message",function(a){console.log("client;","socket message",a),l.onMessage(a)}),this.getUser=this.userList.getUser.bind(this.userList),l.unload=!1,window.onbeforeunload=function(){l.unload=!0}};j.prototype=new i,j.prototype.init=function(){return this.socket.init(),this.viewsManager.init(),console.log("client;","init version:",this.version),this},j.prototype.onMessage=function(a){switch(a.module){case"server":this.onServerMessage(a);break;case"invite_manager":this.inviteManager.onMessage(a);break;case"game_manager":this.gameManager.onMessage(a);break;case"chat_manager":this.chatManager.onMessage(a);break;case"history_manager":this.historyManager.onMessage(a);break;case"rating_manager":this.ratingManager.onMessage(a)}},j.prototype.onServerMessage=function(a){var b=a.data;switch(a.type){case"login":this.onLogin(b.you,b.userlist,b.rooms,b.opts,b.ban,b.settings);break;case"user_relogin":var c=this.userList.getUser(b.userId);console.log("client;","user relogin",c),c&&this.emit("user_relogin",c);break;case"user_login":this.userList.onUserLogin(b);break;case"user_leave":this.userList.onUserLeave(b);break;case"new_game":this.userList.onGameStart(b.room,b.players),this.gameManager.onMessage(a);break;case"end_game":this.userList.onGameEnd(b.room,b.players);break;case"error":this.onError(b)}},j.prototype.onLogin=function(a,b,c,d,e,f){console.log("client;","login",a,b,c,d,e,f),f=f||{},this.game=this.opts.game=d.game,this.modes=this.opts.modes=d.modes,this.modesAlias=this.opts.modesAlias=d.modesAlias||this.modesAlias,this.opts.turnTime=d.turnTime,this.chatManager.ban=e,this.currentMode=this.modes[0],this.settings=$.extend(this.defaultSettings,f),console.log("client;","settings",this.settings),this.userList.onUserLogin(a,!0);for(var g=0;g<b.length;g++)this.userList.onUserLogin(b[g]);for(g=0;g<c.length;g++)this.userList.onGameStart(c[g].room,c[g].players);this.isLogin=!0,this.emit("login",a),this.ratingManager.init(),this.historyManager.init()},j.prototype.send=function(a,b,c,d){return this.socket.isConnected?this.isLogin?("object"==typeof a&&a.module&&a.type&&a.data&&(b=a.type,d=a.data,c=a.target,a=a.module),a&&b&&d&&c?("server"!=c&&(this.userList.getUser(c)||console.warn("client;","send message to offline user!",c)),void this.socket.send({module:a,type:b,target:c,data:d})):void console.warn("client;","some arguments undefined!",a,b,c,d)):void console.error("Client can not send message, client is not login!"):void console.error("Client can not send message, socket is not connected!")},j.prototype.setMode=function(a){if(!this.socket.isConnected||!this.isLogin)return void console.error("Client can set mode, socket is not connected!");if(!this.modes||this.modes.length<1)return void console.error("Client can set mode, no modes!");if(this.modes[a])return this.currentMode=this.modes[a],void this.emit("mode_switch",this.currentMode);for(var b=0;b<this.modes.length;b++)if(this.modes[b]==a)return this.currentMode=a,void this.emit("mode_switch",this.currentMode);console.error("wrong mode:",a,"client modes:",this.modes)},j.prototype.onError=function(a){console.error("client;","server error",a),"login_error"==a&&(this.emit("login_error"),this.socket.ws.close())},j.prototype.onShowProfile=function(a,b){if(!b){var c=this.userList.getUser(a);if(!c)return void console.error("client;","user",a," is not online!, can not get his name");b=c.userName}this.emit("show_profile",{userId:a,userName:b})},j.prototype.getPlayer=function(){return this.userList.player},j.prototype.getModeAlias=function(a){return this.modesAlias[a]?this.modesAlias[a]:a},j.prototype.saveSettings=function(a){a=a||this.settings;var b={};for(var c in this.defaultSettings)this.defaultSettings.hasOwnProperty(c)&&(b[c]=a[c]);console.log("client;","save settings:",b),this.send("server","settings","server",b),this.emit("settings_saved",a)},j.prototype._onSettingsChanged=function(a){this.emit("settings_changed",a)};var k={disableInvite:!1,sounds:!0};return j}),f("v6-game-client",["client"],function(a){return console.log("main;",new Date,"ready"),a}),f("main.js",["v6-game-client"],function(a){return a}),f("require-cnf",[],function(){}),f("jquery",function(){return a}),f("jquery-ui",function(){return a}),f("underscore",function(){return b}),f("backbone",function(){return c}),e(["require-cnf"],function(){e(["v6-game-client"],function(a){console.log("app v6-game-client start"),window.Client=a},void 0,!0)},void 0,!0)}($,_,Backbone);
/*! v6-game-client 2015-02-06 16:58 */
define("modules/game_manager",["EE"],function(a){function b(a,b){if(this.data=a,this.id=a.room,this.owner=b.getUser(a.owner),this.players=[],"object"==typeof a.players[0])this.players=a.players;else for(var c=0;c<a.players.length;c++)this.players.push(b.getUser(a.players[c]))}var c=function(a){this.client=a,this.currentRoom=null,this.client.on("disconnected",function(){})};return c.prototype=new a,c.prototype.onMessage=function(a){var b,c=a.data,d=this.client.getPlayer();switch(console.log("game_manager;","message",a),a.type){case"new_game":for(b=0;b<c.players.length;b++)if(c.players[b]==d||c.players[b]==d.userId){if(this.currentRoom){if(!this.currentRoom.isClosed)throw new Error("start game before current game finished! old: "+this.currentRoom.id+" new:"+c.room);this.leaveRoom()}this.onGameStart(c)}break;case"end_game":break;case"ready":console.log("game_manager;","user_ready",c);break;case"round_start":this.onRoundStart(c);break;case"turn":console.log("game_manager;","emit turn",c),c.turn.nextPlayer&&(c.nextPlayer=this.getPlayer(c.turn.nextPlayer),delete c.turn.nextPlayer),this.emit("turn",c),c.nextPlayer&&(this.currentRoom.current=c.nextPlayer,this.currentRoom.userTime=1e3*this.client.opts.turnTime,this.emit("switch_player",this.currentRoom.current),this.emitTime(),this.timeInterval||(this.prevTime=null,this.timeInterval=setInterval(this.onTimeTick.bind(this),100)));break;case"event":var e=this.getPlayer(c.user);console.log("game_manager;","game event",c,e),this.onUserEvent(e,c);break;case"user_leave":var e=this.getPlayer(c);this.onUserLeave(e);break;case"round_end":this.onRoundEnd(c);break;case"error":console.log("game_manager;","error",c)}},c.prototype.onGameStart=function(a){a=new b(a,this.client),console.log("game_manager;","emit game_start",a),this.currentRoom=a,this.emit("game_start",a),this.sendReady()},c.prototype.onRoundStart=function(a){console.log("game_manager;","emit round_start",a),this.currentRoom.current=this.getPlayer(a.first),this.currentRoom.userTime=1e3*this.client.opts.turnTime,this.emit("round_start",{players:[this.getPlayer(a.players[0]),this.getPlayer(a.players[1])],first:this.getPlayer(a.first),id:a.id,inviteData:a.inviteData}),this.emitTime()},c.prototype.onRoundEnd=function(a){console.log("game_manager","emit round_end",a,this.currentRoom),clearInterval(this.timeInterval),a.mode=this.currentRoom.data.mode,this.timeInterval=null,this.prevTime=null,this.currentRoom.current=null,a.winner?a.winner==this.client.getPlayer().userId?(console.log("game_manager;","win",a),a.result="win"):(console.log("game_manager;","lose",a),a.result="lose"):"not_save"==a.winner?console.log("game_manager","not accepted",a):(a.result="draw",console.log("game_manager;","draw",a)),this.emit("round_end",a,this.client.getPlayer())},c.prototype.onUserLeave=function(a){this.currentRoom.isClosed=!0,console.log("game_manager;","user_leave",this.currentRoom,a),a!=this.client.getPlayer()?this.emit("user_leave",a):this.leaveRoom()},c.prototype.onUserEvent=function(a,b){switch(b.type){case"draw":if(a==this.client.getPlayer())return;switch(b.action){case"ask":this.emit("ask_draw",a);break;case"cancel":this.emit("cancel_draw",a)}break;case"timeout":b.nextPlayer&&(b.nextPlayer=this.getPlayer(b.nextPlayer),b.user=this.getPlayer(b.user),this.emit("timeout",b),this.currentRoom.current=b.nextPlayer,this.emit("switch_player",this.currentRoom.current))}},c.prototype.leaveGame=function(){this.client.send("game_manager","leave","server",!0)},c.prototype.leaveRoom=function(){if(!this.currentRoom.isClosed)throw new Error("leave not closed room! "+this.currentRoom.id);console.log("game_manager;","emit game_leave;",this.currentRoom),this.emit("game_leave",this.currentRoom),this.currentRoom=null},c.prototype.sendReady=function(){this.client.send("game_manager","ready","server",!0)},c.prototype.sendTurn=function(a){return this.currentRoom.userTime<1e3?void console.warn("game_manager;","your time is out!"):void this.client.send("game_manager","turn","server",a)},c.prototype.sendThrow=function(){this.client.send("game_manager","event","server",{type:"throw"})},c.prototype.sendDraw=function(){this.client.send("game_manager","event","server",{type:"draw",action:"ask"})},c.prototype.acceptDraw=function(){this.client.send("game_manager","event","server",{type:"draw",action:"accept"})},c.prototype.cancelDraw=function(){this.client.send("game_manager","event","server",{type:"draw",action:"cancel"})},c.prototype.getPlayer=function(a){if(this.currentRoom)for(var b=0;b<this.currentRoom.players.length;b++)if(this.currentRoom.players[b].userId==a)return this.currentRoom.players[b];return null},c.prototype.onTimeTick=function(){var a=Date.now();if(!this.prevTime)return void(this.prevTime=a);var b=a-this.prevTime;b>333&&(this.currentRoom.userTime-=b,this.currentRoom.userTime<0&&(this.currentRoom.userTime=0),this.emitTime(),this.prevTime=a)},c.prototype.emitTime=function(){var a=Math.floor(this.currentRoom.userTime/6e4),b=Math.floor((this.currentRoom.userTime-6e4*a)/1e3);10>a&&(a="0"+a),10>b&&(b="0"+b),this.emit("time",{user:this.currentRoom.current,userTimeMS:this.currentRoom.userTime,userTimeS:Math.floor(this.currentRoom.userTime/1e3),userTimeFormat:a+":"+b})},c}),define("modules/invite_manager",["EE"],function(a){var b=function(a){var b=this;this.client=a,this.invites={},this.invite=null,a.userList.on("leave_user",function(a){b.invite&&b.invite.target==a.userId&&(b.invite=null),b.removeInvite(a.userId)}),a.gameManager.on("game_start",function(){b.invite=null,b.rejectAll()}),a.on("disconnected",function(){b.invite=null;for(var a in b.invites)b.invites.hasOwnProperty(a)&&b.removeInvite(a)})};return b.prototype=new a,b.prototype.onMessage=function(a){switch(console.log("invite_manager;","message",a),a.type){case"invite":this.onInvite(a.data);break;case"reject":this.onReject(a.data.target,a.data.from,"rejected");break;case"cancel":this.onCancel(a.data)}},b.prototype.onInvite=function(a){this.invites[a.from]=a,this.emit("new_invite",{from:this.client.getUser(a.from),data:a})},b.prototype.onReject=function(a,b,c){this.invite.target==a&&this.client.getPlayer().userId==b?(this.emit("reject_invite",{user:this.client.userList.getUser(a),reason:c}),this.invite=null):console.warn("invite_manager; ","wrong user reject invite",a,b)},b.prototype.onCancel=function(a){this.invites[a.from]&&(this.emit("cancel_invite",this.invites[a.from]),this.removeInvite(a.from))},b.prototype.sendInvite=function(a,b){return a?(this.invite&&this.cancel(),b=b||{},b.mode?void console.error("invite param mode is reserved!"):(b.mode=client.currentMode,b.target=a,this.invite=b,void this.client.send("invite_manager","invite",a,this.invite))):void console.warn("invite_manager; ","wrong userId to send invite",a)},b.prototype.accept=function(a){if(this.invites[a]){var b=this.invites[a];delete this.invites[a],this.cancel(),this.rejectAll(),this.client.send("invite_manager","accept",a,b)}},b.prototype.reject=function(a){this.invites[a]&&(this.client.send("invite_manager","reject",a,this.invites[a]),this.removeInvite(a))},b.prototype.rejectAll=function(){for(var a in this.invites)this.invites.hasOwnProperty(a)&&(this.client.send("invite_manager","reject",a,this.invites[a]),this.removeInvite(a))},b.prototype.cancel=function(){this.invite&&(this.client.send("invite_manager","cancel",this.invite.target,this.invite),this.invite=null)},b.prototype.removeInvite=function(a){console.log("invite_manger;","removeInvite",a),this.invites[a]&&(this.emit("remove_invite",this.invites[a]),delete this.invites[a])},b}),define("modules/user_list",["EE"],function(a){function b(a,b,c){if(!a||!a.userId||!a.userName)throw new Error("wrong user data!");for(var d in a)a.hasOwnProperty(d)&&(this[d]=a[d]);this.isPlayer=b||!1,this.getRank=function(a){return this[a||this._client.currentMode].rank||"—"},this._client=c}var c=function(a){var b=this;this.client=a,this.users=[],this.rooms=[],a.on("login",function(a){b.onUserLogin(a,!0)}),a.on("disconnected",function(){b.rooms=[],b.users=[]}),a.gameManager.on("round_end",function(a){if(a.ratings&&a.mode){for(var c in a.ratings)for(var d=0;d<b.users.length;d++)b.users[d].userId==c&&(b.users[d][a.mode]=a.ratings[c]);this.emit("update",a)}})};return c.prototype=new a,c.prototype.onMessage=function(a){switch(a.type){case"user_login":this.onUserLogin(a.data)}},c.prototype.onUserLogin=function(a,c){var d=new b(a,c,this.client);c&&(this.player=d);for(var e=0;e<this.users.length;e++)if(this.users[e].userId==d.userId)return console.warn("user_list;","user already in list!",d),!1;this.users.push(d),this.emit("new_user",d)},c.prototype.onUserLeave=function(a){for(var b=0;b<this.users.length;b++)if(this.users[b].userId==a){var c=this.users[b];return this.users.splice(b,1),void this.emit("leave_user",c)}console.warn("user_list;","no user in list",a)},c.prototype.onGameStart=function(a,b){for(var c=0;c<b.length;c++)b[c]=this.getUser(b[c]),b[c].isInRoom=!0;var d={room:a,players:b};this.rooms.push(d),this.emit("new_room",d)},c.prototype.onGameEnd=function(a,b){for(var c=0;c<this.rooms.length;c++)if(this.rooms[c].room==a){var d=this.rooms[c];this.rooms.splice(c,1);for(var e=0;e<d.players.length;e++)d.players[e].isInRoom=!1;return void this.emit("close_room",d)}console.warn("user_list;","no room in list",a,b)},c.prototype.getUser=function(a){for(var b=0;b<this.users.length;b++)if(this.users[b].userId==a)return this.users[b];return null},c.prototype.getUsers=function(){var a=this.client.inviteManager.invite;return a?_.map(this.users,function(b){return b.userId===a.target&&(b.isInvited=!0),b}):this.users},c.prototype.getUserList=function(){for(var a,b=[],c=this.client.inviteManager.invite,d=0;d<this.users.length;d++)a=this.users[d],c&&a.userId==c.target?a.isInvited=!0:delete a.isInvited,a.isInRoom||b.push(a);return b},c.prototype.getRoomList=function(){return this.rooms},c}),define("modules/socket",["EE"],function(a){var b=function(a){a=a||{},this.port=a.port||"8080",this.domain=a.domain||document.domain,this.game=a.game||"test",this.url=a.url||this.game,this.https=a.https||!1,this.protocol=this.https?"wss":"ws",this.isConnecting=!0,this.isConnected=!1};return b.prototype=new a,b.prototype.init=function(){var a=this;a.isConnecting=!0,a.isConnected=!1;try{this.ws=new WebSocket(this.protocol+"://"+this.domain+":"+this.port+"/"+this.url),this.ws.onclose=function(b,c){console.log("socket;","ws closed",b,c),a.isConnected&&a.onDisconnect()},this.ws.onerror=function(b){a.onError(b)},this.ws.onmessage=function(b,c){if("ping"==b.data)return void a.ws.send("pong");console.log("socket;","ws message",b,c);try{b=JSON.parse(b.data)}catch(d){return void console.log("socket;","ws wrong data in message",d)}a.onMessage(b)},this.ws.onopen=function(){console.log("socket;",new Date,"ws open"),a.onConnect()}}catch(b){console.log("socket;","ws open error"),this.onError(b)}},b.prototype.onError=function(a){console.log("socket;","ws error",a),this.isConnecting&&(this.isConnecting=!1,console.log("socket;","ws connection failed!"),this.onConnectionFailed())},b.prototype.onConnect=function(){this.isConnected=!0,this.emit("connection")},b.prototype.onDisconnect=function(){this.isConnected=!1,this.emit("disconnection")},b.prototype.onMessage=function(a){this.emit("message",a)},b.prototype.onConnectionFailed=function(){this.isConnecting=!1,this.isConnected=!1,this.emit("failed")},b.prototype.send=function(a){try{a=JSON.stringify(a)}catch(b){return void console.warn("socket;","json stringify err",a,b)}this.ws.send(a)},b}),define("text!tpls/userListFree.ejs",[],function(){return'<% _.each(users, function(user) { %>\r\n<tr>\r\n    <td class="userName" data-userId="<%= user.userId %>"><%= user.userName %></td>\r\n    <td class="userRank"><%= user.getRank() %></td>\r\n    <% if (user.isPlayer) { %>\r\n    <td></td>\r\n    <% } else if (user.isInvited) { %>\r\n    <td class="inviteBtn activeInviteBtn" data-userId="<%= user.userId %>">Отмена</td>\r\n    <% } else { %>\r\n    <td class="inviteBtn" data-userId="<%= user.userId %>">Пригласить</td>\r\n    <% } %>\r\n\r\n</tr>\r\n\r\n<% }) %>'}),define("text!tpls/userListInGame.ejs",[],function(){return'<% _.each(rooms, function(room) { %>\r\n<tr>\r\n    <td class="userName"><%= room.players[0].userName %></td>\r\n    <td class="userName"><%= room.players[1].userName %></td>\r\n</tr>\r\n<% }) %>'}),define("text!tpls/userListMain.ejs",[],function(){return'<div class="tabs">\r\n    <div data-type="free">Свободны <span></span></div>\r\n    <div data-type="inGame">Играют <span></span></div>\r\n</div>\r\n<div id="userListSearch">\r\n    <label for="userListSearch">Поиск по списку:</label><input type="text" id="userListSearch"/>\r\n</div>\r\n<div class="tableWrap">\r\n    <table class="playerList"></table>\r\n</div>\r\n\r\n<div class="btn">\r\n    <span>Играть с любым</span>\r\n</div>'}),define("views/user_list",["underscore","backbone","text!tpls/userListFree.ejs","text!tpls/userListInGame.ejs","text!tpls/userListMain.ejs"],function(a,b,c,d,e){var f=b.View.extend({tagName:"div",id:"userList",tplFree:a.template(c),tplInGame:a.template(d),tplMain:a.template(e),events:{"click .inviteBtn":"invitePlayer","click .userName":"userClick","click .tabs div":"clickTab","click .disconnectButton":"_reconnect"},_reconnect:function(){return this.client.opts.reload?void location.reload(!1):(this.$list.html(this.$loadingTab),void this.client.socket.init())},clickTab:function(a){if(this.client.socket.isConnected){var b=$(a.currentTarget),c=b.attr("data-type");c!==this.currentActiveTabName&&(this.currentActiveTabName=c,this._setActiveTab(this.currentActiveTabName),this.render())}},userClick:function(a){var b=$(a.currentTarget),c=b.attr("data-userId");this.client.onShowProfile(c)},invitePlayer:function(a){if(this.client.gameManager.currentRoom)return void console.log("you already in game!");var b=$(a.currentTarget),c=b.attr("data-userId");b.hasClass(this.ACTIVE_INVITE_CLASS)?(this.client.inviteManager.cancel(),b.removeClass(this.ACTIVE_INVITE_CLASS),b.html("Пригласить")):(this.$el.find("."+this.ACTIVE_INVITE_CLASS).html("Пригласить").removeClass(this.ACTIVE_INVITE_CLASS),this.client.inviteManager.sendInvite(c,"function"==typeof this.client.opts.getUserParams?this.client.opts.getUserParams():{}),b.addClass(this.ACTIVE_INVITE_CLASS),b.html("Отмена")),console.log("invite user",c)},initialize:function(a){var b=this.render.bind(this);this.client=a,this.$disconnectedTab=$('<tr class="disconnected"><td><div><span class="disconnectText">Соединение с сервером отсутствует</span><br><br><span class="disconnectButton">Переподключиться</span></div></td></tr>'),this.$loadingTab=$("<tr><td>Загрузка..</td></tr>"),this.$el.html(this.tplMain()),a.opts.blocks.userListId?$("#"+a.opts.blocks.userListId).append(this.el):$("body").append(this.el),this.ACTIVE_INVITE_CLASS="activeInviteBtn",this.ACTIVE_TAB_CLASS="activeTab",this.$list=this.$el.find(".tableWrap table"),this.$counterFree=this.$el.find('.tabs div[data-type="free"]').find("span"),this.$counterinGame=this.$el.find('.tabs div[data-type="inGame"]').find("span"),this.listenTo(this.client.userList,"new_user",b),this.listenTo(this.client,"mode_switch",b),this.listenTo(this.client.userList,"update",b),this.listenTo(this.client.userList,"leave_user",b),this.listenTo(this.client.inviteManager,"reject_invite",this.onRejectInvite.bind(this)),this.listenTo(this.client.userList,"new_room",b),this.listenTo(this.client.userList,"close_room",b),this.listenTo(this.client,"disconnected",b),this.currentActiveTabName="free",this._setActiveTab(this.currentActiveTabName),this.$list.html(this.$loadingTab)},_setActiveTab:function(a){this.$el.find(".tabs div").removeClass(this.ACTIVE_TAB_CLASS),this.$el.find('.tabs div[data-type="'+a+'"]').addClass(this.ACTIVE_TAB_CLASS)},_setCounters:function(){return this.client.socket.isConnected?(this.$counterFree.html("("+this.client.userList.getUserList().length+")"),void this.$counterinGame.html("("+2*this.client.userList.getRoomList().length+")")):(this.$counterFree.html(""),void this.$counterinGame.html(""))},_showPlayerListByTabName:function(){return this.client.socket.isConnected?void("free"===this.currentActiveTabName?this.$list.html(this.tplFree({users:this.client.userList.getUserList()})):"inGame"===this.currentActiveTabName?this.$list.html(this.tplInGame({rooms:this.client.userList.getRoomList()})):console.warn("unknown tab",this.currentActiveTabName)):void this.$list.html(this.$disconnectedTab)},onRejectInvite:function(a){this.$el.find("."+this.ACTIVE_INVITE_CLASS+'[data-userId="'+a.user.userId+'"]').html("Пригласить").removeClass(this.ACTIVE_INVITE_CLASS)},render:function(){return this._showPlayerListByTabName(),this._setCounters(),this}});return f}),define("views/dialogs",[],function(){var a=function(){function a(a){l=a,l.inviteManager.on("new_invite",b),l.inviteManager.on("reject_invite",c),l.inviteManager.on("cancel_invite",d),l.inviteManager.on("remove_invite",e),l.gameManager.on("user_leave",f),l.gameManager.on("game_start",k),l.gameManager.on("round_end",i),l.gameManager.on("game_leave",k),l.gameManager.on("ask_draw",g),l.gameManager.on("cancel_draw",h),l.on("login_error",j)}function b(a){var b=$("<div>");b.addClass(o),b.attr("data-userId",a.from.userId);var c="Вас пригласил в игру пользователь "+a.from.userName;"function"==typeof this.client.opts.generateInviteText&&(c=this.client.opts.generateInviteText(a)),b.html(c).dialog({resizable:!0,draggable:!1,modal:!1,buttons:{"Принять":function(){l.inviteManager.accept($(this).attr("data-userId")),$(this).remove()},"Отклонить":function(){l.inviteManager.reject($(this).attr("data-userId")),$(this).remove()}},close:function(){l.inviteManager.reject($(this).attr("data-userId")),$(this).remove()}}).parent().draggable()}function c(a){var b=$("<div>");b.addClass(o),b.addClass(n),b.html("Пользователь "+a.user.userName+" отклонил ваше приглашение").dialog({resizable:!1,modal:!1,buttons:{"Ок":function(){$(this).remove()}}})}function d(a){console.log("cancel invite",a)}function e(a){var b=a.from;console.log("remove invite",b),$("."+o+'[data-userId="'+b+'"]').remove()}function f(a){k();var b=$("<div>");b.addClass(o),b.addClass(n),b.html("Пользователь "+a.userName+" покинул игру").dialog({resizable:!1,modal:!1,buttons:{"Ок":function(){$(this).remove(),l.gameManager.leaveRoom()}}})}function g(a){console.log("ask draw",a);var b=$("<div>");b.addClass(n),b.html("Пользователь "+a.userName+" предлагает ничью").dialog({resizable:!1,modal:!1,buttons:{"Принять":function(){l.gameManager.acceptDraw(),$(this).remove()},"Отклонить":function(){l.gameManager.cancelDraw(),$(this).remove()}}}).parent().draggable()}function h(a){console.log("cancel draw",a);var b=$("<div>");b.addClass(n),b.html("Пользователь "+a.userName+" отклонил ваше предложение о ничье").dialog({resizable:!1,modal:!1,buttons:{"Ок":function(){$(this).remove()}}})}function i(a){k();var b=$("<div>");b.addClass(p);var c="";switch(a.result){case"win":c="Победа";break;case"lose":c="Поражение";break;case"draw":c="Ничья";break;default:c="игра окночена"}m=setTimeout(function(){b.html(c+"<br><br> Сыграть с соперником еще раз?").dialog({resizable:!1,modal:!1,width:350,buttons:{"Да, начать новую игру":function(){$(this).remove(),l.gameManager.sendReady()},"Нет, выйти":function(){$(this).remove(),l.gameManager.leaveGame()}}})},l.opts.resultDialogDelay)}function j(){var a=$("<div>");a.addClass(n),a.html("Ошибка авторизации. Обновите страницу").dialog({resizable:!1,modal:!1,buttons:{"Ок":function(){$(this).remove()}}})}function k(){$("."+n).remove(),$("."+p).remove(),clearTimeout(m)}var l,m,n="dialogNotification",o="dialogInvite",p="dialogRoundResult";return{init:a}}();return a}),define("text!tpls/v6-chatMain.ejs",[],function(){return'<div class="tabs">\r\n    <div class="tab" data-type="public">Общий чат</div>\r\n    <div class="tab" data-type="private" style="display: none;">игрок</div>\r\n</div>\r\n<div class="clear"></div>\r\n<div class="messagesWrap"><ul></ul></div>\r\n<div class="inputMsg" contenteditable="true"></div>\r\n<div class="layer1">\r\n    <div class="sendMsgBtn">Отправить</div>\r\n    <select id="chat-select">\r\n        <option selected>Готовые сообщения</option>\r\n        <option>Привет!</option>\r\n        <option>Молодец!</option>\r\n        <option>Здесь кто-нибудь умеет играть?</option>\r\n        <option>Кто со мной?</option>\r\n        <option>Спасибо!</option>\r\n        <option>Спасибо! Интересная игра!</option>\r\n        <option>Спасибо, больше играть не могу. Ухожу!</option>\r\n        <option>Спасибо, интересная игра! Сдаюсь!</option>\r\n        <option>Отличная партия. Спасибо!</option>\r\n        <option>Ты мог выиграть</option>\r\n        <option>Ты могла выиграть</option>\r\n        <option>Ходи!</option>\r\n        <option>Дай ссылку на твою страницу вконтакте</option>\r\n        <option>Снимаю шляпу!</option>\r\n        <option>Красиво!</option>\r\n        <option>Я восхищен!</option>\r\n        <option>Где вы так научились играть?</option>\r\n        <option>Еще увидимся!</option>\r\n        <option>Ухожу после этой партии. Спасибо!</option>\r\n        <option>Минуточку</option>\r\n    </select>\r\n</div>\r\n<div class="layer2">\r\n    <span class="chatAdmin">\r\n        <input type="checkbox" id="chatIsAdmin"/><label for="chatIsAdmin">От админа</label>\r\n    </span>\r\n\r\n    <span class="chatRules">Правила чата</span>\r\n</div>\r\n\r\n<ul class="menuElement noselect">\r\n    <li data-action="invite"><span>Пригласить в игру</span></li>\r\n    <li data-action="showProfile"><span>Показать профиль</span></li>\r\n    <li data-action="ban"><span>Забанить в чате</span></li>\r\n</ul>'}),define("text!tpls/v6-chatMsg.ejs",[],function(){return'<li class="chatMsg" data-msgId="<%= msg.time %>">\r\n    <div class="msgRow1">\r\n        <div class="smallRight time"><%= msg.t %></div>\r\n        <div class="smallRight rate"><%= (msg.rank || \'—\') %></div>\r\n\r\n        <div data-userId="<%= msg.userId%>">\r\n            <span class="userName"><%= msg.userName %></span>\r\n        </div>\r\n    </div>\r\n    <div class="msgRow2">\r\n        <div class="delete" title="Удалить сообщение"></div>\r\n        <div class="msgTextWrap">\r\n            <span class="v6-msgText"><%= _.escape(msg.text) %></span>\r\n        </div>\r\n    </div>\r\n</li>'}),define("text!tpls/v6-chatDay.ejs",[],function(){return'<li class="chatDay" data-day-msgId="<%= time %>">\r\n    <div>\r\n        <%= d %>\r\n    </div>\r\n</li>'}),define("text!tpls/v6-chatRules.ejs",[],function(){return'<div id="chat-rules" class="aboutPanel">\r\n    <img class="closeIcon" src="i/close.png">\r\n\r\n    <div style="padding: 10px 12px 15px 25px;">\r\n        <h2>Правила чата</h2>\r\n        <p style="line-height: 16px;">В чате запрещено:<br>\r\n            <span style="margin-left:5px;">1. использование ненормативной лексики и оскорбительных выражений</span><br>\r\n            <span style="margin-left:5px;">2. хамское и некорректное общение с другими участниками</span><br>\r\n            <span style="margin-left:5px;">3. многократная публикация бессмысленных, несодержательных или одинаковых сообщений.</span>\r\n        </p>\r\n\r\n        <p style="line-height: 16px;"><span style="margin-left:5px;">Баны</span> выносятся: на 1 день, на 3 дня, на 7 дней,на\r\n            месяц или навсегда, в зависимости от степени тяжести нарушения.\r\n        </p>\r\n\r\n        <p style="line-height: 16px;"><span style="margin-left:5px;">Бан</span> снимается автоматически по истечении срока.\r\n        </p>\r\n\r\n    </div>\r\n</div>'}),define("views/chat",["underscore","backbone","text!tpls/v6-chatMain.ejs","text!tpls/v6-chatMsg.ejs","text!tpls/v6-chatDay.ejs","text!tpls/v6-chatRules.ejs"],function(a,b,c,d,e,f){var g=b.View.extend({tagName:"div",id:"v6Chat",tplMain:a.template(c),tplMsg:a.template(d),tplDay:a.template(e),tplRules:a.template(f),events:{"click .chatMsg":"_deleteMsg","click .tab":"clickTab","blur .inputMsg":"blurInputMsg","click .inputMsg":"clickInputMsg","click .sendMsgBtn":"sendMsgEvent","keyup .inputMsg":"sendMsgEvent","change #chat-select":"changeChatSelect","click .chatMsg div[data-userid]":"showMenu","click li[data-action]":"clickDialogAction","click .chatRules":"showChatRules"},showChatRules:function(){this.$rules.css({top:$(window).height()/2-this.$rules.outerHeight()/2,left:$(window).width()/2-this.$rules.outerWidth()/2}).show()},clickDialogAction:function(a){var b={action:$(a.currentTarget).attr("data-action"),userId:this.$menu.attr("data-userId")};console.log("chat dialog menu:",b)},showMenu:function(a){var b=a.target.getBoundingClientRect(),c=20;setTimeout(function(){this.$menu.attr("data-userId",$(a.target).parent().attr("data-userid")),this.$menu.css({left:c,top:b.top-document.getElementById("v6Chat").getBoundingClientRect().top+c}).slideDown()}.bind(this),0)},hideMenuElement:function(){this.$menu.removeAttr("data-userId"),this.$menu.hide()},changeChatSelect:function(a){var b=a.target.options[a.target.selectedIndex].innerHTML;this.$SELECTED_OPTION.attr("selected",!0),this.$inputMsg.text(b)},sendMsgEvent:function(a){("keyup"!==a.type||13===a.keyCode)&&(this.$inputMsg.has(this.$placeHolderSpan).length||this._sendMsg(this.$inputMsg.text()))},scrollEvent:function(){this.$messagesWrap.scrollTop()<5&&!this.client.chatManager.fullLoaded[this.client.chatManager.current]&&(this._setLoadingState(),this.client.chatManager.loadMessages())},_sendMsg:function(a){if(""!==a&&"string"==typeof a){if(a.length>this.MAX_MSG_LENGTH)return void alert(this.MAX_LENGTH_MSG);this.client.chatManager.sendMessage(a,null,$("#chatIsAdmin")[0].checked),this.$inputMsg.empty(),this.$inputMsg.focus()}},blurInputMsg:function(a){var b=$(a.currentTarget);""===b.text()&&b.empty().append(this.$placeHolderSpan)},clickInputMsg:function(a){var b=$(a.currentTarget);b.has(this.$placeHolderSpan).length&&b.empty()},clickTab:function(a){var b=$(a.target),c=b.attr("data-type");c!==this.currentActiveTabName&&(this.currentActiveTabName=c,this._setActiveTab(this.currentActiveTabName),this.client.chatManager.loadCachedMessages(this.tabs[c].target))},initialize:function(a){this.client=a,this.$el.html(this.tplMain()),this.MAX_MSG_LENGTH=128,this.SCROLL_VAL=40,this.MAX_LENGTH_MSG="Сообщение слишком длинное (максимальная длина - 128 символов). Сократите его попробуйте снова",this.CLASS_DISABLED="disabled",this.CLASS_CHATADMIN="chatAdmin",this.CLASS_DELETE_CHAT_MESSAGE="delete",this.CLASS_NEW_MSG="newMsg",this.CLASS_ADMIN_MSG="isAdmin",this.ACTIVE_TAB_CLASS="activeTab",this.CLASS_MENU_ELEMENT="menuElement",this.$menu=this.$el.find("."+this.CLASS_MENU_ELEMENT),this.client.isAdmin||this.$menu.find('li[data-action="ban"]').remove(),window.document.body.addEventListener("click",this.hideMenuElement.bind(this)),this.$rules=$(this.tplRules()),window.document.body.appendChild(this.$rules[0]),this.$rules.find("img.closeIcon").on("click",function(){this.$rules.hide()}.bind(this)),this.$placeHolderSpan=$('<span class="placeHolderSpan">Введите ваше сообщение..</span>'),this.$spinnerWrap=$('<li class="spinnerWrap"><div class="spinner"></div></li>'),this.$messagesWrap=this.$el.find(".messagesWrap"),this.$msgsList=this.$messagesWrap.find("ul"),this.$inputMsg=this.$el.find(".inputMsg"),this.$SELECTED_OPTION=this.$el.find("select option:selected"),this.currentActiveTabName="public",this.currentActiveTabTitle=a.game,this.tabs={"public":{target:a.game,title:"Общий чат"},"private":null},this._setActiveTab(this.currentActiveTabName),a.opts.blocks.chatId?$("#"+a.opts.blocks.chatId).append(this.el):$("body").append(this.el),this.$inputMsg.empty().append(this.$placeHolderSpan),this._setLoadingState(),this.client.isAdmin&&this.$el.find("."+this.CLASS_CHATADMIN).removeClass(this.CLASS_CHATADMIN),this.listenTo(this.client.chatManager,"message",this._addOneMsg.bind(this)),this.listenTo(this.client.chatManager,"load",this._preaddMsgs.bind(this)),this.listenTo(this.client.chatManager,"open_dialog",this._openDialog.bind(this)),this.listenTo(this.client.chatManager,"close_dialog",this._closeDialog.bind(this)),this.$messagesWrap.scroll(this.scrollEvent.bind(this))},_setActiveTab:function(a){var b=this.$el.find('.tabs div[data-type="'+a+'"]');this.$el.find(".tabs div").removeClass(this.ACTIVE_TAB_CLASS),b.addClass(this.ACTIVE_TAB_CLASS),b.html(this.tabs[a].title),b.show(),this.$msgsList.html(""),this._setLoadingState(),this.currentActiveTabTitle=this.tabs[a].target},render:function(){return this},_openDialog:function(a){a.userId&&(this.tabs["private"]={target:a.userId,title:a.userName}),this.currentActiveTabName="private",this._setActiveTab("private")},_closeDialog:function(){this.currentActiveTabName="public",this._setActiveTab("public"),this.$el.find('.tabs div[data-type="private"]').hide()},_deleteMsg:function(a){var b,c;if(isNaN(+a)||"number"!=typeof+a){if(!$(a.target).hasClass(this.CLASS_DELETE_CHAT_MESSAGE))return;b=$(a.currentTarget),c=b.attr("data-msgId")}else c=a;return b||(b=this.$el.find('li[data-msgId="'+c+'"]').remove()),b?void b.remove():void console.warn("cannot find msg with  id",c,a)},_addOneMsg:function(a){if(console.log("chat message",a),a.target==this.currentActiveTabTitle){var b=this.tplMsg({msg:a}),c=this.$messagesWrap[0].scrollHeight-this.$messagesWrap.height()-this.$messagesWrap.scrollTop()<this.SCROLL_VAL;this.client.chatManager.last[a.target]&&this.client.chatManager.last[a.target].d==a.d||this.$msgsList.append(this.tplDay(a)),this.$msgsList.append(b),b=this.$el.find('li[data-msgId="'+a.time+'"]'),a.admin&&b.addClass(this.CLASS_ADMIN_MSG),b.addClass(this.CLASS_NEW_MSG),setTimeout(function(){this.$el.find('li[data-msgId="'+a.time+'"]').removeClass(this.CLASS_NEW_MSG)}.bind(this),2500),c&&this.$messagesWrap.scrollTop(this.$messagesWrap[0].scrollHeight)}},_preaddMsgs:function(a){if(console.log("pre chat message",a),(!a||a.target==this.currentActiveTabTitle)&&(this._removeLoadingState(),a)){var b=this.$messagesWrap.scrollTop(),c=this.$messagesWrap[0].scrollHeight,d=this.$el.find('li[data-day-msgId="'+this.client.chatManager.first[a.target].time+'"]');d&&d.remove(),this.client.chatManager.first[a.target].d!=a.d&&this.$msgsList.prepend(this.tplDay(this.client.chatManager.first[a.target]));var e=this.tplMsg({msg:a});this.$msgsList.prepend(e),this.$msgsList.prepend(this.tplDay(a)),e=this.$el.find('li[data-msgId="'+a.time+'"]'),a.admin&&e.addClass(this.CLASS_ADMIN_MSG),this.$messagesWrap.scrollTop(b+this.$messagesWrap[0].scrollHeight-c)}},_setLoadingState:function(){this.$msgsList.prepend(this.$spinnerWrap),this.$messagesWrap.addClass(this.CLASS_DISABLED)},_removeLoadingState:function(){this.$spinnerWrap.remove(),this.$messagesWrap.removeClass(this.CLASS_DISABLED)}});return g}),define("modules/views_manager",["views/user_list","views/dialogs","views/chat"],function(a,b,c){var d=function(a){this.client=a,this.userListView=null,this.dialogsView=b,this.chat=null};return d.prototype.init=function(){this.userListView=new a(this.client),this.dialogsView.init(this.client),this.v6ChatView=new c(this.client)},d}),define("modules/chat_manager",["EE"],function(a){var b=function(a){this.client=a,this.first={},this.last={},this.fullLoaded={},this.messages={},this.current=a.game,this.MSG_COUNT=10,a.on("login",this.loadMessages.bind(this)),a.gameManager.on("game_start",function(a){for(var b=0;b<a.players.length;b++)a.players[b].isPlayer||this.openDialog(a.players[b].userId,a.players[b].userName)}.bind(this)),a.gameManager.on("game_leave",function(a){for(var b=0;b<a.players.length;b++)a.players[b].isPlayer||this.closeDialog(a.players[b].userId)}.bind(this))};return b.prototype=new a,b.initMessage=function(a,c){for(var d in a.userData)a.rank=a.userData[d].rank,(!a.rank||a.rank<1)&&(a.rank="—");a.target==c.userId&&(a.target=a.userId),a.admin&&(a.rank="",a.userId=0,a.userName="Админ"),a.date=new Date(a.time);var e=a.date.getHours(),f=a.date.getMinutes();return 10>e&&(e="0"+e),10>f&&(f="0"+f),a.t=e+":"+f,a.d=a.date.getDate()+" "+b.months[a.date.getMonth()]+" "+a.date.getFullYear(),a
},b.months=["Января","Февраля","Марта","Апреля","Мая","Июня","Июля","Сентября","Октября","Ноября","Декабря"],b.prototype.onMessage=function(a){var c,d,e=a.data,f=this.client.getPlayer();switch(console.log("chat_manager;","message",a),a.type){case"message":a=b.initMessage(e,f),this.first[a.target]||(this.first[a.target]=a),this.messages[a.target]||(this.messages[a.target]=[]),d=this.messages[a.target],d.push(a),d.length>100&&d.shift(),this.emit("message",a),this.last[a.target]=a,a.target!=this.client.game&&a.target!=this.current&&this.openDialog(a.userId,a.userName);break;case"load":if(!e.length||e.length<1)return this.fullLoaded[this.current]=!0,void this.emit("load",null);for(a=b.initMessage(e[0],f),this.messages[a.target]||(this.messages[a.target]=[]),d=this.messages[a.target],c=e.length-1;c>=0;c--)this.onMessageLoad(b.initMessage(e[c],f),d)}},b.prototype.sendMessage=function(a,b,c){var d={text:a};c&&(d.admin=!0),b||(d.target=this.current),this.client.send("chat_manager","message","server",d)},b.prototype.loadMessages=function(a,b,c){return this.fullLoaded[this.current]?(console.log("chat_manager;","all messages loaded!",a,b,this.first),void this.emit("load",null)):(a=a||this.MSG_COUNT,c||(c=this.current),b=b||(this.first[c]?this.first[c].time:null),console.log("chat_manager;","loading messages",a,b,this.first),void setTimeout(function(){this.client.send("chat_manager","load","server",{count:a,time:b,target:c})}.bind(this),500))},b.prototype.onMessageLoad=function(a,b){b&&b.length<100&&b.unshift(a),this.first[a.target]||(this.first[a.target]=a),this.last[a.target]||(this.last[a.target]=a),this.emit("load",a),this.first[a.target]=a},b.prototype.openDialog=function(a,b){this.current=a,this.emit("open_dialog",{userId:a,userName:b}),this.loadCachedMessages(a),this.messages[a]&&this.messages[a].length>0&&this.messages[a].length<this.MSG_COUNT?this.loadMessages(this.MSG_COUNT,this.messages[a][0],a):this.loadMessages(this.MSG_COUNT,null,a)},b.prototype.closeDialog=function(a){this.emit("close_dialog",a||this.current),this.loadCachedMessages(this.client.game)},b.prototype.loadCachedMessages=function(a){if(this.current=a,this.first[a]=this.last[a]=null,this.messages[a]&&this.messages[a].length>0)for(var b=this.messages[a].length-1;b>=0;b--)this.onMessageLoad(this.messages[a][b]);this.messages[a]&&this.messages[a].length>0&&this.messages[a].length<this.MSG_COUNT?this.loadMessages(this.MSG_COUNT,this.messages[a][0],a):this.loadMessages(this.MSG_COUNT,null,a)},b}),define("client",["modules/game_manager","modules/invite_manager","modules/user_list","modules/socket","modules/views_manager","modules/chat_manager","EE"],function(a,b,c,d,e,f,g){var h=function(g){g.resultDialogDelay=g.resultDialogDelay||0,g.modes=g.modes||g.gameModes||["default"],g.reload=g.reload||!1,g.turnTime=g.turnTime||60,g.blocks=g.blocks||{};try{this.isAdmin=g.isAdmin||LogicGame.isSuperUser()}catch(h){this.isAdmin=!1,console.error(h)}var i=this;this.opts=g,this.game=g.game||"test",this.gameManager=new a(this),this.userList=new c(this),this.inviteManager=new b(this),this.chatManager=new f(this),this.viewsManager=new e(this),this.currentMode=null,this.socket=new d(g),this.socket.on("connection",function(){console.log("client;","socket connected")}),this.socket.on("disconnection",function(){console.log("client;","socket disconnected"),i.emit("disconnected")}),this.socket.on("failed",function(){console.log("client;","socket connection failed"),i.emit("disconnected")}),this.socket.on("message",function(a){console.log("client;","socket message",a),i.onMessage(a)}),this.getUser=this.userList.getUser.bind(this.userList)};return h.prototype=new g,h.prototype.init=function(){return this.socket.init(),this.viewsManager.init(),this},h.prototype.onMessage=function(a){switch(a.module){case"server":this.onServerMessage(a);break;case"invite_manager":this.inviteManager.onMessage(a);break;case"game_manager":this.gameManager.onMessage(a);break;case"chat_manager":this.chatManager.onMessage(a)}},h.prototype.onServerMessage=function(a){var b=a.data;switch(a.type){case"login":this.onLogin(b.you,b.userlist,b.rooms,b.opts);break;case"user_login":this.userList.onUserLogin(b);break;case"user_leave":this.userList.onUserLeave(b);break;case"new_game":this.userList.onGameStart(b.room,b.players),this.gameManager.onMessage(a);break;case"end_game":this.userList.onGameEnd(b.room,b.players);break;case"error":this.onError(b)}},h.prototype.onLogin=function(a,b,c,d){console.log("client;","login",a,b,c,d),this.game=this.opts.game=d.game,this.turnTime=this.opts.turnTime=d.turnTime,this.modes=this.opts.modes=d.modes,this.currentMode=this.modes[0],this.isLogin=!0;var e;for(e=0;e<b.length;e++)this.userList.onUserLogin(b[e]);for(e=0;e<c.length;e++)this.userList.onGameStart(c[e].room,c[e].players);this.emit("login",a)},h.prototype.send=function(a,b,c,d){return client.socket.isConnected?("object"==typeof a&&a.module&&a.type&&a.data&&(b=a.type,d=a.data,c=a.target,a=a.module),a&&b&&d&&c?("server"!=c&&(this.userList.getUser(c)||console.warn("client;","send message to offline user!",c)),void this.socket.send({module:a,type:b,target:c,data:d})):void console.warn("client;","some arguments undefined!",a,b,c,d)):void console.error("Client can not send message, socket is not connected!")},h.prototype.setMode=function(a){if(!client.socket.isConnected||!client.isLogin)return void console.error("Client can set mode, socket is not connected!");if(!this.modes||this.modes.length<1)return void console.error("Client can set mode, no modes!");if(this.modes[a])return this.currentMode=this.modes[a],void this.emit("mode_switch",this.currentMode);for(var b=0;b<this.modes.length;b++)if(this.modes[b]==a)return this.currentMode=a,void this.emit("mode_switch",this.currentMode);console.error("wrong mode:",a,"client modes:",this.modes)},h.prototype.onError=function(a){console.error("client;","server error",a),"login_error"==a&&(this.emit("login_error"),this.socket.ws.close())},h.prototype.onShowProfile=function(a,b){if(!b){var c=this.userList.getUser(a);if(!c)return;b=c.userName}this.emit("show_profile",{userId:a,userName:b})},h.prototype.getPlayer=function(){return this.userList.player},h}),define("v6-game-client",["client"],function(a){return console.log("main;",new Date,"ready"),a});
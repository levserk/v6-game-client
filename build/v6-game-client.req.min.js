/*! v6-game-client 2015-08-05 18:19 */
define("instances/room",[],function(){var a=function(a,b){this.data=a,this.inviteData=a.data,this.id=a.room,this.owner=b.getUser(a.owner),this.players=[],this.spectators=[],this.isPlayer=!1,this.mode=a.mode,this.turnTime=a.turnTime||1e3*b.opts.turnTime,this.takeBacks=a.takeBacks,this.timeMode=a.timeMode||"reset_every_switch",this.timeStartMode=a.timeStartMode||"after_switch",this.history=[];var c;if("object"==typeof a.players[0])this.players=a.players;else for(c=0;c<a.players.length;c++)this.players.push(b.getUser(a.players[c]));if(a.spectators&&a.spectators.length)if("object"==typeof a.spectators[0])this.players=a.players;else for(c=0;c<a.spectators.length;c++)this.spectators.push(b.getUser(a.spectators[c]));for(this.score={games:0},c=0;c<this.players.length;c++)this.score[this.players[c].userId]=0,this.players[c]==b.getPlayer()&&(this.isPlayer=!0)};return a}),define("instances/turn",[],function(){var a=function(a,b,c){this.user=b,this.nextPlayer=c,this.turn=a,a.userTurnTime&&(this.userTurnTime=a.userTurnTime,delete a.userTurnTime),delete this.turn.nextPlayer};return a}),define("instances/game_event",[],function(){var a=function(a){this.event={};for(var b in a)if(a.hasOwnProperty(b))switch(b){case"user":this.user=a.user;break;case"nextPlayer":this.nextPlayer=a.nextPlayer;break;case"type":this.event.type=a.type;break;case"action":"timeout"==a.action&&(this.event.type=a.action);break;default:this.event[b]=a[b]}};return a}),define("modules/game_manager",["EE","instances/room","instances/turn","instances/game_event"],function(a,b,c,d){var e=function(a){this.client=a,this.currentRoom=null,this.enableGames=!0,this.wasPlaying=!1,this.leaveGameTimeout=null,this.LEAVE_GAME_TIME=1e3,a.on("relogin",function(){clearTimeout(this.leaveGameTimeout),this.wasPlaying&&(this.leaveGameTimeout=setTimeout(function(){console.log("game_manager;","auto leave not restarted game"),this.emit("game_leave",this.currentRoom),this.currentRoom=null}.bind(this),this.LEAVE_GAME_TIME))}.bind(this)),a.on("disconnected",function(){this.wasPlaying=this.isPlaying(),this.isSpectating()?this.emit("game_leave",this.currentRoom):this.inGame()&&!this.isPlaying()&&(this.emit("game_leave",this.currentRoom),this.currentRoom=null),clearTimeout(this.leaveGameTimeout),clearInterval(this.timeInterval),this.timeInterval=null,this.prevTime=null}.bind(this)),window.addEventListener("blur",function(){this.onUserFocusChanged(!1)}.bind(this)),window.addEventListener("focus",function(){this.onUserFocusChanged(!0)}.bind(this))};return e.prototype=new a,e.prototype.onMessage=function(a){var b,c,d,e=a.data,f=this.client.getPlayer();switch(console.log("game_manager;","message",a),a.type){case"new_game":for(b=0;b<e.players.length;b++)if(e.players[b]==f){if(this.currentRoom){if(!this.currentRoom.isClosed&&this.currentRoom.isPlayer)throw new Error("start game before current game finished! old: "+this.currentRoom.id+" new:"+e.room);this.leaveRoom()}this.onGameStart(e)}break;case"end_game":break;case"ready":console.log("game_manager;","user_ready",e);break;case"round_start":this.onRoundStart(e);break;case"turn":this.onTurn(e);break;case"event":c=this.getPlayer(e.user),console.log("game_manager;","game event",e,c),this.onUserEvent(c,e);break;case"user_leave":c=this.getPlayer(e),this.onUserLeave(c);break;case"round_end":this.onRoundEnd(e);break;case"game_restart":this.onGameRestart(e);break;case"spectate":this.onSpectateStart(e);break;case"spectator_join":console.log("game_manager;","spectator_join",e),c=this.client.getUser(e.user),d=this.currentRoom.spectators.indexOf(c),c&&0>d&&(this.currentRoom.spectators.push(c),this.emit("spectator_join",c));break;case"spectator_leave":if(console.log("game_manager;","spectator_leave",e),this.currentRoom&&this.currentRoom.id!=e.room)return void console.error("game_manager;","user leave wrong room, roomId:",e.room,"current room: ",this.currentRoom);e.user==this.client.getPlayer().userId&&this.currentRoom?(this.currentRoom.isClosed=!0,this.leaveRoom()):(c=this.getSpectator(e.user),d=this.currentRoom.spectators.indexOf(c),c&&d>=0&&(this.currentRoom.spectators.splice(d,1),this.emit("spectator_leave",c)));break;case"error":console.error("game_manager;","error",e),this.emit("error",e)}},e.prototype.onGameStart=function(a){clearTimeout(this.leaveGameTimeout),a=new b(a,this.client),console.log("game_manager;","emit game_start",a),this.currentRoom=a,this.emit("game_start",a),this.sendReady()},e.prototype.onRoundStart=function(a,b){console.log("game_manager;","emit round_start",a),this.currentRoom.current=this.getPlayer(a.first),this.currentRoom.userTime=this.currentRoom.turnTime,this.currentRoom.userTurnTime=0,this.currentRoom.turnStartTime=null,this.currentRoom.userTakeBacks=0,this.currentRoom.cancelsAscTakeBack=0,this.currentRoom.cancelsAscDraw=0,this.currentRoom.history=[],this.currentRoom.initData=a;var c=a.first==a.players[0]?[this.getPlayer(a.players[0]),this.getPlayer(a.players[1])]:[this.getPlayer(a.players[1]),this.getPlayer(a.players[0])];this.emit("round_start",{players:c,first:this.getPlayer(a.first),id:a.id,inviteData:a.inviteData,initData:a,score:this.currentRoom.score,isPlayer:this.currentRoom.isPlayer,loading:!!b}),"after_round_start"==this.currentRoom.timeStartMode&&this.switchPlayer(this.currentRoom.current,0,this.getTurnTime()),this.emitTime()},e.prototype.onGameRestart=function(a){clearTimeout(this.leaveGameTimeout),console.log("game_manager;","game restart",a);var c=new b(a.roomInfo,this.client);console.log("game_manager;","emit game_start",c),this.currentRoom=c,c.score=a.score||c.score;var d=Date.now();this.emit("game_start",c),this.onRoundStart(a.initData,!0),this.currentRoom.history=this.parseHistory(a.history,a.playerTurns),this.emit("game_load",this.currentRoom.history),this.currentRoom.userTakeBacks=a.usersTakeBacks?a.usersTakeBacks[this.client.getPlayer().userId]:0;{var e=this.getLastTurn();e?e.userTurnTime:0}this.switchPlayer(this.getPlayer(a.nextPlayer),a.userTime+(Date.now()-d),e?e.userTurnTime:0)},e.prototype.onSpectateStart=function(a){console.log("game_manager;","spectate start",a);var c=new b(a.roomInfo,this.client);c.spectators.length||c.spectators.push(this.client.getPlayer()),console.log("game_manager;","emit game_start",c),this.currentRoom=c,c.score=a.score||c.score;var d=Date.now();if(this.emit("game_start",c),"waiting"==a.state)return void console.log("game_manager","start spectate","waiting players ready to play");if(this.onRoundStart(a.initData,!0),this.currentRoom.history=this.parseHistory(a.history,a.playerTurns),this.emit("game_load",this.currentRoom.history),null!=a.userTime){var e=this.getLastTurn();this.switchPlayer(this.getPlayer(a.nextPlayer),a.userTime+(Date.now()-d),e?e.userTurnTime:0)}},e.prototype.onRoundEnd=function(a){console.log("game_manager;","emit round_end",a,this.currentRoom,this.getHistory()),clearInterval(this.timeInterval),this.timeInterval=null,this.prevTime=null,this.currentRoom.current=null,this.currentRoom.score=a.score,a.mode=this.currentRoom.data.mode,a.isPlayer=this.currentRoom.isPlayer,a.winner?a.winner==this.client.getPlayer().userId?(console.log("game_manager;","win",a),a.result="win"):(console.log("game_manager;","lose",a),a.result="lose"):"not_save"==a.winner?console.log("game_manager","not accepted",a):(a.result="draw",console.log("game_manager;","draw",a)),this.currentRoom.isPlayer||(a.result=null),this.emit("round_end",a)},e.prototype.onUserLeave=function(a){this.currentRoom.isClosed=!0,console.log("game_manager;","user_leave",this.currentRoom,a),a!=this.client.getPlayer()?this.emit("user_leave",a):this.leaveRoom()},e.prototype.onTurn=function(a){console.log("game_manager;","emit turn",a),this.client.opts.newGameFormat||this.currentRoom.history.push(a.turn);var b=a.turn.userTurnTime||0;a.turn.userTurnTime&&delete a.turn.userTurnTime,a.turn.nextPlayer?(a.nextPlayer=this.getPlayer(a.turn.nextPlayer),delete a.turn.nextPlayer):"reset_every_turn"==this.currentRoom.timeMode&&(console.log("game_manager;","reset user turn time",this.currentRoom.current,this.currentRoom.userTime,this.currentRoom.userTurnTime),this.currentRoom.userTime=b||this.currentRoom.turnTime),this.client.opts.newGameFormat&&(a=new c(a.turn,this.getPlayer(a.user),a.nextPlayer),this.currentRoom.history.push(a)),this.emit("turn",a);var d=a.nextPlayer;a.nextPlayer||this.timeInterval||"reset_every_turn"!=this.currentRoom.timeMode&&"after_turn"!=this.currentRoom.timeStartMode||(d=this.currentRoom.current),this.switchPlayer(d,0,b)},e.prototype.onUserEvent=function(a,b){switch(b.type){case"draw":if(a==this.client.getPlayer())return;switch(b.action){case"ask":this.emit("ask_draw",a);break;case"cancel":this.emit("cancel_draw",a),this.currentRoom.cancelsAscDraw++}break;case"timeout":if(b.nextPlayer){var c=this.getPlayer(b.nextPlayer);this.client.opts.newGameFormat?(b.user=this.getPlayer(b.user),b.nextPlayer=c,b=new d(b),this.currentRoom.history.push(b),this.emit("timeout",b)):(b.user=this.getPlayer(b.user),this.currentRoom.history.push({user:b.user.userId,action:"timeout",nextPlayer:b.nextPlayer}),this.emit("timeout",b)),this.switchPlayer(c)}break;case"back":switch(b.action){case"take":a==this.client.getPlayer()&&this.currentRoom.userTakeBacks++,this.switchPlayer(a),this.currentRoom.history=this.parseHistory(b.history),this.emit("take_back",{user:a,history:this.currentRoom.history});break;case"ask":a!=this.client.getPlayer()&&this.emit("ask_back",a);break;case"cancel":this.emit("cancel_back",a),this.currentRoom.cancelsAscTakeBack++}break;case"focus":this.emit("focus",{user:a,windowHasFocus:"has"==b.action});break;default:console.log("game_manager;","onUserEvent user:",a,"event:",b),this.client.opts.newGameFormat&&(b.user=this.getPlayer(b.user)||void 0,b.nextPlayer=this.getPlayer(b.nextPlayer)||void 0,b.target=this.getPlayer(b.target)||void 0,b=new d(b)),this.currentRoom.history.push(b),this.emit("event",b)}},e.prototype.onUserFocusChanged=function(a){this.client.isFocused=a,this.isPlaying()&&this.client.send("game_manager","event","server",{type:"focus",action:a?"has":"lost"})},e.prototype.switchPlayer=function(a,b,c){return console.log("switch player;",a,b,c),this.currentRoom?void(a&&(this.currentRoom.userTurnTime=c?c:null,this.currentRoom.current=a,b=b||0,"common"==this.currentRoom.timeMode?(this.currentRoom.turnStartTime=null==this.currentRoom.turnStartTime?Date.now()-b:this.currentRoom.turnStartTime,this.currentRoom.userTime=b):(this.currentRoom.turnStartTime=Date.now(),this.currentRoom.userTime=(c||this.currentRoom.turnTime)-b,this.currentRoom.userTime<0&&(this.currentRoom.userTime=0)),this.emit("switch_player",this.currentRoom.current),this.emitTime(),this.timeInterval||(this.prevTime=null,this.timeInterval=setInterval(this.onTimeTick.bind(this),100)))):void console.error("game_manager;","switchPlayer","game not started!")},e.prototype.leaveGame=function(){return this.currentRoom?this.currentRoom.isClosed?void this.leaveRoom():void this.client.send("game_manager","leave","server",!0):void console.warn("game_manager;","leaveGame","game not started!")},e.prototype.leaveRoom=function(){if(!this.currentRoom)return void console.warn("game_manager;","leaveRoom","game not started!");if(!this.currentRoom.isClosed){if(this.currentRoom.isPlayer)throw new Error("leave not closed room! "+this.currentRoom.id);console.error("game_manager","spectator leave not closed room")}clearInterval(this.timeInterval),this.timeInterval=null,console.log("game_manager;","emit game_leave;",this.currentRoom),this.emit("game_leave",this.currentRoom),this.currentRoom=null},e.prototype.sendReady=function(){return this.currentRoom?(this.enableGames||(this.leaveGame(),this.client.viewsManager.dialogsView.showDialog("Новые игры временно отключены",{},!0,!1,!1)),void this.client.send("game_manager","ready","server",!0)):void console.error("game_manager;","sendReady","game not started!")},e.prototype.sendTurn=function(a){return this.isPlaying()?this.currentRoom.current!=this.client.getPlayer()?(console.warn("game_manager;","not your turn!"),!1):"common"!=this.currentRoom.timeMode&&this.currentRoom.userTime<300?(console.warn("game_manager;","your time is out!"),!1):(this.client.send("game_manager","turn","server",a),!0):(console.error("game_manager;","sendTurn","game not started!"),!1)},e.prototype.sendThrow=function(){return this.isPlaying()?void this.client.send("game_manager","event","server",{type:"throw"}):void console.error("game_manager","sendThrow","game not started!")},e.prototype.sendDraw=function(){return this.isPlaying()?this.currentRoom.cancelsAscDraw>=3?void this.client.viewsManager.dialogsView.showDialog("Число запросов ограничено тремя",!1,!0,!0):(this.client.send("game_manager","event","server",{type:"draw",action:"ask"}),void this.emit("send_draw")):void console.error("game_manager;","sendDraw","game not started!")},e.prototype.sendEvent=function(a,b,c){return this.isPlaying()?(console.log("game_manager;","sendEvent",a,b),b.type=a,c?b.target=c:c="server",void this.client.send("game_manager","event",c,b)):void console.error("game_manager;","sendEvent","game not started!")},e.prototype.sendTakeBack=function(){return this.isPlaying()?this.currentRoom.cancelsAscTakeBack>=3?void this.client.viewsManager.dialogsView.showDialog("Вы превысили число запросов к другому игроку",!1,!0,!0):(this.client.viewsManager.dialogsView.cancelTakeBack(),this.client.send("game_manager","event","server",{type:"back",action:"take"}),void this.emit("send_back")):void console.error("game_manager;","sendTakeBack","game not started!")},e.prototype.acceptTakeBack=function(){return this.isPlaying()?void this.client.send("game_manager","event","server",{type:"back",action:"accept"}):void console.error("game_manager;","acceptTakeBack","game not started!")},e.prototype.cancelTakeBack=function(){return this.isPlaying()?void this.client.send("game_manager","event","server",{type:"back",action:"cancel"}):void console.error("game_manager;","cancelTakeBack","game not started!")},e.prototype.acceptDraw=function(){return this.isPlaying()?void this.client.send("game_manager","event","server",{type:"draw",action:"accept"}):void console.error("game_manager;","acceptDraw","game not started!")},e.prototype.cancelDraw=function(){return this.isPlaying()?void this.client.send("game_manager","event","server",{type:"draw",action:"cancel"}):void console.error("game_manager;","cancelDraw","game not started!")},e.prototype.spectate=function(a){if(a){if(this.isPlaying())return void console.warn("game_manager;","spectate","you are already playing game!");this.isSpectating()&&this.leaveGame(),this.client.send("game_manager","spectate","server",{roomId:a})}},e.prototype.getPlayer=function(a){if(!this.currentRoom)return void console.error("game_manager;","getPlayer","game not started!");if(this.currentRoom)for(var b=0;b<this.currentRoom.players.length;b++)if(this.currentRoom.players[b].userId==a)return this.currentRoom.players[b];return null},e.prototype.getSpectator=function(a){for(var b=0;b<this.currentRoom.spectators.length;b++)if(this.currentRoom.spectators[b].userId==a)return this.currentRoom.spectators[b];return null},e.prototype.getHistory=function(){if(!this.currentRoom||!this.currentRoom.history)return[];for(var a=[],b=0;b<this.currentRoom.history.length;b++)if(this.currentRoom.history[b].length)for(var c=0;c<this.currentRoom.history[b].length;c++)a.push(this.currentRoom.history[b][c]);else a.push(this.currentRoom.history[b]);return a},e.prototype.getLastTurn=function(){if(this.currentRoom&&this.currentRoom.history&&this.currentRoom.history.length>=1){var a=this.currentRoom.history,b=a[a.length-1];return b.length?b[b.length-1]:b}return null},e.prototype.getTurnTime=function(){return this.currentRoom?this.currentRoom.userTurnTime||this.currentRoom.turnTime:null},e.prototype.inGame=function(){return null!=this.currentRoom&&!this.currentRoom.isClosed&&this.getPlayer(this.client.getPlayer().userId)},e.prototype.isPlaying=function(){return null!=this.currentRoom&&!this.currentRoom.isClosed&&this.getPlayer(this.client.getPlayer().userId)&&null!=this.currentRoom.current},e.prototype.isSpectating=function(){if(null!=this.currentRoom&&!this.currentRoom.isClosed&&this.currentRoom.spectators)for(var a=0;a<this.currentRoom.spectators.length;a++)if(this.currentRoom.spectators[a]==this.client.getPlayer())return!0;return!1},e.prototype.onTimeTick=function(){var a=Date.now();if(!this.prevTime)return void(this.prevTime=a);var b=a-this.prevTime;b>100&&(this.currentRoom.userTime-=b,this.currentRoom.userTime<0&&(this.currentRoom.userTime=0),this.emitTime(),this.prevTime=a)},e.prototype.emitTime=function(){var a=this.currentRoom.userTime;"common"==this.currentRoom.timeMode&&(a=Date.now()-this.currentRoom.turnStartTime);var b=Math.floor(a/6e4),c=Math.floor((a-6e4*b)/1e3);10>b&&(b="0"+b),10>c&&(c="0"+c),a="common"==this.currentRoom.timeMode?{userTimeMS:this.currentRoom.userTime,userTimeS:Math.floor(this.currentRoom.userTime/1e3),userTimePer:this.currentRoom.userTime/this.currentRoom.turnTime,userTimeFormat:b+":"+c}:{user:this.currentRoom.current,userTimeMS:this.currentRoom.userTime,userTimeS:Math.floor(this.currentRoom.userTime/1e3),userTimePer:this.currentRoom.userTime/this.currentRoom.turnTime,userTimeFormat:b+":"+c},this.emit("time",a)},e.prototype.parseHistory=function(a,b){function e(a){if(a.length)for(var b=0;b<a.length;b++)a[b]=e(a[b]);else a.type||"timeout"==a.action?(a.user=i.getPlayer(a.user)||void 0,a.nextPlayer=i.getPlayer(a.nextPlayer)||void 0,a.target=i.getPlayer(a.target)||void 0,a=new d(a)):(a.nextPlayer=i.getPlayer(a.nextPlayer)||void 0,a=new c(a,g,a.nextPlayer)),a.nextPlayer&&(g=a.nextPlayer);return a}a="["+a+"]",a=a.replace(new RegExp("@","g"),",");var f=JSON.parse(a);if(b&&0!=b.length&&(1==b.length&&(b=b[0]),f.push(b)),this.client.opts.newGameFormat){for(var g=this.currentRoom.current,h=[],i=this,j=0;j<f.length;j++)h=h.concat(e(f[j]));f=h}return f},e}),define("modules/invite_manager",["EE"],function(a){var b=function(a){var b=this;this.client=a,this.invites={},this.invite=null,this.inviteTimeoutTime=30,this.inviteTimeout=null,this.isPlayRandom=!1,a.userList.on("leave_user",function(a){b.invite&&b.invite.target==a.userId&&(b.invite=null),b.removeInvite(a.userId)}),a.on("user_relogin",function(a){b.invite&&b.invite.target==a.userId&&(b.invite=null,a.isInvited=!1),b.removeInvite(a.userId)}),a.gameManager.on("game_start",function(a){a.isPlayer&&(b.cancel(),b.rejectAll(),b.invite=null,b.isPlayRandom=!1,b.client.viewsManager.userListView._setRandomPlay())}),a.on("disconnected",function(){clearTimeout(b.inviteTimeout),b.invite=null;for(var a in b.invites)b.invites.hasOwnProperty(a)&&b.removeInvite(a);b.isPlayRandom=!1,b.client.viewsManager.userListView._setRandomPlay()}),a.on("mode_switch",function(){b.isPlayRandom&&b.playRandom(!0)})};return b.prototype=new a,b.prototype.onMessage=function(a){switch(console.log("invite_manager;","message",a),a.type){case"invite":this.onInvite(a.data);break;case"reject":this.onReject(a.data.target,a.data.from,"rejected");break;case"cancel":this.onCancel(a.data);break;case"random_wait":this.client.userList.onWaiting(a.data);break;case"random_cancel":this.client.userList.onWaiting(a.data)}},b.prototype.onInvite=function(a){return this.invites[a.from]=a,this.client.settings.disableInvite?void this.reject(a.from):this.isPlayRandom&&this.client.currentMode==a.mode?(console.log("invite_manager;","auto accept invite",a),void this.accept(a.from)):void this.emit("new_invite",{from:this.client.getUser(a.from),data:a})},b.prototype.onReject=function(a,b,c){console.log("invite_manger;","onReject",this.invite,"reason"),this.invite.target==a&&this.client.getPlayer().userId==b?((Date.now()-this.inviteTime)/1e3>this.inviteTimeoutTime-1&&(c="timeout"),this.emit("reject_invite",{user:this.client.userList.getUser(a),reason:c}),this.invite=null,clearTimeout(this.inviteTimeout)):console.warn("invite_manager; ","wrong user reject invite",a,b)},b.prototype.onCancel=function(a){console.log("invite_manger;","onCancel",a),this.invites[a.from]&&(this.emit("cancel_invite",this.invites[a.from]),this.removeInvite(a.from))},b.prototype.sendInvite=function(a,b){return this.client.gameManager.enableGames?this.client.gameManager.inGame()?void console.warn("You are already in game!"):a?(this.invite&&this.cancel(),b=b||{},b.mode?void console.error("invite param mode is reserved!"):(b.mode=this.client.currentMode,b.target=a,this.invite=b,this.inviteTime=Date.now(),this.client.send("invite_manager","invite",a,this.invite),void(this.inviteTimeout=setTimeout(function(){this.invite&&(this.client.send("invite_manager","cancel",this.invite.target,this.invite),this.onReject(this.invite.target,this.client.getPlayer().userId,"timeout"))}.bind(this),1e3*this.inviteTimeoutTime)))):void console.warn("invite_manager; ","wrong userId to send invite",a):void this.client.viewsManager.dialogsView.showDialog("новые игры временно отключены",{},!0,!1,!1)},b.prototype.accept=function(a){if(this.client.gameManager.inGame())return void console.warn("You are already in game!");if(this.invites[a]){var b=this.invites[a];delete this.invites[a],this.cancel(),this.rejectAll(),this.client.send("invite_manager","accept",a,b)}},b.prototype.reject=function(a){this.invites[a]&&(this.client.send("invite_manager","reject",a,this.invites[a]),this.removeInvite(a))},b.prototype.rejectAll=function(){for(var a in this.invites)this.invites.hasOwnProperty(a)&&(this.client.send("invite_manager","reject",a,this.invites[a]),this.removeInvite(a))},b.prototype.cancel=function(){console.log("invite_manger;","cancel",this.invite),this.invite&&(this.client.send("invite_manager","cancel",this.invite.target,this.invite),this.invite=null,clearTimeout(this.inviteTimeout))},b.prototype.removeInvite=function(a){console.log("invite_manger;","removeInvite",a),this.invites[a]&&(this.emit("remove_invite",this.invites[a]),clearInterval(this.invites[a]),delete this.invites[a])},b.prototype.playRandom=function(a){if(this.client.isLogin){if(!this.client.gameManager.enableGames&&!a)return void this.client.viewsManager.dialogsView.showDialog("новые игры временно отключены",{},!0,!1,!1);if(this.client.gameManager.inGame())return void console.warn("You are already in game!");if(a)this.isPlayRandom=!1,this.client.send("invite_manager","random","server","off"),this.client.viewsManager.userListView._setRandomPlay();else{for(var b in this.invites)if(this.invites[b].mode==this.client.currentMode)return console.log("invite_manager;","auto accept invite",this.invites[b]),void this.accept(b);this.isPlayRandom=!0;var c="function"==this.client.opts.getUserParams?this.client.opts.getUserParams():{};if(c.mode)return void console.error("invite param mode is reserved!");c.mode=this.client.currentMode,this.client.send("invite_manager","random","server",c)}}},b}),define("modules/user_list",["EE"],function(a){function b(a,b,c){if(!a||!a.userId||!a.userName)throw new Error("wrong user data!");for(var d in a)a.hasOwnProperty(d)&&(this[d]=a[d]);if(this.isPlayer=b||!1,this.disableInvite=a.disableInvite||!1,this.isActive="boolean"==typeof a.isActive?a.isActive:!0,this.fullName=this.userName,c.opts.shortGuestNames&&"Гость "==this.userName.substr(0,6)&&this.userName.length>11){var e=this.userName.substr(6,1)+".."+this.userName.substr(this.userName.length-2,2);this.userName="Гость "+e}this.getRank=function(a){return this[a||this._client.currentMode].rank||"—"},this.getNumberRank=function(a){return this[a||this._client.currentMode].rank||Number.POSITIVE_INFINITY},this.update=function(a){for(var b in a)a.hasOwnProperty(b)&&(this[b]=a[b]);if(this.disableInvite=a.disableInvite||!1,"boolean"==typeof a.isActive&&(this.isActive=a.isActive),this._client.opts.shortGuestNames&&"Гость "==this.userName.substr(0,6)&&this.userName.length>11){var c=this.userName.substr(6,1)+".."+this.userName.substr(this.userName.length-2,2);this.userName="Гость "+c}},this._client=c}var c=function(a){var b=this;this.client=a,this.users=[],this.rooms=[],this.waiting={},a.on("disconnected",function(){this.rooms=[],this.users=[],this.waiting={}}.bind(this)),a.gameManager.on("round_end",function(a){if(a.ratings&&a.mode){for(var c in a.ratings)for(var d=0;d<b.users.length;d++)b.users[d].userId==c&&(b.users[d][a.mode]=a.ratings[c]);this.emit("update",a)}})};return c.prototype=new a,c.prototype.onMessage=function(a){switch(a.type){case"user_login":this.onUserLogin(a.data)}},c.prototype.onUserLogin=function(a,c){var d=new b(a,c,this.client);c&&(this.player=d);for(var e=0;e<this.users.length;e++)if(this.users[e].userId==d.userId)return console.warn("user_list;","user already in list!",d),!1;if(this.client.opts.showCheaters)for(var e=0;e<this.client.modes.length;e++)if(d[this.client.modes[e]].timeLastCheatGame){d.userName="cheater!"+d.userName;break}this.users.push(d),this.emit("new_user",d)},c.prototype.onUserLeave=function(a){for(var b=0;b<this.users.length;b++)if(this.users[b].userId==a){var c=this.users[b];return this.users.splice(b,1),this.removeWaiting(c),void this.emit("leave_user",c)}console.warn("user_list;","onUserLeave; no user in list",a)},c.prototype.onGameStart=function(a,b){for(var c=0;c<b.length;c++)b[c]=this.getUser(b[c]),b[c].isInRoom=!0,this.removeWaiting(b[c]);var d={room:a,players:b};this.rooms.push(d),this.emit("new_room",d)},c.prototype.onGameEnd=function(a,b){for(var c=0;c<this.rooms.length;c++)if(this.rooms[c].room==a){var d=this.rooms[c];this.rooms.splice(c,1);for(var e=0;e<d.players.length;e++)d.players[e].isInRoom=!1;return void this.emit("close_room",d)}console.warn("user_list;","onGameEnd; no room in list",a,b)},c.prototype.onUserChanged=function(a){for(var b=0;b<this.users.length;b++)if(this.users[b].userId==a.userId){if(this.users[b].update(a),this.users[b].isPlayer||console.log("user_changed!",a.isActive,a),this.client.opts.showCheaters)for(var c=0;c<this.client.modes.length;c++)if(this.users[b][this.client.modes[c]].timeLastCheatGame){this.users[b].userName="cheater!"+this.users[b].userName;break}return void this.emit("user_changed",this.users[b])}console.warn("user_list;","onUserChanged; no user in list",a)},c.prototype.getUser=function(a){for(var b=0;b<this.users.length;b++)if(this.users[b].userId==a)return this.users[b];return null},c.prototype.getUsers=function(){var a=this.client.inviteManager.invite;return a?_.map(this.users,function(b){return b.userId===a.target&&(b.isInvited=!0),b}):this.users},c.prototype.getUserList=function(a){for(var b,c=[],d=this.client.inviteManager.invite,e=0;e<this.users.length;e++)b=this.users[e],d&&b.userId==d.target?b.isInvited=!0:delete b.isInvited,b.waiting=this.waiting&&this.waiting[this.client.currentMode]==b,b.isInRoom||(b.isPlayer||this.client.opts.showHidden||!b.disableInvite&&b.isActive)&&(a&&-1==b.userName.toLowerCase().indexOf(a)||c.push(b));return c.sort(function(a,b){var c=a.getRank();isNaN(+c)&&(c=99999999,a.isPlayer&&(c=99999998));var d=b.getRank();return isNaN(+d)&&(d=99999999,b.isPlayer&&(d=99999998)),c-d}),c},c.prototype.getFreeUserList=function(){for(var a,b=[],c=this.client.inviteManager.invite,d=0;d<this.users.length;d++)a=this.users[d],a.isPlayer||c&&a.userId==c.target||a.isInRoom||b.push(a);return b},c.prototype.getRoomList=function(a){for(var b,d=[],e=0;e<this.rooms.length;e++)if(b=this.rooms[e],b.current=this.client.gameManager.currentRoom&&this.client.gameManager.currentRoom.id==b.room,a){for(var f=0;f<b.players.length;f++)if(-1!=b.players[f].userName.toLowerCase().indexOf(a)){d.push(b);break}}else d.push(b);return d.sort(function(a,b){var d=c.getRoomRank(a),e=c.getRoomRank(b);return d-e}),d},c.prototype.getSpectatorsList=function(a){var b=[];if(this.client.gameManager.currentRoom&&this.client.gameManager.currentRoom.spectators.length)for(var c,d=this.client.inviteManager.invite,e=0;e<this.client.gameManager.currentRoom.spectators.length;e++)c=this.client.gameManager.currentRoom.spectators[e],d&&c.userId==d.target?c.isInvited=!0:delete c.isInvited,a&&-1==c.userName.toLowerCase().indexOf(a)||b.push(c);return b},c.prototype.onWaiting=function(a){if(a){var b;for(var c in a)b=a[c],b?(b=this.getUser(b),b?this.waiting[c]=b:console.error("waiting user no in list",a[c],c)):this.waiting[c]=null;this.emit("waiting",this.waiting)}},c.prototype.removeWaiting=function(a){if(this.waiting)for(var b in this.waiting)this.waiting[b]==a&&(this.waiting[b]=null)},c.getRoomRank=function(a){return a.players.length?Math.min(a.players[0].getNumberRank(),a.players[1].getNumberRank()):0},c.prototype.createUser=function(a){return a.userId&&a.userName||console.error("user_list;","wrong data for User",a),new b(a,a.userId==this.player.userId,this.client)},c}),define("modules/socket",["EE"],function(a){var b=function(a){a=a||{},this.port=a.port||"8080",this.domain=a.domain||document.domain,this.game=a.game||"test",this.url=a.url||this.game,this.https=a.https||!1,this.protocol=this.https?"wss":"ws",this.connectionCount=0,this.isConnecting=!0,this.isConnected=!1};return b.prototype=new a,b.prototype.init=function(){var a=this;this.isConnecting=!0,this.isConnected=!1,this.timeConnection=Date.now(),this.connectionCount++;try{this.ws=new WebSocket(this.protocol+"://"+this.domain+":"+this.port+"/"+this.url),this.ws.onclose=function(b,c){console.log("socket;","ws closed",b,c),a.isConnected&&a.onDisconnect()},this.ws.onerror=function(b){a.onError(b)},this.ws.onmessage=function(b,c){if("ping"==b.data)return void a.ws.send("pong");console.log("socket;","ws message",b,c);try{b=JSON.parse(b.data)}catch(d){return void console.log("socket;","ws wrong data in message",d)}a.onMessage(b)},this.ws.onopen=function(){console.log("socket;",new Date,"ws open"),a.onConnect()}}catch(b){console.log("socket;","ws open error"),this.onError(b)}},b.prototype.onError=function(a){console.log("socket;","ws error",a),this.isConnecting&&(this.isConnecting=!1,console.log("socket;","ws connection failed!"),this.onConnectionFailed())},b.prototype.onConnect=function(){this.isConnected=!0,this.connectionCount=0,this.emit("connection")},b.prototype.onDisconnect=function(){this.isConnected=!1,this.emit("disconnection")},b.prototype.onMessage=function(a){this.emit("message",a)},b.prototype.onConnectionFailed=function(){this.isConnecting=!1,this.isConnected=!1,this.emit("failed")},b.prototype.send=function(a){try{a=JSON.stringify(a)}catch(b){return void console.warn("socket;","json stringify err",a,b)}this.ws.send(a)},b}),define("text!tpls/userListFree.ejs",[],function(){return'<% _.each(users, function(user) { %>\r\n<tr class="userListFree <%= user.isActive?\'\':\'userListInactive\' %> <%= user.waiting?\'userListWaiting\':\'\' %> <%= user.isPlayer?\'userListPlayer\':\'\' %>">\r\n    <td class="userName" data-userId="<%= user.userId %>" title="<%= user.userName %>">\r\n        <%= user.userName %>\r\n    </td>\r\n    <td class="userRank"><%= user.getRank() %></td>\r\n    <% if (user.isPlayer) { %>\r\n    <td class="userListPlayerInvite">\r\n        <% if (user.disableInvite ) { %>\r\n        <img src="<%= imgBlock %>" title="<%= locale.disableInvite %>" >\r\n        <% } %>\r\n    </td>\r\n    <% } else if (user.isInvited) { %>\r\n    <td class="inviteBtn activeInviteBtn" data-userId="<%= user.userId %>"><%= locale.buttons.cancel %></td>\r\n    <% } else {\r\n        if (user.disableInvite) { %>\r\n        <td class="userListUserInvite"><img src="<%= imgBlock %>" title="<%= locale.playerDisableInvite %>"></td>\r\n        <% } else { %>\r\n            <td class="inviteBtn" data-userId="<%= user.userId %>"><%= locale.buttons.invite %></td>\r\n        <% }\r\n    } %>\r\n</tr>\r\n<% }) %>'}),define("text!tpls/userListInGame.ejs",[],function(){return"<% _.each(rooms, function(room) { %>\r\n<tr class=\"userListGame <%= room.current ? 'currentGame' : '' %>\" data-id=\"<%= room.room %>\">\r\n    <td class=\"userName\" title=\"<%= room.players[0].userName + ' (' +  room.players[0].getRank(room.mode) + ')' %>\" ><%= room.players[0].userName %></td>\r\n    <td>:</td>\r\n    <td class=\"userName\" title=\"<%= room.players[1].userName + ' (' +  room.players[1].getRank(room.mode) + ')' %>\" ><%= room.players[1].userName %></td>\r\n</tr>\r\n<% }) %>"
}),define("text!tpls/userListMain.ejs",[],function(){return'<div class="tabs notInGame">\r\n    <div data-type="free"> <%= tabs.free %> <span></span></div>\r\n    <div data-type="inGame"> <%= tabs.inGame %>  <span></span></div>\r\n    <div data-type="spectators" style="display: none"> <%= tabs.spectators %>  <span></span></div>\r\n</div>\r\n<div id="userListSearch">\r\n    <label for="filterUserList"> <%= search %>:</label><input type="text" id="filterUserList"/>\r\n</div>\r\n<div class="tableWrap">\r\n    <table cellspacing="0" class="playerList"></table>\r\n</div>\r\n\r\n<div class="btn" id="randomPlay">\r\n    <span><%= buttons.playRandom %></span>\r\n</div>'}),define("views/user_list",["underscore","backbone","text!tpls/userListFree.ejs","text!tpls/userListInGame.ejs","text!tpls/userListMain.ejs"],function(a,b,c,d,e){var f=b.View.extend({tagName:"div",id:"userList",tplFree:a.template(c),tplInGame:a.template(d),tplMain:a.template(e),events:{"click .inviteBtn":"_inviteBtnClicked","click .userName":"userClick","click .userListGame":"roomClick","click .tabs div":"clickTab","click .disconnectButton":"_reconnect","click #randomPlay":"playClicked","keyup #filterUserList":"filter","mouseenter ":"mouseEnter","mouseleave ":"mouseLeave"},_reconnect:function(){this.client.reconnect(),this.$list.html(this.$loadingTab)},clickTab:function(a){if(this.client.socket.isConnected){var b=$(a.currentTarget),c=b.attr("data-type");c!==this.currentActiveTabName&&(this._setActiveTab(c),this.render())}},userClick:function(a){var b=$(a.currentTarget),c=b.attr("data-userId");this.client.onShowProfile(c)},roomClick:function(a){var b=$(a.currentTarget),c=b.attr("data-Id");c?this.client.gameManager.spectate(c):console.warn("wrong room id",c)},_inviteBtnClicked:function(a){var b=$(a.currentTarget),c=b.attr("data-userId");this.invitePlayer(c)},invitePlayer:function(a){if(this.client.gameManager.inGame())return void console.warn("You are already in game!");var b=this.$el.find('.inviteBtn[data-userId="'+a+'"]');if(b.hasClass(this.ACTIVE_INVITE_CLASS))this.client.inviteManager.cancel(),b.removeClass(this.ACTIVE_INVITE_CLASS),b.html(this.locale.buttons.invite);else{this.$el.find("."+this.ACTIVE_INVITE_CLASS).html(this.locale.buttons.invite).removeClass(this.ACTIVE_INVITE_CLASS);var c="function"==typeof this.client.opts.getUserParams?this.client.opts.getUserParams():{};c=$.extend(!0,{},c),this.client.inviteManager.sendInvite(a,c),b.addClass(this.ACTIVE_INVITE_CLASS),b.html(this.locale.buttons.cancel)}},playClicked:function(){this.client.inviteManager.playRandom(this.client.inviteManager.isPlayRandom),this._setRandomPlay()},filter:function(){this.render()},mouseEnter:function(){this.mouseOver=!0},mouseLeave:function(){this.mouseOver=!1},initialize:function(a){var b=this.render.bind(this);this.images=a.opts.images,this.client=a,this.locale=a.locale.userList,this.mouseOver=!1,this.$disconnectedTab=$('<tr class="disconnected"><td><div><span class="disconnectText">'+this.locale.disconnected.text+'</span><br><br><span class="disconnectButton">'+this.locale.disconnected.button+"</span></div></td></tr>"),this.$loadingTab=$("<tr><td>"+this.locale.disconnected.status+"</td></tr>"),this.$el.html(this.tplMain(this.locale)),this.$el.addClass("v6-block-border"),a.opts.blocks.userListId?$("#"+a.opts.blocks.userListId).append(this.el):$("body").append(this.el),this.ACTIVE_INVITE_CLASS="activeInviteBtn",this.ACTIVE_TAB_CLASS="activeTab",this.TEXT_PLAY_ACTIVE=this.locale.buttons.cancelPlayRandom,this.TEXT_PLAY_UNACTIVE=this.locale.buttons.playRandom,this.IN_GAME_CLASS="inGame",this.NOT_IN_GAME_CLASS="NotInGame",this.$list=this.$el.find(".tableWrap table"),this.$container=this.$el.find(".tableWrap"),this.$counterFree=this.$el.find('.tabs div[data-type="free"]').find("span"),this.$counterinGame=this.$el.find('.tabs div[data-type="inGame"]').find("span"),this.$counterSpectators=this.$el.find('.tabs div[data-type="spectators"]').find("span"),this.$btnPlay=this.$el.find("#randomPlay"),this.$filter=this.$el.find("#filterUserList"),this.$tabs=this.$el.find(".tabs"),this.listenTo(this.client.userList,"new_user",b),this.listenTo(this.client,"mode_switch",b),this.listenTo(this.client.userList,"update",b),this.listenTo(this.client.userList,"leave_user",b),this.listenTo(this.client.inviteManager,"reject_invite",this.onRejectInvite.bind(this)),this.listenTo(this.client.userList,"new_room",b),this.listenTo(this.client.userList,"close_room",b),this.listenTo(this.client.userList,"user_changed",b),this.listenTo(this.client.userList,"waiting",b),this.listenTo(this.client,"disconnected",b),this.listenTo(this.client,"user_relogin",b),this.listenTo(this.client.gameManager,"spectator_join",b),this.listenTo(this.client.gameManager,"spectator_leave",b),this.listenTo(this.client.gameManager,"game_start",this.showSpectatorsTab.bind(this)),this.listenTo(this.client.gameManager,"game_leave",this.hideSpectatorsTab.bind(this)),this._setActiveTab("free"),this.$list.html(this.$loadingTab),this.randomPlay=!1},_setRandomPlay:function(){this.client.inviteManager.isPlayRandom?(this.$btnPlay.html(this.TEXT_PLAY_ACTIVE),this.$btnPlay.addClass("active")):(this.$btnPlay.html(this.TEXT_PLAY_UNACTIVE),this.$btnPlay.removeClass("active"))},showSpectatorsTab:function(){this.client.opts.showSpectators&&(this.$tabs.removeClass(this.NOT_IN_GAME_CLASS),this.$tabs.addClass(this.IN_GAME_CLASS),this.$el.find('.tabs div[data-type="spectators"]').show(),this.render())},hideSpectatorsTab:function(){this.client.opts.showSpectators&&("spectators"==this.currentActiveTabName&&this._setActiveTab("free"),this.$tabs.addClass(this.NOT_IN_GAME_CLASS),this.$tabs.removeClass(this.IN_GAME_CLASS),this.$el.find('.tabs div[data-type="spectators"]').hide())},_setActiveTab:function(a){this.currentActiveTabName=a,this.$el.find(".tabs div").removeClass(this.ACTIVE_TAB_CLASS),this.$el.find('.tabs div[data-type="'+a+'"]').addClass(this.ACTIVE_TAB_CLASS)},_setCounters:function(){return this.client.socket.isConnected?(this.$counterFree.html("("+this.client.userList.getUserList().length+")"),this.$counterinGame.html("("+2*this.client.userList.getRoomList().length+")"),void this.$counterSpectators.html("("+this.client.userList.getSpectatorsList().length+")")):(this.$counterFree.html(""),this.$counterinGame.html(""),void this.hideSpectatorsTab())},_showPlayerListByTabName:function(){if(!this.client.socket.isConnected)return void this.$list.html(this.$disconnectedTab);switch(this.currentActiveTabName){case"free":this.$list.html(this.tplFree({users:this.client.userList.getUserList(this.getFilter()),locale:this.locale,imgBlock:this.images.block})),this.mouseOver||this.scrollToUser();break;case"inGame":this.$list.html(this.tplInGame({rooms:this.client.userList.getRoomList(this.getFilter())}));break;case"spectators":this.$list.html(this.tplFree({users:this.client.userList.getSpectatorsList(this.getFilter()),locale:this.locale,imgBlock:this.images.block}));break;default:console.warn("unknown tab",this.currentActiveTabName)}},onRejectInvite:function(a){this.$el.find("."+this.ACTIVE_INVITE_CLASS+'[data-userId="'+a.user.userId+'"]').html(this.locale.buttons.invite).removeClass(this.ACTIVE_INVITE_CLASS)},render:function(){return this.client.unload?void 0:(setTimeout(this._showPlayerListByTabName.bind(this),1),this._setCounters(),this)},scrollToUser:function(){if("free"==this.currentActiveTabName){var a=this.$el.find(".userListPlayer");a.length&&(a=a.offset().top-this.$container.offset().top+this.$container.scrollTop()-this.$container.height()/2,this.$container.scrollTop(a))}},getFilter:function(){var a=this.$filter.val().toLowerCase().trim();return 0==a.length&&(a=!1),a},addInviteFriendButton:function(){var a=$("<div>"),b=$("#v6Chat");a.attr("id","vkInviteFriend"),a.addClass("btn"),a.html("Пригласить Друга"),a.width(b.width()-10),a.css("top",b.position().top+b.height()+30+"px"),a.on("click",this.client.vkInviteFriend.bind(this.client)),this.$el.append(a)}});return f}),define("text!tpls/v6-dialogRoundResult.ejs",[],function(){return'<p><%= result %></p>\r\n<p><%= rankResult %></p>\r\n<%= vkPost ? \'<span class="vkWallPost">Рассказать друзьям</span>\' : \'<br>\'%>\r\n<span class="dialogGameAction"><%= locale.dialogPlayAgain %></span>\r\n<div class="roundResultTime"><%= locale.inviteTime %><span>30</span><%= locale.seconds %></div>\r\n'}),define("views/dialogs",["underscore","text!tpls/v6-dialogRoundResult.ejs"],function(a,b){var c=function(){function c(a){z=a,A=z.locale.dialogs,z.inviteManager.on("new_invite",d),z.inviteManager.on("reject_invite",e),z.inviteManager.on("cancel_invite",f),z.inviteManager.on("remove_invite",g),z.gameManager.on("user_leave",m),z.gameManager.on("turn",q),z.gameManager.on("game_start",t),z.gameManager.on("round_start",s),z.gameManager.on("round_end",l),z.gameManager.on("game_leave",p),z.gameManager.on("ask_draw",h),z.gameManager.on("cancel_draw",i),z.gameManager.on("ask_back",j),z.gameManager.on("cancel_back",k),z.chatManager.on("show_ban",o),z.on("login_error",n),z.on("disconnected",y),$(document).on("click",w),Q=z.inviteManager.inviteTimeoutTime,R='<div class="inviteTime">'+A.inviteTime+"<span>"+Q+"</span>"+A.seconds+"</div>"}function d(a){var b=A.invite+" <b>"+a.from.userName+"</b>";"function"==typeof this.client.opts.generateInviteText&&(b=this.client.opts.generateInviteText(a)),b+=R;var c=r(b,{buttons:{"Принять":{text:A.accept,click:function(){clearInterval(a.data.timeInterval),z.inviteManager.accept($(this).attr("data-userId")),$(this).remove()}},"Отклонить":{text:A.decline,click:function(){clearInterval(a.data.timeInterval),z.inviteManager.reject($(this).attr("data-userId")),$(this).remove()}}},close:function(){clearInterval(a.data.timeInterval),z.inviteManager.reject($(this).attr("data-userId")),$(this).remove()}},!0,!1,!1);c.attr("data-userId",a.from.userId),c.addClass(G),a.data.startTime=Date.now(),a.data.timeInterval=setInterval(function(){var b=(1e3*Q-(Date.now()-a.data.startTime))/1e3^0;this.find(".inviteTime span").html(b),1>b&&this.dialog("close")}.bind(c),250)}function e(a){console.log("dialogs; rejectInvite invite",a);var b=A.user+" <b>"+a.user.userName+"</b>";b+="timeout"!=a.reason?A.rejectInvite:A.timeoutInvite+Q+A.seconds;r(b,{},!0,!0,!0)}function f(a){console.log("dialogs; cancel invite",a),clearInterval(a.timeInterval)}function g(a){console.log("dialogs; removeInvite invite",a);var b=a.from;$("."+G+'[data-userId="'+b+'"]').remove(),clearInterval(a.timeInterval)}function h(a){if(this.client.gameManager.inGame()){var b=A.user+" <b>"+a.userName+"</b>"+A.askDraw,c=r(b,{buttons:{"Принять":{text:A.accept,click:function(){z.gameManager.acceptDraw(),$(this).remove()}},"Отклонить":{text:A.decline,click:function(){z.gameManager.cancelDraw(),$(this).remove()}}},close:function(){z.gameManager.cancelDraw(),$(this).remove()}},!0,!0,!1);c.addClass(H)}}function i(a){{var b=A.user+" <b>"+a.userName+"</b> "+A.cancelDraw;r(b,{},!0,!0,!0)}}function j(a){if(this.client.gameManager.inGame()){var b=A.user+" <b>"+a.userName+"</b> "+A.askTakeBack,c=r(b,{buttons:{"Да":{text:A.yes,click:function(){z.gameManager.acceptTakeBack(),$(this).remove()}},"Нет":{text:A.no,click:function(){z.gameManager.cancelTakeBack(),$(this).remove()}}},close:function(){z.gameManager.cancelTakeBack(),$(this).remove()}},!0,!0,!1);c.addClass(K),c.addClass(H)}}function k(a){if(this.client.gameManager.inGame()){var b=A.user+" <b>"+a.userName+"</b>"+A.cancelTakeBack;r(b,{},!0,!0,!0)}}function l(a){if(a.isPlayer){var b=+z.getPlayer()[a.mode].ratingElo,c=+z.getPlayer()[a.mode].rank,d=+a.ratings[z.getPlayer().userId].ratingElo,e=+a.ratings[z.getPlayer().userId].rank,f=d-b,g=!1,h="";console.log("round_end;",a,b,d,c,e),t();var i="",j="";if(a.save){switch(a.result){case"win":i=A.win;break;case"lose":i=A.lose;break;case"draw":i=A.draw;break;default:i=A.gameOver}i+="<b> ("+(f>=0?"+":"")+f+" "+A.scores+") </b>"}switch(a.action){case"timeout":i+="win"==a.result?A.opponentTimeout:A.playerTimeout;break;case"throw":i+="win"==a.result?A.opponentThrow:A.playerThrow}e>0&&a.save&&(j="win"==a.result&&c>0&&c>e?A.ratingUp+c+A.on+e+A.place+".":A.ratingPlace+e+A.place+"."),this.client.vkWallPost&&(0==z.getPlayer()[a.mode].win&&1==a.ratings[z.getPlayer().userId].win?(g=!0,h="Моя первая победа"):"win"==a.result&&c>0&&c>e&&(g=!0,h="Я занимаю "+e+" место в рейтинге"));var k=P({result:i,rankResult:j,vkPost:g,locale:A}),l=r(k,{width:350,buttons:{"Да, начать новую игру":{text:A.playAgain,"class":M,click:function(){console.log("result yes"),z.gameManager.sendReady(),l.parent().find(":button").hide(),l.parent().find(":button."+N).show(),l.find("."+L).html(A.waitingOpponent)}},"Нет, выйти":{text:A.leave,"class":N,click:function(){console.log("result no"),clearInterval(B),$(this).remove(),z.gameManager.leaveGame()}},"Ок":{text:"Ок","class":O,click:function(){console.log("result ok"),clearInterval(B),$(this).remove(),z.gameManager.leaveGame()}}},close:function(){console.log("result close"),clearInterval(B),$(this).remove(),z.gameManager.leaveGame()}},!0,!1);l.addClass(J),l.parent().find(":button."+O).hide(),l.parent().hide(),D=setTimeout(function(){l.parent().show(),this.client.soundManager._playSound(a.result)}.bind(this),"user_leave"==a.action?1e3:z.opts.resultDialogDelay),l.addClass(H),C=Date.now(),B=setInterval(function(){var a=(1e3*Q-(Date.now()-C))/1e3^0;this.find(".roundResultTime span").html(a),1>a&&(console.log("interval",a),clearInterval(B),this.find(".roundResultTime").hide(),this.find("."+L).html(A.waitingTimeout),l.parent().find(":button").hide(),l.parent().find(":button."+O).show(),l.removeClass(H),z.gameManager.leaveGame())}.bind(l),250),g&&l.find(".vkWallPost").on("click",function(){this.client.vkWallPostResult(h)}.bind(this))}}function m(a){u();var b=A.user+" <b>"+a.userName+"</b> "+A.opponentLeave,c=$("."+J);c&&c.length>0?(c.parent().find(":button").hide(),c.parent().find(":button."+O).show(),c.find("."+L).html(b),clearInterval(B),c.find(".roundResultTime").hide()):c=r(b,{buttons:{"Ок":function(){$(this).remove(),z.gameManager.leaveRoom()}},close:function(){z.gameManager.leaveRoom(),$(this).remove()}},!0,!0,!0),c.addClass(H)}function n(){{var a=A.loginError;r(a,{},!1,!1,!1)}}function o(a){var b=A.banMessage;b+=a.reason&&""!=a.reason?"за "+a.reason:A.banReason,a.timeEnd&&(b+=a.timeEnd>228e10?" навсегда":" до "+x(a.timeEnd));r(b,{},!1,!1,!1)}function p(){u(),v()}function q(){$("."+K).dialog("close")}function r(a,b,c,d,e){b=b||{},b.resizable=b.resizable||!1,b.modal=b.modal||!1,b.draggable=b.draggable||!1,b.buttons=b.buttons||{"Ок":function(){$(this).remove()}},c=c||b.draggable,d=d||b.notification,e=e||b.clickHide;var f=$("<div>"),g=document.activeElement||document;return f.html(a).dialog(b),f.parent().find(":button").attr("tabindex","-1"),null!=document.activeElement&&document.activeElement.blur(),$(g).focus(),c&&(f.parent().draggable(),f.addClass(I)),d&&f.addClass(E),e&&f.addClass(F),f}function s(){clearInterval(B),$("."+J).remove()}function t(){$("."+E).dialog("close"),$("."+G).dialog("close"),clearTimeout(D),clearInterval(B)}function u(){$("."+E).dialog("close")}function v(){$("."+H).dialog("close")}function w(){$("."+F).dialog("close")}function x(a){function b(a,b,c){for(a=""+a;a.length<b;)a=c+a;return a}var c=new Date(a),d=c.getDate(),e=c.getMonth()+1,f=(""+c.getFullYear()).substr(2,2);return b(d,2,"0")+"."+b(e,2,"0")+"."+f}function y(){t(),$("."+J).remove()}var z,A,B,C,D,E="dialogNotification",F="dialogClickHide",G="dialogInvite",H="dialogGame",I="dialogDraggable",J="dialogRoundResult",K="dialogTakeBack",L="dialogGameAction",M="btnPlayAgain",N="btnLeaveGame",O="btnLeaveGameOk",P=a.template(b),Q=30,R="";return{init:c,showDialog:r,hideDialogs:t,hideNotification:u,cancelTakeBack:function(){$("."+K).dialog("close")}}}();return c}),define("text!tpls/v6-chatMain.ejs",[],function(){return'<div class="tabs">\r\n    <div class="tab" data-type="public"><%= locale.tabs.main %></div>\r\n    <div class="tab" data-type="room" style="display: none;"><%= locale.tabs.room %></div>\r\n    <div class="tab" data-type="private" style="display: none;">игрок</div>\r\n</div>\r\n<div class="clear"></div>\r\n<div class="messagesWrap"><ul></ul></div>\r\n<div class="inputMsg" contenteditable="true"></div>\r\n<div class="layer1">\r\n    <div class="sendMsgBtn"><%= locale.buttons.send %></div>\r\n    <select id="chat-select">\r\n        <option selected style="font-style: italic;"><%= locale.templateMessages.header %></option>\r\n        <option>Ваш ход!</option>\r\n        <option>Привет!</option>\r\n        <option>Молодец!</option>\r\n        <option>Здесь кто-нибудь умеет играть?</option>\r\n        <option>Кто со мной?</option>\r\n        <option>Спасибо!</option>\r\n        <option>Спасибо! Интересная игра!</option>\r\n        <option>Спасибо, больше играть не могу. Ухожу!</option>\r\n        <option>Спасибо, интересная игра! Сдаюсь!</option>\r\n        <option>Отличная партия. Спасибо!</option>\r\n        <option>Ты мог выиграть</option>\r\n        <option>Ты могла выиграть</option>\r\n        <option>Ходи!</option>\r\n        <option>Дай ссылку на твою страницу вконтакте</option>\r\n        <option>Снимаю шляпу!</option>\r\n        <option>Красиво!</option>\r\n        <option>Я восхищен!</option>\r\n        <option>Где вы так научились играть?</option>\r\n        <option>Еще увидимся!</option>\r\n        <option>Ухожу после этой партии. Спасибо!</option>\r\n        <option>Минуточку</option>\r\n    </select>\r\n</div>\r\n<div class="layer2">\r\n    <span class="chatAdmin">\r\n        <input type="checkbox" id="chatIsAdmin"/><label for="chatIsAdmin">От админа</label>\r\n    </span>\r\n\r\n    <span class="chatRules"><%= locale.buttons.chatRules %></span>\r\n</div>\r\n\r\n<ul class="menuElement noselect">\r\n    <li data-action="answer"><span><%= locale.menu.answer %></span></li>\r\n    <li data-action="invite"><span><%= locale.menu.invite %></span></li>\r\n    <li data-action="showProfile"><span><%= locale.menu.showProfile %></span></li>\r\n    <li data-action="ban"><span><%= locale.menu.ban %></span></li>\r\n</ul>'}),define("text!tpls/v6-chatMsg.ejs",[],function(){return'<li class="chatMsg" data-msgId="<%= msg.time %>">\r\n    <div class="msgRow1">\r\n        <div class="smallRight time"><%= msg.t %></div>\r\n        <div class="smallRight rate"><%= (msg.rank || \'—\') %></div>\r\n        <div class="chatUserName" data-userId="<%= msg.userId%>" title="<%= msg.userName %>">\r\n            <span class="userName"><%= msg.userName %></span>\r\n        </div>\r\n    </div>\r\n    <div class="msgRow2">\r\n        <div class="delete" title="Удалить сообщение" style="background-image: url(<%= imgDel %>);"></div>\r\n        <div class="msgTextWrap">\r\n            <span class="v6-msgText"><%= _.escape(msg.text) %></span>\r\n        </div>\r\n    </div>\r\n</li>'}),define("text!tpls/v6-chatDay.ejs",[],function(){return'<li class="chatDay" data-day-msgId="<%= time %>">\r\n    <div>\r\n        <%= d %>\r\n    </div>\r\n</li>'}),define("text!tpls/v6-chatRules.ejs",[],function(){return'<div id="chat-rules" class="aboutPanel v6-block-border">\r\n    <img class="closeIcon" src="<%= close %>">\r\n\r\n    <div style="padding: 10px 12px 15px 25px;">\r\n        <h2>Правила чата</h2>\r\n        <p style="line-height: 16px;">В чате запрещено:<br>\r\n            <span style="margin-left:5px;">1. использование ненормативной лексики и оскорбительных выражений;</span><br>\r\n            <span style="margin-left:5px;">2. хамское и некорректное общение с другими участниками;</span><br>\r\n            <span style="margin-left:5px;">3. многократная публикация бессмысленных, несодержательных или одинаковых сообщений.</span>\r\n        </p>\r\n\r\n        <p style="line-height: 16px;"><span style="margin-left:5px;">Баны</span> выносятся: на 1 день, на 3 дня, на 7 дней, на месяц или навсегда,\r\n            в зависимости от степени тяжести нарушения.\r\n        </p>\r\n\r\n        <p style="line-height: 16px;"><span style="margin-left:5px;">Бан</span> снимается автоматически по истечении срока.\r\n        </p>\r\n\r\n    </div>\r\n</div>'}),define("text!tpls/v6-chatBan.ejs",[],function(){return'<div>\r\n    <span class="ban-username" style="font-weight:bold;">Бан игрока <i><%= userName%></i></span><br><br>\r\n    <span>Причина бана:</span>\r\n    <br>\r\n    <div class="inputTextField" id="ban-reason" contenteditable="true" style="height:54px; border: 1px solid #aaaaaa;"></div><br>\r\n\r\n    <span>Длительность бана:</span><br>\r\n    <select id="ban-duration">\r\n        <option value="1">1 день</option>\r\n        <option value="3">3 дня</option>\r\n        <option value="7" selected="">7 дней</option>\r\n        <option value="30">30 дней</option>\r\n        <option value="9999">Навсегда</option>\r\n    </select>\r\n\r\n</div>'}),define("views/chat",["underscore","backbone","text!tpls/v6-chatMain.ejs","text!tpls/v6-chatMsg.ejs","text!tpls/v6-chatDay.ejs","text!tpls/v6-chatRules.ejs","text!tpls/v6-chatBan.ejs"],function(a,b,c,d,e,f,g){var h=b.View.extend({tagName:"div",id:"v6Chat",tplMain:a.template(c),tplMsg:a.template(d),tplDay:a.template(e),tplRules:a.template(f),tplBan:a.template(g),events:{"click .chatMsg":"_deleteMsg","click .tab":"clickTab","blur .inputMsg":"blurInputMsg","focus .inputMsg":"clickInputMsg","click .sendMsgBtn":"sendMsgEvent","keyup .inputMsg":"sendMsgEvent","change #chat-select":"changeChatSelect","click .chatMsg div[data-userid]":"showMenu","click li[data-action]":"clickDialogAction","click .chatRules":"showChatRules"},banUser:function(a,b){{var c=this.manager;$(this.tplBan({userName:b})).attr("data-userId",a).dialog({buttons:{"Добавить в бан":function(){c.banUser($(this).attr("data-userId"),$(this).find("#ban-duration")[0].value,$(this).find("#ban-reason").html()),$(this).remove()},"Отмена":function(){$(this).remove()}},close:function(){$(this).remove()}}).parent().draggable()}},answerUser:function(a,b){var c=this.$inputMsg.text();if(console.log("answer",b,c),this.$inputMsg.has(this.$placeHolderSpan).length&&(c=" "),-1==c.indexOf(b+","))if(this.$inputMsg.text(b+", "+c),this.$inputMsg.focus(),"undefined"!=typeof window.getSelection&&"undefined"!=typeof document.createRange){var d=document.createRange();d.selectNodeContents(this.$inputMsg[0]),d.collapse(!1);var e=window.getSelection();e.removeAllRanges(),e.addRange(d)}else if("undefined"!=typeof document.body.createTextRange){var f=document.body.createTextRange();f.moveToElementText(this.$inputMsg[0]),f.collapse(!1),f.select()}},showChatRules:function(){this.$rules.css({top:$(window).height()/2-this.$rules.outerHeight()/2,left:$(window).width()/2-this.$rules.outerWidth()/2}).show()},clickDialogAction:function(a){var b={action:$(a.currentTarget).attr("data-action"),userId:this.$menu.attr("data-userId"),userName:this.$menu.attr("data-userName")};switch(b.action){case"showProfile":this.client.onShowProfile(b.userId,b.userName);break;case"invite":this.client.viewsManager.userListView.invitePlayer(b.userId);break;case"ban":this.banUser(b.userId,b.userName);break;case"answer":this.answerUser(b.userId,b.userName)}},showMenu:function(a){var b=a.target.getBoundingClientRect(),c=20,d=$(a.target).parent().attr("data-userid"),e=$(a.currentTarget).attr("title");setTimeout(function(){if(this.$menu.find("li[data-action=invite]").hide(),!this.client.gameManager.inGame()){var a=this.client.userList.getFreeUserList();if(a)for(var f=0;f<a.length;f++)a[f].userId==d&&this.$menu.find("li[data-action=invite]").show()}this.$menu.attr("data-userId",d),this.$menu.attr("data-userName",e),this.$menu.css({left:c,top:b.top-document.getElementById("v6Chat").getBoundingClientRect().top+c}).slideDown()}.bind(this),0)},hideMenuElement:function(){this.$menu.removeAttr("data-userId"),this.$menu.hide()},changeChatSelect:function(a){var b=a.target.options[a.target.selectedIndex].innerHTML;this.$SELECTED_OPTION.attr("selected",!0);var c=this.$inputMsg.text();c=(", "==c.substr(c.length-3,2)?c:"")+b,this.$inputMsg.text(c)},sendMsgEvent:function(a){("keyup"!==a.type||13===a.keyCode)&&(this.$inputMsg.has(this.$placeHolderSpan).length||this._sendMsg(this.$inputMsg.text()))},scrollEvent:function(){this.$messagesWrap[0].scrollHeight-this.$messagesWrap.height()!=0&&this.$messagesWrap.scrollTop()<5&&this.client.isLogin&&!this.manager.fullLoaded[this.manager.current]&&(this._setLoadingState(),this.manager.loadMessages())},bodyScroll:function(a){a.deltaY=a.deltaY||a.originalEvent.wheelDeltaY||-a.originalEvent.detail,this.$messagesWrap[0].scrollHeight-this.$messagesWrap.height()-this.$messagesWrap.scrollTop()===0&&a.deltaY<0&&(a.preventDefault(),a.stopPropagation())},_sendMsg:function(a){if(""!==a&&"string"==typeof a){if(a.length>this.MAX_MSG_LENGTH)return void alert(this.MAX_LENGTH_MSG);this.manager.sendMessage(a,null,this.currentActiveTabName,$("#chatIsAdmin")[0].checked),this.$inputMsg.empty(),this.$inputMsg.focus()}},blurInputMsg:function(a){var b=$(a.currentTarget);""===b.text()&&b.empty().append(this.$placeHolderSpan)},clickInputMsg:function(a){var b=$(a.currentTarget);b.has(this.$placeHolderSpan).length&&b.empty()},clickTab:function(a){var b=$(a.target),c=b.attr("data-type");c!==this.currentActiveTabName&&(this.currentActiveTabName=c,this._setActiveTab(this.currentActiveTabName),this.manager.loadCachedMessages(this.tabs[c].target,this.currentActiveTabName))},initialize:function(a){this.client=a,this.locale=a.locale.chat,this.manager=a.chatManager,this.images=a.opts.images,this.$el.html(this.tplMain({locale:this.locale})),this.$el.addClass("v6-block-border"),this.MAX_MSG_LENGTH=128,this.SCROLL_VAL=40,this.MAX_LENGTH_MSG="Сообщение слишком длинное (максимальная длина - 128 символов). Сократите его попробуйте снова",this.CLASS_DISABLED="disabled",this.CLASS_CHATADMIN="chatAdmin",this.CLASS_DELETE_CHAT_MESSAGE="delete",this.CLASS_NEW_MSG="newMsg",this.CLASS_ADMIN_MSG="isAdmin",this.ACTIVE_TAB_CLASS="activeTab",this.CLASS_MENU_ELEMENT="menuElement",this.$menu=this.$el.find("."+this.CLASS_MENU_ELEMENT),this.client.isAdmin||this.$menu.find('li[data-action="ban"]').remove(),window.document.body.addEventListener("click",this.hideMenuElement.bind(this)),this.$rules=$(this.tplRules({close:this.images.close})),window.document.body.appendChild(this.$rules[0]),this.$rules.find("img.closeIcon").on("click",function(){this.$rules.hide()}.bind(this)),this.$placeHolderSpan=$('<span class="placeHolderSpan">'+this.locale.inputPlaceholder+"..</span>"),this.$spinnerWrap=$('<li class="spinnerWrap"><div class="spinner" style="background: url('+this.images.spin+');"></div></li>'),this.$messagesWrap=this.$el.find(".messagesWrap"),this.$msgsList=this.$messagesWrap.find("ul"),this.$inputMsg=this.$el.find(".inputMsg"),this.$SELECTED_OPTION=this.$el.find("select option:selected"),this.currentActiveTabName="public",this.currentActiveTabTitle=a.game,this.tabs={"public":{target:a.game,title:this.locale.tabs.main},"private":null,room:null},this._setActiveTab(this.currentActiveTabName),a.opts.blocks.chatId?$("#"+a.opts.blocks.chatId).append(this.el):$("body").append(this.el),this.$inputMsg.empty().append(this.$placeHolderSpan),this._setLoadingState(),this.client.isAdmin&&this.$el.find("."+this.CLASS_CHATADMIN).removeClass(this.CLASS_CHATADMIN),this.listenTo(this.manager,"message",this._addOneMsg.bind(this)),this.listenTo(this.manager,"load",this._preaddMsgs.bind(this)),this.listenTo(this.manager,"open_dialog",this._openDialog.bind(this)),this.listenTo(this.manager,"close_dialog",this._closeDialog.bind(this)),this.listenTo(this.client,"disconnected",this._closeDialog.bind(this)),this.$messagesWrap.scroll(this.scrollEvent.bind(this)),this.$messagesWrap.on({"mousewheel DOMMouseScroll":this.bodyScroll.bind(this)})},setPublicTab:function(a){this.tabs["public"].target=a,this.currentActiveTabName="public",this._setActiveTab("public")},_setActiveTab:function(a){var b=this.$el.find('.tabs div[data-type="'+a+'"]');this.$el.find(".tabs div").removeClass(this.ACTIVE_TAB_CLASS),b.addClass(this.ACTIVE_TAB_CLASS),b.html(this.tabs[a].title),b.show(),this.$msgsList.html(""),this._setLoadingState(),this.currentActiveTabTitle=this.tabs[a].target},render:function(){return this},_openDialog:function(a){a.userId?(this.tabs["private"]={target:a.userId,title:a.userName},this.currentActiveTabName="private",this._setActiveTab("private")):a.roomId&&(this.tabs.room={target:a.roomId,title:this.locale.tabs.room},this.currentActiveTabName="room",this._setActiveTab("room"))},_closeDialog:function(){this.currentActiveTabName="public",this._setActiveTab("public"),this.$el.find('.tabs div[data-type="private"]').hide(),this.$el.find('.tabs div[data-type="room"]').hide()},_deleteMsg:function(a){var b,c;if(isNaN(+a)||"number"!=typeof+a){if(!$(a.target).hasClass(this.CLASS_DELETE_CHAT_MESSAGE))return;b=$(a.currentTarget),c=b.attr("data-msgId")}else c=a;return c&&this.manager.deleteMessage(parseFloat(c)),b||(b=this.$el.find('li[data-msgId="'+c+'"]').remove()),b?void b.remove():void console.warn("cannot find msg with  id",c,a)},_addOneMsg:function(a){if(a.target==this.currentActiveTabTitle){var b=this.tplMsg({msg:a,imgDel:this.images.del}),c=this.$messagesWrap[0].scrollHeight-this.$messagesWrap.height()-this.$messagesWrap.scrollTop()<this.SCROLL_VAL;this.manager.last[a.target]&&this.manager.last[a.target].d==a.d||this.$msgsList.append(this.tplDay(a)),this.$msgsList.append(b),b=this.$el.find('li[data-msgId="'+a.time+'"]'),a.admin&&b.addClass(this.CLASS_ADMIN_MSG),b.addClass(this.CLASS_NEW_MSG),setTimeout(function(){this.$el.find('li[data-msgId="'+a.time+'"]').removeClass(this.CLASS_NEW_MSG)}.bind(this),2500),c&&this.$messagesWrap.scrollTop(this.$messagesWrap[0].scrollHeight)}},_preaddMsgs:function(a){if((!a||a.target==this.currentActiveTabTitle)&&(this._removeLoadingState(),a)){var b=this.$messagesWrap.scrollTop(),c=this.$messagesWrap[0].scrollHeight,d=this.$el.find('li[data-day-msgId="'+this.manager.first[a.target].time+'"]');d&&d.remove(),this.manager.first[a.target].d!=a.d&&this.$msgsList.prepend(this.tplDay(this.manager.first[a.target]));var e=this.tplMsg({msg:a,imgDel:this.images.del});this.$msgsList.prepend(e),this.$msgsList.prepend(this.tplDay(a)),e=this.$el.find('li[data-msgId="'+a.time+'"]'),a.admin&&e.addClass(this.CLASS_ADMIN_MSG),this.$messagesWrap.scrollTop(b+this.$messagesWrap[0].scrollHeight-c)}},_setLoadingState:function(){this.$msgsList.prepend(this.$spinnerWrap),this.$messagesWrap.addClass(this.CLASS_DISABLED)},_removeLoadingState:function(){this.$spinnerWrap.remove(),this.$messagesWrap.removeClass(this.CLASS_DISABLED)}});return h}),define("text!tpls/v6-settingsMain.ejs",[],function(){return'\r\n    <img class="closeIcon" src="<%= close %>">\r\n    <div class="settingsContainer">\r\n    <%= settings %>\r\n    </div>\r\n    <div >\r\n        <div class="confirmBtn">OK</div>\r\n    </div>\r\n'}),define("text!tpls/v6-settingsDefault.ejs",[],function(){return'<p>Настройки игры</p>\r\n<div>\r\n    <div class="option">\r\n        <label><input type="checkbox" name="sounds">\r\n            Включить звук</label>\r\n    </div>\r\n    <div class="option">\r\n        <label><input type="checkbox" name="disableInvite">\r\n            Запретить приглашать меня в игру</label>\r\n    </div>\r\n</div>\r\n'}),define("views/settings",["underscore","backbone","text!tpls/v6-settingsMain.ejs","text!tpls/v6-settingsDefault.ejs"],function(a,b,c,d){var e=b.View.extend({tagName:"div",id:"v6-settings",tplMain:a.template(c),tplDefault:a.template(d),events:{"click .closeIcon":"save","change input":"changed","click .confirmBtn":"save"},initialize:function(b){this.client=b,this.images=b.opts.images,this.changedProperties=[],this.$el.html(this.tplMain({close:this.images.close,settings:b.opts.settingsTemplate?a.template(b.opts.settingsTemplate)():this.tplDefault()})),this.listenTo(b,"login",this.load.bind(this)),$("body").append(this.$el),this.$el.hide(),this.$el.draggable()},changed:function(a){var b=$(a.target),c=b.prop("type"),d=b.prop("name"),e="radio"==c?b.val():b.prop("checked"),f=(this.client.settings,this.client.defaultSettings);
f.hasOwnProperty(d)?(console.log("settings; changed",{property:d,value:e,type:c}),-1==this.changedProperties.indexOf(d)&&this.changedProperties.push(d),this.client._onSettingsChanged({property:d,value:e,type:c})):console.warn("settings;","default settings does not have property",d)},save:function(){this.$el.hide(),this.isClosed=!0;var a,b,c=this.client.defaultSettings,d=this.client.settings;if(0==this.changedProperties.length)return void console.log("settings; nothing changed");for(var e in c)c.hasOwnProperty(e)&&(a=d[e],"boolean"==typeof a?(b=this.$el.find("input[name="+e+"]"),a=b.prop("checked")):(b=this.$el.find("input[name="+e+"]:checked"),a=b.val()),b?(console.log("settings; save",e,a,b.prop("type")),d[e]=a):console.error("settings;","input element not found! ",e));this.client.saveSettings()},load:function(){this.changedProperties=[];var a,b,c=this.client.defaultSettings,d=this.client.settings;for(var e in c)c.hasOwnProperty(e)&&(a=d[e],b=this.$el.find("boolean"==typeof a?"input[name="+e+"]":"input[name="+e+"][value="+a+"]"),b?(console.log("settings; load",e,a,b.prop("type")),b.prop("checked",!!a)):console.error("settings;","input element not found! ",e,a))},cancel:function(){for(var a,b,c,d=this.client.settings,e=0;e<this.changedProperties.length;e++)c=this.changedProperties[e],b=d[c],a=this.$el.find("boolean"==typeof b?"input[name="+c+"]":"input[name="+c+"][value="+b+"]"),a?(console.log("settings; default",{property:c,value:b,type:a.prop("type")}),this.client._onSettingsChanged({property:c,value:b,type:a.prop("type")})):console.error("settings;","input element not found! ",c,b)},show:function(){this.$el.css({top:$(window).height()/2-this.$el.outerHeight()/2,left:$(window).width()/2-this.$el.outerWidth()/2}).show(),this.load()},getCurrentSettings:function(){var a,b,c=this.client.defaultSettings,d=$.extend({},this.client.settings);for(var e in c)c.hasOwnProperty(e)&&(a=d[e],"boolean"==typeof a?(b=this.$el.find("input[name="+e+"]"),a=b.prop("checked")):(b=this.$el.find("input[name="+e+"]:checked"),a=b.val()),d[e]=b?a:this.client.settings[e]);return d}});return e}),define("modules/views_manager",["views/user_list","views/dialogs","views/chat","../views/settings"],function(a,b,c,d){var e=function(a){this.client=a,this.userListView=null,this.dialogsView=b,this.chat=null,a.on("disconnected",function(){this.closeAll()}.bind(this))};return e.prototype.init=function(){this.userListView=new a(this.client),this.dialogsView.init(this.client),this.v6ChatView=new c(this.client),this.settingsView=new d(this.client),this.client.vkEnable&&this.userListView.addInviteFriendButton()},e.prototype.closeAll=function(){this.client.ratingManager.close(),this.client.historyManager.close(),this.settingsView.save()},e.prototype.showSettings=function(){this.client.isLogin&&this.settingsView.show()},e.prototype.showUserProfile=function(a,b){function c(){this.client.opts.blocks.profileId?$("#"+this.client.opts.blocks.profileId).append(this.$profileDiv):$("body").append(this.$profileDiv),this.client.historyManager.getProfileHistory(null,a,"v6-profileDiv"),this.showPanel(this.$profileDiv)}this.$profileDiv||(this.$profileDiv=$('<div id="v6-profileDiv">')),this.$profileDiv.addClass("v6-block-border"),this.$profileDiv.empty(),this.$profileDiv.append('<img  class="closeIcon" src="'+this.client.opts.images.close+'">'),this.$profileDiv.append("<div class='stats-area-wrapper'></div>"),this.$profileDiv.find(".stats-area-wrapper").append("<h4 style='color: #444;font-size: 10pt;padding-left: 5px; text-align: center;'>"+b+"</h4>"),this.closeAll(),window.LogicGame&&window.LogicGame.hidePanels&&window.ui?(this.$profileDiv.find("img").click(function(){window.LogicGame.hidePanels()}),$.post("/gw/profile/loadProfile.php",{sessionId:window._sessionId,userId:window._userId,playerId:a},function(a){window.LogicGame.hidePanels();var b=JSON.parse(a);return b.profile.playerName?(this.$profileDiv.find(".stats-area-wrapper").append(window.ui.userProfile.renderProfile(b.profile)),c.bind(this)(),void window.ui.userProfile.bindActions(b.profile)):void console.warn("bad profile",b.profile)}.bind(this))):(this.$profileDiv.find("img").click(function(){$(this.$profileDiv).hide()}.bind(this)),c.bind(this)())},e.prototype.showPanel=function(a){try{window.ui&&window.ui.showPanel?window.ui.showPanel({id:a.attr("id")}):a.show()}catch(b){console.error("views_manager;","show_panel",b)}$("html, body").animate({scrollTop:a.offset().top-350},500)},e}),function(){var a={};window.containsMat=function(b){return a.containsMat(b)},window.antimat=a,a.badPatternsTrue=[".*a.*p.*p.*4.*2.*1.*4.*7.*"],a.badPatterns=["^(о|а)н(о|а)нист.*","^лошар.*","^к(а|о)злина$","^к(о|а)зел$","^сволоч(ь|ъ|и|уга|ам|ами).*","^лох[уеыаоэяию].*",".*урод(ы|у|ам|ина|ины).*",".*бля(т|д).*",".*гандо.*","^м(а|о)нд(а|о).*",".*сперма.*",".*[уеыаоэяию]еб$","^сучк(а|у|и|е|ой|ай).*","^придур(ок|ки).*","^д(е|и)би(л|лы).*","^сос(ать|и|ешь|у)$","^залуп.*","^муд(е|ил|о|а|я|еб).*",".*шалав(а|ы|ам|е|ами).*",".*пр(а|о)ст(и|е)т(у|е)тк(а|и|ам|е|ами).*",".*шлюх(а|и|ам|е|ами).*",".*ху(й|и|я|е|л(и|е)).*",".*п(и|е|ы)зд.*","^бл(я|т|д).*","(с|сц)ук(а|о|и|у).*","^еб.*",".*(д(о|а)лб(о|а)|разъ|разь|за|вы|по)ебы*.*",".*пид(а|о|е)р.*",".*хер.*","идиот","коз(е|ё)л","п(и|е)дрила","лошара","уе(бок|бан)","сучка","отсоси","педик","лесбиянк.*","козлы","говно","жопа","гнидовский","обоссал.*"],a.goodPatterns=[".*психу.*",".*плох.*",".*к(о|а)манд.*",".*истр(е|и)блять.*",".*л(о|а)х(о|а)трон.*",".*(о|а)ск(о|а)рблять.*","хул(е|и)ган",".*м(а|о)нд(а|о)рин.*",".*р(а|о)ссл(а|о)блять.*",".*п(о|а)тр(е|и)блять.*",".*@.*\\.(ру|сом|нет)$"],a.goodWords=["дезмонда","застрахуйте","одномандатный","подстрахуй","психуй"],a.letters={a:"а",b:"в",c:"с",e:"е",f:"ф",g:"д",h:"н",i:"и",k:"к",l:"л",m:"м",n:"н",o:"о",p:"р",r:"р",s:"с",t:"т",u:"у",v:"в",x:"х",y:"у",w:"ш",z:"з","ё":"е",6:"б",9:"д"},a.containsMat=function(b){if(a.isInBadTruePatterns(b))return!0;b=a.cleanBadSymbols(b.toLowerCase());for(var c=b.split(" "),d=0;d<c.length;d++){var e=a.convertEngToRus(c[d]);if((!a.isInGoodWords(e)||!a.isInGoodPatterns(e))&&a.isInBadPatterns(e))return!0}return a.containsMatInSpaceWords(c)?!0:!1},a.convertEngToRus=function(b){for(var c=0;c<b.length;c++)for(var d in a.letters)b.charAt(c)==d&&(b=b.substring(0,c)+a.letters[d]+b.substring(c+1,b.length));return b},a.cleanBadSymbols=function(a){return a.replace(/[^a-zA-Zа-яА-Яё0-9\s]/g,"")},a.isInGoodWords=function(b){for(var c=0;c<a.goodWords.length;c++)if(b==a.goodWords[c])return!0;return!1},a.isInGoodPatterns=function(b){for(var c=0;c<a.goodPatterns.length;c++){var d=new RegExp(a.goodPatterns[c]);if(d.test(b))return!0}return!1},a.isInBadTruePatterns=function(b){for(var c=0;c<a.badPatternsTrue.length;c++){var d=new RegExp(a.badPatternsTrue[c]);if(d.test(b))return!0}return!1},a.isInBadPatterns=function(b){for(var c=0;c<a.badPatterns.length;c++){var d=new RegExp(a.badPatterns[c]);if(d.test(b))return!0}return!1},a.containsMatInSpaceWords=function(b){for(var c=a.findSpaceWords(b),d=0;d<c.length;d++){var e=a.convertEngToRus(c[d]);if(a.isInBadPatterns(e))return!0}return!1},a.findSpaceWords=function(a){for(var b=[],c="",d=0;d<a.length;d++){var e=a[d];e.length<=3?c+=e:c.length>=3&&(b.push(c),c="")}return b},a.addBadPattern=function(b){a.badPatterns.push(b)},a.addGoodPattern=function(b){a.goodPatterns.push(b)},a.addGoodWord=function(b){a.goodWords.push(b)}}(),define("antimat",function(){}),define("modules/chat_manager",["EE","antimat"],function(a){var b=function(a){this.client=a,this.first={},this.last={},this.fullLoaded={},this.messages={},this.current=a.game,this.currentType="public",this.MSG_COUNT=10,this.MSG_INTERVBAL=1500,a.on("login",this.onLogin.bind(this)),a.on("relogin",this.onLogin.bind(this)),a.gameManager.on("game_start",function(a){if(this.client.opts.showSpectators&&this.openDialog(a.id,"room",!0),a.isPlayer)for(var b=0;b<a.players.length;b++)a.players[b].isPlayer||this.openDialog(a.players[b].userId,a.players[b].userName)}.bind(this)),a.gameManager.on("game_leave",function(a){if(this.client.opts.showSpectators&&this.closeDialog(a.id,"room"),a.isPlayer)for(var b=0;b<a.players.length;b++)a.players[b].isPlayer||this.closeDialog(a.players[b].userId)}.bind(this)),a.on("disconnected",function(){})};return b.prototype=new a,b.initMessage=function(a,c,d){a.userData[d]&&(a.rank=a.userData[d].rank),(!a.rank||a.rank<1)&&(a.rank="—"),a.target==c.userId&&(a.target=a.userId),a.admin&&(a.rank="",a.userId=0,a.userName="Админ"),a.date=new Date(a.time);var e=a.date.getHours(),f=a.date.getMinutes();return 10>e&&(e="0"+e),10>f&&(f="0"+f),a.t=e+":"+f,a.d=a.date.getDate()+" "+b.months[a.date.getMonth()]+" "+a.date.getFullYear(),a},b.months=["Января","Февраля","Марта","Апреля","Мая","Июня","Июля","Августа","Сентября","Октября","Ноября","Декабря"],b.prototype.onLogin=function(){this.first={},this.last={},this.fullLoaded={},this.messages={},this.current=this.client.game,this.client.viewsManager.v6ChatView.setPublicTab(this.client.game),this.loadMessages()},b.prototype.onMessage=function(a){var c,d,e=a.data,f=this.client.getPlayer();switch(console.log("chat_manager;","message",a),a.type){case"message":a=b.initMessage(e,f,this.client.currentMode),this.first[a.target]||(this.first[a.target]=a),this.messages[a.target]||(this.messages[a.target]=[]),d=this.messages[a.target],d.push(a),d.length>100&&d.shift(),this.emit("message",a),this.last[a.target]=a,this.client.getUser(a.target)&&a.target!=this.current&&this.openDialog(a.userId,a.userName);break;case"load":if(!e.length||e.length<1)return this.fullLoaded[this.current]=!0,void this.emit("load",null);for(a=b.initMessage(e[0],f,this.client.currentMode),this.messages[a.target]||(this.messages[a.target]=[]),d=this.messages[a.target],c=0;c<e.length;c++)this.onMessageLoad(b.initMessage(e[c],f,this.client.currentMode),d);break;case"ban":this.ban=a.data,this.emit("show_ban",a.data)}},b.prototype.sendMessage=function(a,b,c,d){if(this.ban)return void this.emit("show_ban",this.ban);if(window.containsMat(a))return void console.warn("chat_manager; censored text",a);if(this.lastMessageTime&&Date.now()-this.lastMessageTime<this.MSG_INTERVBAL)return void console.warn("chat_manager; many messages in the same time");a=a.replace(/слава.*укра[иiії]н[иеіiї]/gim,"Слава СССР"),a=a.replace(/героям.*слава/gim,"Вам Слава"),this.lastMessageTime=Date.now();var e={text:a};d&&(e.admin=!0),b||(e.target=this.current),c=c||this.currentType,console.log("chat_manager;","send message",a,b,c,d),this.client.send("chat_manager","message","server",e)},b.prototype.loadMessages=function(a,b,c,d){return d=d||this.currentType,this.fullLoaded[this.current]?(console.log("chat_manager;","all messages loaded!",a,b,this.first),void this.emit("load",null)):(a=a||this.MSG_COUNT,c||(c=this.current),b=b||(this.first[c]?this.first[c].time:null),console.log("chat_manager;","loading messages",a,b,this.first,d),void this.client.send("chat_manager","load","server",{count:a,time:b,target:c,type:d}))},b.prototype.onMessageLoad=function(a,b){b&&b.length<100&&b.unshift(a),this.first[a.target]||(this.first[a.target]=a),this.last[a.target]||(this.last[a.target]=a),this.emit("load",a),this.first[a.target]=a},b.prototype.openDialog=function(a,b,c){this.current=a,c?(this.currentType="room",this.emit("open_dialog",{roomId:a})):(this.currentType="private",this.emit("open_dialog",{userId:a,userName:b})),this.loadCachedMessages(a)},b.prototype.closeDialog=function(a){this.currentType="public",this.emit("close_dialog",a||this.current),this.loadCachedMessages(this.client.game)},b.prototype.loadCachedMessages=function(a,b){if(this.current=a,this.currentType=b||this.currentType,this.first[a]=this.last[a]=null,this.messages[a]&&this.messages[a].length>0)for(var c=this.messages[a].length-1;c>=0;c--)this.onMessageLoad(this.messages[a][c]);this.messages[a]&&this.messages[a].length>0&&this.messages[a].length<this.MSG_COUNT?this.loadMessages(this.MSG_COUNT,this.messages[a][0].time,a):this.loadMessages(this.MSG_COUNT,null,a)},b.prototype.banUser=function(a,b,c){console.log("chat_manager;","banUser",a,b,c),this.client.send("chat_manager","ban","server",{userId:a,days:b,reason:c})},b.prototype.deleteMessage=function(a){console.log("chat_manager;","deleteMessage",a),this.client.send("chat_manager","delete","server",{time:a})},b}),define("text!tpls/v6-historyMain.ejs",[],function(){return'<div id="v6-history" class="v6-block-border">\r\n    <div class="historyHeader">\r\n        <div class="historyFilter">\r\n            <input type="text" placeholder="<%= locale.placeholder %>" id="historyAutoComplete" value="">\r\n            <div class="delete" style="background-image: url(<%= imgDel %>)"></div>\r\n        </div>\r\n        <img class="closeIcon" src="<%= close %>" title="<%= locale.close %>">\r\n    </div>\r\n    <div class="historyWrapper">\r\n        <table class="historyTable">\r\n            <thead>\r\n                <tr></tr>\r\n            </thead>\r\n            <tbody>\r\n            </tbody>\r\n        </table>\r\n        <div id="showMore"><%= locale.showMore%></div>\r\n        <div class="noHistory"><%= locale.noHistory %></div>\r\n        <div class="loading"><img src="<%= spin %>"></div>\r\n    </div>\r\n</div>'}),define("text!tpls/v6-historyHeaderTD.ejs",[],function(){return'<td class="sessionHeader historyDate" rowspan="<%= rows %>"> <%= date %> </td>\r\n<td class="sessionHeader historyName" rowspan="<%= rows %>">\r\n    <span class="userName" data-userid="<%= userId %>"><%= userName %></span>\r\n    <span class="userRank">(<%= rank %>)</span>\r\n    <span class="userScore"><%= score %></span>\r\n    <div class="eloDiff <%= (eloDiff>-1?\'diffPositive\':\'diffNegative\')%>"><%= eloDiff ===\'\'?\'\':(eloDiff>-1?\'+\'+eloDiff:eloDiff)%></div>\r\n</td>'}),define("text!tpls/v6-historyTH.ejs",[],function(){return'<th colspan="<%= colspan %>" title="<%= title %>"><%= value %></th>'}),define("text!tpls/v6-historyTR.ejs",[],function(){return'<tr class="<%= trclass %>" data-id="<%= id %>" ><%= value %></tr>'}),define("text!tpls/v6-ratingTab.ejs",[],function(){return'<span class="unactiveLink"  data-idtab="<%= id %>"><%= title %></span>&nbsp;&nbsp;'}),define("views/history",["underscore","backbone","text!tpls/v6-historyMain.ejs","text!tpls/v6-historyHeaderTD.ejs","text!tpls/v6-historyTH.ejs","text!tpls/v6-historyTR.ejs","text!tpls/v6-ratingTab.ejs"],function(a,b,c,d,e,f,g){var h=b.View.extend({tagName:"div",id:"v6History",tplMain:a.template(c),tplHeadTD:a.template(d),tplTD:function(a){return"<td>"+a+"</td>"},tplTH:a.template(e),tplTR:a.template(f),tplTRpenalty:function(a,b,c){return'<tr class="historyPenalty"><td>'+a+'</td><td colspan="'+c+'">'+b+"</td></tr>"},tplTab:a.template(g),events:{"click .closeIcon":"close","click .historyTable tr":"trClicked","click .historyTable .userName":"userClicked","click .historyHeader span":"tabClicked","click #showMore":"showMore","keyup #historyAutoComplete":"filterChanged","click .delete":"clearFilter"},initialize:function(a,b){this.conf=a,this._manager=b,this.locale=b.client.locale.history,this.tabs=a.tabs,this.columns=a.columns,this.$el.html(this.tplMain({close:a.images.close,imgDel:a.images.del,spin:a.images.spin,locale:this.locale})),this.$head=this.$el.find(".historyHeader"),this.$titles=$(this.$el.find(".historyTable thead tr")[0]),this.$tbody=$(this.$el.find(".historyTable tbody")[0]),this.$noHistory=$(this.$el.find(".noHistory")),this.$showMore=$(this.$el.find("#showMore")),this.$filter=$(this.$el.find("#historyAutoComplete")),this.ACTIVE_TAB="activeLink",this.UNACTIVE_TAB="unactiveLink",this.WIN_CLASS="historyWin",this.LOSE_CLASS="historyLose",this.DRAW_CLASS="historyDraw",this.SELECTED_CLASS="historySelected",this.renderTabs(),this.renderHead(),this.isClosed=!1},trClicked:function(a){if(!$(a.target).hasClass("userName")){var b=$(a.currentTarget).attr("data-id");this.$el.find("."+this.SELECTED_CLASS).removeClass(this.SELECTED_CLASS),$(a.currentTarget).addClass(this.SELECTED_CLASS),this._manager.getGame(b)}},userClicked:function(a){var b=$(a.currentTarget).attr("data-userid"),c=$(a.currentTarget).html();this._manager.client.onShowProfile(b,c)},tabClicked:function(a){var b=$(a.currentTarget).attr("data-idtab");this.setActiveTab(b),this._manager._getHistory(b,null,!1)},filterChanged:function(a){"keyup"===a.type&&(13==a.keyCode||0==a.target.value.length)&&this._manager._getHistory(this.currentTab.id,null,!1)},clearFilter:function(){this.setFilter(""),this._manager._getHistory(this.currentTab.id,null,!1)},close:function(){this.$el.hide(),this.isClosed=!0,this.setFilter("")},showMore:function(){this._manager._getHistory(this.currentTab.id,null,!0)},renderTabs:function(){for(var a=this.tabs.length-1;a>=0;a--)this.$head.prepend(this.tplTab(this.tabs[a])),this.setActiveTab(this.tabs[0].id);this.tabs&&0!=this.tabs.length||(this.currentTab={id:this._manager.client.currentMode})},renderHead:function(){for(var a=0;a<this.columns.length;a++)this.$titles.append(this.tplTH({title:this.columns[a].title,value:this.columns[a].title,colspan:this.columns[a].dynamic?2:1}))},renderHistory:function(a,b){for(var c=0;c<b.length;c++)this.renderSession(a,b[c])},renderSession:function(a,b){var c,d;b.penalty&&this.$tbody.append(this.tplTRpenalty(b.date,b.text,this.columns.length));for(var e=0;e<b.length;e++)c=this.renderRow(a,b[e],0==e,b.length),d="draw"==b[e].result?this.DRAW_CLASS:"win"==b[e].result?this.WIN_CLASS:this.LOSE_CLASS,this.$tbody.append(this.tplTR({title:b[e].result,trclass:d,id:b[e].id,value:c}))},renderRow:function(a,b,c,d){var e,f="";c&&(f=this.tplHeadTD({rows:d,date:b.date,userId:b.opponent.userId,userName:b.opponent.userName,rank:b.opponent[a].rank,eloDiff:d>1?b.elo.diff:"",score:b.gameScore}));for(var g=2;g<this.columns.length;g++)e=b[this.columns[g].source],void 0==e&&(e=this.columns[g].undef),this.columns[g].dynamic?(f+=this.tplTD((e.dynamic>-1&&""!==e.dynamic?"+":"")+e.dynamic),f+=this.tplTD(e.value)):f+=this.tplTD(e);return f},render:function(a,b,c,d){return this.$el.show(),this.setActiveTab(a),this.$filter.val().length>0?this.$filter.parent().find(".delete").show():this.$filter.parent().find(".delete").hide(),c===!0&&this.$el.find(".closeIcon").hide(),c===!1&&this.$el.find(".closeIcon").show(),d?this.$showMore.show():this.$showMore.hide(),b?(this.clearHistory(),0==b.length&&this.$noHistory.show(),this.$el.find(".loading").hide(),console.log("render history",b),this.renderHistory(a,b)):(this.isClosed=!1,this.$el.find(".loading").show(),this.$noHistory.hide()),this},clearHistory:function(){this.$tbody.children().remove()},setActiveTab:function(a){if(a&&this.tabs&&!(this.tabs.length<2))for(var b=0;b<this.tabs.length;b++)this.tabs[b].active=!1,this.tabs[b].id!=a?this.$head.find('span[data-idtab="'+this.tabs[b].id+'"]').removeClass(this.ACTIVE_TAB).addClass(this.UNACTIVE_TAB):(this.$head.find('span[data-idtab="'+this.tabs[b].id+'"]').removeClass(this.UNACTIVE_TAB).addClass(this.ACTIVE_TAB),this.currentTab=this.tabs[b])},setFilter:function(a){this.$filter.val(a)},getFilter:function(){return this.$filter.val()}});return h}),define("modules/history_manager",["EE","views/history","instances/turn","instances/game_event"],function(a,b,c,d){function e(a){var b=g.months,c=new Date(a),d=c.getDate(),e=b[c.getMonth()],f=c.getFullYear();return 10>d&&(d="0"+d),d+" "+e+" "+f}function f(a){var b=new Date(a),c=b.getHours(),d=b.getMinutes();return 10>c&&(c="0"+c),10>d&&(d="0"+d),c+":"+d}var g,h=function(a){this.client=a,g=a.locale.history,this.conf={tabs:[],subTabs:[],columns:[{id:"date",source:"date",title:g.columns.date},{id:"opponent",source:"opponent",title:g.columns.opponent},{id:"time",source:"time",title:g.columns.time},{id:"number",source:"number",title:g.columns.number},{id:"elo",source:"elo",title:g.columns.elo,dynamic:!0,startValue:1600}]},"function"==typeof a.opts.initHistory&&(this.conf=a.opts.initHistory(this.conf,this.client)),this.conf.images=a.opts.images,this.$container=$(a.opts.blocks.historyId?"#"+a.opts.blocks.historyId:"body"),this.isCancel=!1,this.userId=!1,this.currentMode=!1,this.maxCount=100,this.count=0,this.history=[],a.on("disconnected",function(){})};return h.prototype=new a,h.prototype.init=function(){if(this.conf.tabs=[],this.client.modes.length>1)for(var a=0;a<this.client.modes.length;a++)this.conf.tabs.push({id:this.client.modes[a],title:this.client.getModeAlias(this.client.modes[a])});this.historyView&&this.historyView.$el&&(this.historyView.$el.remove(),this.historyView.remove()),this.historyView=new b(this.conf,this)},h.prototype.onMessage=function(a){var b=a.data;switch(console.log("history_manager;","message",a),a.type){case"history":this.onHistoryLoad(b.mode,b.history,b.penalties,b.userId);break;case"game":this.onGameLoad(b.mode,b.game)}},h.prototype.onHistoryLoad=function(a,b,c,d){if(console.log("history_manager;","history load",d,b,c),c=c||[],!this.historyView.isClosed){var e,f=[];this.userId=d,this.currentMode=a,this.history=this.history.concat(b);var g=this.history.length,h=this.client.userList.getUser(d);h&&(g=h[a].games);for(var i=this.history.length-1;i>-1;i--){if(i==this.history.length-1){for(var j=0;j<c.length;j++)if(e=c[j],e.time<=this.history[i].timeEnd){f.push(this.formatPenaltyRow(e));break}}else for(j=c.length-1;j>-1;j--)e=c[j],e.time<this.history[i].timeEnd&&e.time>=this.history[i+1].timeEnd&&f.unshift(this.formatPenaltyRow(e));for(this.formatHistoryRow(this.history[i],f,a,g-i,d),j=c.length-1;j>-1;j--)e=c[j],0==i&&e.time>=this.history[i].timeEnd&&f.unshift(this.formatPenaltyRow(e))}this.$container.append(this.historyView.render(a,f,null,b&&b.length==this.maxCount).$el)}},h.prototype.onGameLoad=function(a,b){function e(a){for(var b=0;b<h.length;b++)if(h[b].userId==a)return h[b];return null}function f(a){if(a.length)for(var b=0;b<a.length;b++)a[b]=f(a[b]);else a.type||"timeout"==a.action?(a.user=e(a.user)||void 0,a.nextPlayer=e(a.nextPlayer)||void 0,a.target=e(a.target)||void 0,a=new d(a)):(a.nextPlayer=e(a.nextPlayer)||void 0,a=new c(a,i,a.nextPlayer)),a.nextPlayer&&(i=a.nextPlayer);return a}if(console.log("history_manager;","game load",b,"time:",Date.now()-this.startTime),b){b.history="["+b.history+"]",b.history=b.history.replace(new RegExp("@","g"),","),b.history=JSON.parse(b.history),b.initData=JSON.parse(b.initData),b.userData=JSON.parse(b.userData);var g,h=[];for(g=0;g<b.players.length;g++)h.push(this.client.userList.createUser(b.userData[b.players[g]]));if(h.length!=h.length)throw new Error("UserData and players are different!");if(b.players=h,this.client.opts.newGameFormat){b.initData.first=e(b.initData.first),b.winner=e(b.winner);var i=b.initData.first,j=[];for(g=0;g<b.history.length;g++)j=j.concat(f(b.history[g]));b.history=j}console.log("history_manager;","game parsed",b)}this.isCancel||this.emit("game_load",b)},h.prototype.formatHistoryRow=function(a,b,c,d,g){var h,i,j,k={win:0,lose:0,id:a._id,number:d},l=JSON.parse(a.userData);0==b.length?(h=[],i=null):(h=b[0],i=h[0]),j=g==a.players[0]?a.players[1]:a.players[0];for(var m=0;m<this.conf.columns.length;m++){var n=this.conf.columns[m];-1==["date","opponent","time","number","elo"].indexOf(n.id)&&(k[n.source]=l[g][c][n.source])}k.opponent=l[j],k.date=e(a.timeEnd),k.time=f(a.timeEnd),a.winner?a.winner==g?(k.result="win",k.win++):(k.result="lose",k.lose++):k.result="draw",i&&i.date==k.date&&i.opponent.userId==k.opponent.userId&&(k.win+=i.win,k.lose+=i.lose),k.gameScore=k.win+":"+k.lose,k.elo={value:l[g][c].ratingElo},k.elo.dynamic=i?k.elo.value-i.elo.value:"",i&&i.date==k.date&&i.opponent.userId==k.opponent.userId?(k.elo.diff=i.elo.diff+k.elo.dynamic,h.unshift(k)):(k.elo.diff=k.elo.dynamic||0,h=[],h.unshift(k),b.unshift([]),b[0]=h)},h.prototype.formatPenaltyRow=function(a){var b={penalty:!0,time:a.time,date:e(a.time),type:a.type,text:"function"==typeof this.client.opts.generatePenaltyText?this.client.opts.generatePenaltyText(a):"штраф в "+Math.abs(a.value)+" очков",value:a.value,elo:{value:a.ratingElo}};return console.log(b),b},h.prototype.getHistory=function(a){if(this.client.isLogin){this.historyView.clearHistory();var b=this.client.gameManager;if(this.client.gameManager.inGame()){var c=b.currentRoom.players[0].isPlayer?b.currentRoom.players[1].userName:b.currentRoom.players[0].userName;c&&this.historyView.setFilter(c)}this.$container=$(this.client.opts.blocks.historyId?"#"+this.client.opts.blocks.historyId:"body"),this.userId=this.client.getPlayer().userId,this._getHistory(a,!1),this.client.viewsManager.showPanel(this.historyView.$el)}},h.prototype.getProfileHistory=function(a,b,c){if(this.client.isLogin){if(this.historyView.clearHistory(),this.historyView.setFilter(""),c&&(this.$container=$("#"+c)),!this.$container)throw new Error("wrong history container id! "+c);this.userId=b,this._getHistory(a,!0),this.historyView.delegateEvents()}},h.prototype._getHistory=function(a,b,c){c||(this.count=0,this.history=[]),a=a||this.client.currentMode,this.$container.append(this.historyView.render(a,!1,b).$el),this.client.send("history_manager","history","server",{mode:a,userId:this.userId,count:this.maxCount,offset:this.history.length,filter:this.historyView.getFilter()})},h.prototype.getGame=function(a,b,c){b=b||this.userId||this.client.getPlayer().userId,c=c||this.currentMode||this.client.currentMode,this.isCancel=!1,this.client.send("history_manager","game","server",{mode:c,id:a,userId:b}),this.startTime=Date.now()},h.prototype.close=function(){this.historyView&&this.historyView.close()},h}),define("text!tpls/v6-ratingMain.ejs",[],function(){return'<div id="v6-rating" class="v6-block-border">\r\n    <img class="closeIcon" src="<%= close %>" title="<%= locale.close %>">\r\n    <div>\r\n        <!-- rating filter panel -->\r\n        <div class="filterPanel">\r\n            <div style="margin-left: 8px;">\r\n\r\n            </div>\r\n        </div>\r\n        <div class="loading"><img src="<%= spin %>"></div>\r\n        <!-- rating table -->\r\n        <table class="ratingTable" cellspacing="0">\r\n            <thead>\r\n                <tr class="headTitles">\r\n\r\n                </tr>\r\n                <tr class="headIcons">\r\n\r\n                </tr>\r\n            </thead>\r\n            <tbody class="ratingTBody">\r\n\r\n            </tbody>\r\n        </table>\r\n\r\n        <!-- div show more -->\r\n        <div class="chat-button chat-post" id="ratingShowMore">\r\n            <span><%= locale.showMore %></span>\r\n        </div>\r\n\r\n        <!-- div bottom buttons -->\r\n        <div class="footButtons">\r\n            <div style="float:left"><span class="activeLink" id="jumpTop">[<%= locale.jumpTop%>]</span></div>\r\n            <div style="float:right"><span class="activeLink" id="closeRatingBtn">[<%= locale.close %>]</span> </div>\r\n        </div>\r\n    </div>\r\n</div>'}),define("text!tpls/v6-ratingTD.ejs",[],function(){return'<td data-idcol="<%= id %>" class="rating<%= id %>"><div><%= value %><sup class="greenSup"><%= sup %></sup></div></td>'}),define("text!tpls/v6-ratingTH.ejs",[],function(){return'<th data-idcol="<%= id %>" class="ratingTH<%= id %>" title="<%= title %>"><%= value %></th>'}),define("text!tpls/v6-ratingTR.ejs",[],function(){return'<tr class="<%= trclass %>" data-userId="<%= userId %>" data-userName="<%= userName %>"><%= value %></tr>'}),define("text!tpls/v6-ratingSearch.ejs",[],function(){return'<div style="padding-bottom:2px; position: relative;">\r\n    <div style="float:left;margin-top:4px;"><%= locale.search %>:</div>\r\n    <input type="text" placeholder="<%= locale.placeholder %>" id="ratingAutoComplete" value="">\r\n    <div class="delete" style="background-image: url(<%= imgDel %>)"></div>\r\n</div>'}),define("text!tpls/v6-ratingPhoto.ejs",[],function(){return'<div style="float:right;margin-top:2px;">\r\n    <a href="<%= photo %>" rel="lightbox" data-lightbox="<%= photo %>"><img src="i/camera.png"></a>\r\n</div>'}),define("text!tpls/v6-ratingUser.ejs",[],function(){return'<span class="userName" data-userid="<%= userId %>"><%= userName %></span>'}),define("views/rating",["underscore","backbone","text!tpls/v6-ratingMain.ejs","text!tpls/v6-ratingTD.ejs","text!tpls/v6-ratingTH.ejs","text!tpls/v6-ratingTR.ejs","text!tpls/v6-ratingTab.ejs","text!tpls/v6-ratingSearch.ejs","text!tpls/v6-ratingPhoto.ejs","text!tpls/v6-ratingUser.ejs"],function(a,b,c,d,e,f,g,h,i,j){var k=b.View.extend({tagName:"div",id:"v6Rating",tplMain:a.template(c),tplTD:a.template(d),tplTH:a.template(e),tplTR:a.template(f),tplTab:a.template(g),tplSearch:a.template(h),tplUser:a.template(j),tplPhoto:a.template(i),events:{"click .closeIcon":"close","click #closeRatingBtn":"close","click .headTitles th":"thClicked","click .headIcons th":"thClicked","click .filterPanel span":"tabClicked","click .ratingTable .userName":"userClicked","click #ratingShowMore":"showMore","keyup #ratingAutoComplete":"filterChanged","click .delete":"clearFilter","click #jumpTop":"scrollTop"},thClicked:function(a){for(var b=$(a.currentTarget).attr("data-idcol"),c=0;c<this.columns.length;c++)if(this.columns[c].id==b&&this.columns[c].canOrder){this.setColumnOrder(b),console.log("log; rating col clicked",this.columns[c]),this.getRatings();break}},tabClicked:function(a){for(var b=$(a.currentTarget).attr("data-idtab"),c=0;c<this.subTabs.length;c++)if(this.subTabs[c].id==b)return this.setActiveSubTab(b),void this.getRatings()},userClicked:function(a){var b=$(a.currentTarget).attr("data-userid"),c=$(a.currentTarget).html();this.manager.client.onShowProfile(b,c)},showMore:function(){this.getRatings(!0)},filterChanged:function(a){"keyup"===a.type&&(13==a.keyCode||0==a.target.value.length)&&this.getRatings()},clearFilter:function(){this.$filter.val(""),this.getRatings()},getRatings:function(a){this.manager.getRatings(this.currentSubTab.id,this.currentCollumn.id,this.currentCollumn.order<0?"desc":"asc",this.$filter.val(),!!a)},scrollTop:function(){$("html,body").animate({scrollTop:this.$el.offset().top},300)},initialize:function(a,b){this.conf=a,this.manager=b,this.locale=b.client.locale.rating,this.tabs=a.tabs,this.subTabs=a.subTabs,this.columns=a.columns,this.$el.html(this.tplMain({close:this.conf.images.close,spin:this.conf.images.spin,locale:this.locale})),this.$tabs=$(this.$el.find(".filterPanel").children()[0]),this.$titles=this.$el.find(".headTitles"),this.$icons=this.$el.find(".headIcons"),this.$head=this.$icons.parent(),this.$tbody=$(this.$el.find(".ratingTable tbody")[0]),this.$showMore=$(this.$el.find("#ratingShowMore")),this.NOVICE='<span style="color: #C42E21 !important;">'+this.locale.novice+"</span>",this.IMG_BOTH='<img src="'+a.images.sortBoth+'">',this.IMG_ASC='<img src="'+a.images.sortAsc+'">',this.IMG_DESC='<img src="'+a.images.sortDesc+'">',this.ACTIVE_TAB="activeLink",this.UNACTIVE_TAB="unactiveLink",this.SORT="sorted",this.YOU=this.locale.you+":",this.HEAD_USER_CLASS="headUser",this.ACTIVE_CLASS="active",this.ONLINE_CLASS="online",this.USER_CLASS="user",this.renderTabs(),this.renderHead(),this.isClosed=!1},close:function(){this.$el.hide(),this.isClosed=!0},renderTabs:function(){for(var a in this.tabs)this.$tabs.append(this.tplTab(this.tabs[a])),this.setActiveTab(this.tabs[0].id);if(this.subTabs.length>1){this.$tabs.append("<br>");for(var a in this.subTabs)this.$tabs.append(this.tplTab(this.subTabs[a])),this.setActiveSubTab(this.subTabs[0].id)}},renderHead:function(){var a,b;for(var c in this.columns)a=this.columns[c],a.canOrder&&(a.order="ratingElo"==a.id?1:0),b={id:a.id,title:a.topTitle||"",value:a.title},this.$titles.append(this.tplTH(b)),b.value=a.canOrder?this.IMG_BOTH:"","rank"==a.id&&(b.value=""),"userName"==a.id&&(b.value=this.tplSearch({imgDel:this.conf.images.del,locale:this.locale})),this.$icons.append(this.tplTH(b));this.setColumnOrder("ratingElo"),this.$filter=$(this.$el.find("#ratingAutoComplete"))},renderRatings:function(a){var b;if(a.infoUser&&(b=a.infoUser,this.$head.append(this.tplTR({trclass:this.HEAD_USER_CLASS,userId:b.userId,userName:b.userName,value:this.renderRow(b,!0)}))),a.allUsers)for(var c=0;c<a.allUsers.length;c++){b=a.allUsers[c];
var d="";b.user&&(d+=this.USER_CLASS+" "),b.active?d+=this.ACTIVE_CLASS:b.online&&(d+=this.ONLINE_CLASS),this.$tbody.append(this.tplTR({trclass:d,userId:b.userId,userName:b.userName,value:this.renderRow(b)}))}},renderRow:function(a,b){for(var c,d="",e=0;e<this.columns.length;e++)null==a[this.columns[e].source]&&(a[this.columns[e].source]=this.columns[e].undef),c={id:this.columns[e].id,value:a[this.columns[e].source],sup:""},"function"==typeof this.columns[e].func&&(c.value=this.columns[e].func(c.value)),"userName"==c.id&&(c.value=this.tplUser({userName:a.userName,userId:a.userId})),b&&("rank"==c.id&&(c.value=this.YOU),"userName"==c.id&&(c.value+=" ("+(a.rank>0?a.rank:"-")+this.locale.place+")")),"userName"==c.id&&a.photo&&(c.value+=this.tplPhoto(a.photo)),d+=this.tplTD(c);return d},setActiveTab:function(a){for(var b=0;b<this.tabs.length;b++)this.tabs[b].active=!1,this.tabs[b].id!=a?this.$tabs.find('span[data-idtab="'+this.tabs[b].id+'"]').removeClass(this.ACTIVE_TAB).addClass(this.UNACTIVE_TAB):(this.$tabs.find('span[data-idtab="'+this.tabs[b].id+'"]').removeClass(this.UNACTIVE_TAB).addClass(this.ACTIVE_TAB),this.currentTab=this.tabs[b])},setActiveSubTab:function(a){for(var b=0;b<this.subTabs.length;b++)this.subTabs[b].active=!1,this.subTabs[b].id!=a?this.$tabs.find('span[data-idtab="'+this.subTabs[b].id+'"]').removeClass(this.ACTIVE_TAB).addClass(this.UNACTIVE_TAB):(this.$tabs.find('span[data-idtab="'+this.subTabs[b].id+'"]').removeClass(this.UNACTIVE_TAB).addClass(this.ACTIVE_TAB),this.currentSubTab=this.subTabs[b])},setColumnOrder:function(a,b){for(var c=2;c<this.columns.length;c++)this.columns[c].id!=a?(this.columns[c].order=0,this.$titles.find('th[data-idcol="'+this.columns[c].id+'"]').removeClass(this.SORT),this.$icons.find('th[data-idcol="'+this.columns[c].id+'"]').removeClass(this.SORT).html(this.columns[c].canOrder?this.IMG_BOTH:"")):(this.currentCollumn=this.columns[c],this.columns[c].order=b?"desc"==b?-1:1:this.columns[c].order<1?1:-1,this.$titles.find('th[data-idcol="'+this.columns[c].id+'"]').addClass(this.SORT),this.$icons.find('th[data-idcol="'+this.columns[c].id+'"]').addClass(this.SORT).html(this.columns[c].order>0?this.IMG_ASC:this.IMG_DESC))},render:function(a,b,c,d,e,f){if(this.$el.show(),this.setColumnOrder(c,d),this.$filter.val()&&this.$filter.val().length>0?this.$filter.parent().find(".delete").show():this.$filter.parent().find(".delete").hide(),f?this.$showMore.show():this.$showMore.hide(),b&&this.setActiveSubTab(b),a?(this.$el.find(".loading").hide(),this.$head.find("."+this.HEAD_USER_CLASS).remove(),e||this.$tbody.children().remove(),console.log("render ratings",a),this.renderRatings(a)):(this.isClosed=!1,this.$el.find(".loading").show()),this.manager.client.isAdmin&&!this.$tabs.find(".adminLink").length){$("<span>").html('<a href="/admin">Админка</a>').addClass("adminLink").appendTo(this.$tabs)}return this}});return k}),define("modules/rating_manager",["EE","views/rating"],function(a,b){function c(a){function b(a,b,c){for(a=""+a;a.length<b;)a=c+a;return a}var c=new Date(a),d=c.getDate(),e=c.getMonth()+1,f=(""+c.getFullYear()).substr(2,2);return b(d,2,"0")+"."+b(e,2,"0")+"."+f}var d,e=function(a){this.client=a,d=a.locale.rating,this.conf={tabs:[{id:"all_players",title:d.tabs.allPlayers}],subTabs:[],columns:[{id:"rank",source:"rank",title:d.columns.rank,canOrder:!1},{id:"userName",source:"userName",title:d.columns.userName,canOrder:!1},{id:"ratingElo",source:"ratingElo",title:d.columns.ratingElo,canOrder:!0},{id:"win",source:"win",title:d.columns.win,canOrder:!0},{id:"lose",source:"lose",title:d.columns.lose,canOrder:!1},{id:"dateCreate",source:"dateCreate",title:d.columns.dateCreate,canOrder:!0}]},"function"==typeof a.opts.initRating&&(this.conf=a.opts.initRating(this.conf,this.client)),this.conf.images=a.opts.images,this.$container=$(a.opts.blocks.ratingId?"#"+a.opts.blocks.ratingId:"body"),this.maxCount=500,this.count=0,a.on("disconnected",function(){})};return e.prototype=new a,e.prototype.init=function(){this.conf.subTabs=[];for(var a=0;a<this.client.modes.length;a++)this.conf.subTabs.push({id:this.client.modes[a],title:this.client.getModeAlias(this.client.modes[a])});this.ratingView&&this.ratingView.$el&&(this.ratingView.$el.remove(),this.ratingView.remove()),this.ratingView=new b(this.conf,this)},e.prototype.onMessage=function(a){var b=a.data;switch(console.log("rating_manager;","message",a),a.type){case"ratings":this.onRatingsLoad(b.mode,b.ratings,b.column,b.order)}},e.prototype.onRatingsLoad=function(a,b,c,d){var e=!1;if(!this.ratingView.isClosed){b.infoUser&&(b.infoUser=this.formatRatingsRow(a,b.infoUser,b.infoUser[a].rank));for(var f=0;f<b.allUsers.length;f++)this.filter||"ratingElo"!=c||"desc"!=d?this.client.opts.loadRanksInRating&&(e=b.allUsers[f][a].rank||!1):e=f+1+this.count,b.allUsers[f]=this.formatRatingsRow(a,b.allUsers[f],e);this.$container.append(this.ratingView.render(b,a,c,d,0!=this.count,b.allUsers.length==this.maxCount).$el),this.count+=b.allUsers.length}},e.prototype.formatRatingsRow=function(a,b,d){var e={userId:b.userId,userName:b.userName,photo:void 0};for(var f in b[a])e[f]=b[a][f];return e.rank=d!==!1?d:"",this.client.getPlayer()&&b.userId==this.client.getPlayer().userId&&(e.user=!0),this.client.userList.getUser(b.userId)&&(e.online=!0,this.client.userList.getUser(b.userId).isActive&&(e.active=!0)),e.percent=e.games>0?Math.floor(e.win/e.games*100):0,e.dateCreate=Date.now()-b.dateCreate<864e5?this.ratingView.NOVICE:c(b.dateCreate),e},e.prototype.getRatings=function(a,b,c,d,e){this.client.isLogin&&(e||(this.count=0),this.$container.append(this.ratingView.render(!1).$el),this.filter=d,this.client.send("rating_manager","ratings","server",{mode:a||this.client.currentMode,column:b,order:c,filter:d,count:this.maxCount,offset:this.count}),this.client.viewsManager.showPanel(this.ratingView.$el))},e.prototype.close=function(){this.ratingView&&this.ratingView.close()},e.prototype.testRatings={allUsers:[{userId:"95514",userName:"us_95514",dateCreate:1423486149906,mode1:{win:2,lose:0,draw:0,games:2,rank:1,ratingElo:1627},mode2:{win:1,lose:0,draw:0,games:1,rank:1,ratingElo:1615}},{userId:"93361",userName:"us_93361",dateCreate:1423486098554,mode1:{win:1,lose:0,draw:0,games:1,rank:2,ratingElo:1615},mode2:{win:0,lose:0,draw:0,games:0,rank:0,ratingElo:1600}},{userId:"99937",userName:"us_99937",dateCreate:1423486099570,mode1:{win:0,lose:3,draw:0,games:3,rank:3,ratingElo:1561},mode2:{win:0,lose:1,draw:0,games:1,rank:2,ratingElo:1586}}],infoUser:{userId:"99937",userName:"us_99937",dateCreate:1423486099570,mode1:{win:0,lose:3,draw:0,games:3,rank:3,ratingElo:1561},mode2:{win:0,lose:1,draw:0,games:1,rank:2,ratingElo:1586}}},e}),define("modules/sound_manager",["EE","underscore"],function(a,b){var c=function(a){this.client=a,this.soundsList=a.opts.sounds||{},this.sounds={},this.initSounds(),this.volume=1,this.sound=null,this.msAlerTimeBound=15e3,this.client.gameManager.on("game_start",function(a){a.isPlayer&&this._playSound("start")}.bind(this)),this.client.gameManager.on("turn",function(){this._playSound("turn")}.bind(this)),this.client.inviteManager.on("new_invite",function(){this._playSound("invite")}.bind(this)),this.client.gameManager.on("time",b.throttle(function(b){b.user==a.getPlayer()&&b.userTimeMS<=this.msAlerTimeBound&&b.userTimeMS>1e3&&this._playSound("timeout",.5+(this.msAlerTimeBound-b.userTimeMS)/this.msAlerTimeBound/2)}.bind(this),1e3))};c.prototype=new a,c.prototype.initSounds=function(){for(var a in this.soundsList)this.soundsList.hasOwnProperty(a)&&(this.sounds[a]=new d(this.soundsList[a],a))},c.prototype._playSound=function(a){this.sounds[a]&&this.sounds[a].enable&&this.playSound(a)},c.prototype.playSound=function(a,b){if(this.client.settings.sounds){if(b=b||this.volume,!this.sounds[a])return void console.error("sound_manager;","wrong sound id",a);this.sound&&this.sound.stop(),this.sound=this.sounds[a].play(b)}};var d=function(a,b){this.volume=a.volume||1,this.sound=document.createElement("audio"),this.sound.id="sound-"+b,this.sound.src=a.src,this.enable=a.enable!==!1,document.body.appendChild(this.sound)};return d.prototype.play=function(a){a*=this.volume,(0>a||a>1)&&(a=1);try{return this.sound.currentTime=0,this.sound.volume=a,this.sound.play(),this}catch(b){return console.error("sound;","sound play error",b),null}},d.prototype.stop=function(){try{this.sound.pause()}catch(a){console.error("sound;","sound stop error",a)}},c}),define("modules/admin_manager",["EE"],function(a){var b=function(a){this.client=a};return b.prototype=new a,b.prototype.onMessage=function(a){var b=a.data;switch(console.log("admin_manager;","message",a),a.type){case"message":this.client.viewsManager.dialogsView.showDialog(b,{},!0,!1,!1);break;case"enable_games":this.client.gameManager.enableGames=b.flag;break;case"reload":location.reload();break;case"get_config":console.log("admin;","config",b)}},b.prototype.send=function(a,b,c){this.client.send("admin",a,"server",{pass:c,data:b})},b}),define("text!localization/ru.JSON",[],function(){return'{\r\n  "name": "ru",\r\n  "userList":{\r\n    "tabs":{\r\n      "free":"Свободны",\r\n      "inGame":"Играют",\r\n      "spectators": "Смотрят"\r\n    },\r\n    "disconnected": {\r\n      "text": "Соединение с сервером отсутствует",\r\n      "button": "Переподключиться",\r\n      "status": "Загрузка.."\r\n    },\r\n    "search": "Поиск по списку",\r\n    "disableInvite": "Вы запретили приглашать себя в игру",\r\n    "playerDisableInvite": "Игрок запретил приглашать себя в игру",\r\n    "buttons":{\r\n      "playRandom": "Играть с любым",\r\n      "cancelPlayRandom": "Идет подбор игрока...",\r\n      "invite": "Пригласить",\r\n      "cancel": "Отмена"\r\n    }\r\n  },\r\n  "chat":{\r\n    "tabs":{\r\n      "main": "Общий",\r\n      "room": "Стол"\r\n    },\r\n    "inputPlaceholder": "Введите ваше сообщение",\r\n    "templateMessages": {\r\n      "header": "Готовые сообщения"\r\n    },\r\n    "buttons":{\r\n      "send": "Отправить",\r\n      "chatRules": "Правила чата"\r\n    },\r\n    "menu":{\r\n      "answer": "Ответить",\r\n      "showProfile": "Показать профиль",\r\n      "invite": "Пригласить в игру",\r\n      "ban": "Забанить в чате"\r\n    }\r\n  },\r\n  "dialogs":{\r\n    "invite": "Вас пригласил в игру пользователь ",\r\n    "inviteTime": "Осталось: ",\r\n    "user": "Пользователь",\r\n    "rejectInvite": " отклонил ваше приглашение",\r\n    "timeoutInvite": " превысил лимит ожидания в ",\r\n    "seconds": " секунд",\r\n    "askDraw": " предлагает ничью",\r\n    "cancelDraw": "отклонил ваше предложение о ничье",\r\n    "askTakeBack": "просит отменить ход. Разрешить ему?",\r\n    "cancelTakeBack": " отклонил ваше просьбу отменить ход",\r\n    "accept": "Принять",\r\n    "decline": "Отклонить",\r\n    "yes": "Да",\r\n    "no": "Нет",\r\n    "win": "Победа",\r\n    "lose": "Поражение",\r\n    "draw": "Ничья",\r\n    "gameOver": "Игра окончена",\r\n    "scores": "очков",\r\n    "opponentTimeout": "У соперника закончилось время",\r\n    "playerTimeout": "У Вас закончилось время",\r\n    "opponentThrow": "Соперник сдался",\r\n    "playerThrow": "Вы сдались",\r\n    "ratingUp": "Вы поднялись в общем рейтинге с ",\r\n    "ratingPlace": "Вы занимаете ",\r\n    "on": " на ",\r\n    "place": " место в общем рейтинге",\r\n    "dialogPlayAgain": "Сыграть с соперником еще раз?",\r\n    "playAgain": "Да, начать новую игру",\r\n    "leave": "Нет, выйти",\r\n    "waitingOpponent": "Ожидание соперника..",\r\n    "waitingTimeout": "Время ожидания истекло",\r\n    "opponentLeave": "покинул игру",\r\n    "banMessage": "Вы не можете писать сообщения в чате, т.к. добавлены в черный список ",\r\n    "banReason": "за употребление нецензурных выражений и/или спам  ",\r\n    "loginError": "Ошибка авторизации. Обновите страницу"\r\n  },\r\n  "history": {\r\n    "columns": {\r\n      "date": "Дата",\r\n      "opponent": "Противник",\r\n      "time": "Время",\r\n      "number": "#",\r\n      "elo": "Рейтинг"\r\n    },\r\n    "close": "Закрыть окно истории",\r\n    "showMore": "Показать еще",\r\n    "noHistory": "Сохранения отсутствуют",\r\n    "placeholder": "Поиск по имени",\r\n    "months": ["янв", "фев", "мар", "апр", "май", "июн", "июл", "авг", "сен", "окт", "ноя", "дек"]\r\n  },\r\n  "rating": {\r\n    "tabs": {\r\n      "allPlayers": "все игроки"\r\n    },\r\n    "columns": {\r\n      "rank": "Место",\r\n      "userName": "Имя",\r\n      "ratingElo": "Рейтинг <br> Эло",\r\n      "win": "Выиграл",\r\n      "lose": "Проиграл",\r\n      "dateCreate": "Дата <br> регистрации"\r\n    },\r\n    "close": "Закрыть окно рейтинга",\r\n    "placeholder": "Поиск по имени",\r\n    "showMore": "Ещё 500 игроков",\r\n    "jumpTop": "в начало рейтинга",\r\n    "place": " место",\r\n    "you": "Вы",\r\n    "search": "Поиск",\r\n    "novice": "новичок"\r\n  }\r\n}'}),define("text!localization/en.JSON",[],function(){return'{\r\n  "name": "en",\r\n  "userList":{\r\n    "tabs":{\r\n      "free":"Free",\r\n      "inGame":"In Game",\r\n      "spectators": "Spectators"\r\n    },\r\n    "disconnected": {\r\n      "text": "No connection",\r\n      "button": "Reconnect",\r\n      "status": "Loading.."\r\n    },\r\n    "search": "Search in list",\r\n    "disableInvite": "Invites disable",\r\n    "playerDisableInvite": "Invites disable",\r\n    "buttons":{\r\n      "playRandom": "Play with a anyone",\r\n      "cancelPlayRandom": "Waiting a opponent...",\r\n      "invite": "Invite",\r\n      "cancel": "Cancel"\r\n    }\r\n  },\r\n  "chat":{\r\n    "tabs":{\r\n      "main": "Main",\r\n      "room": "Room"\r\n    },\r\n    "inputPlaceholder": "Type your message",\r\n    "templateMessages": {\r\n      "header": "Template messages"\r\n    },\r\n    "buttons":{\r\n      "send": "Send",\r\n      "chatRules": "Chat rules"\r\n    },\r\n    "menu":{\r\n      "answer": "Answer",\r\n      "showProfile": "Show profile",\r\n      "invite": "Send invite",\r\n      "ban": "ban"\r\n    }\r\n  },\r\n  "dialogs":{\r\n    "invite": "You are invited to play by ",\r\n    "inviteTime": "Remaining: ",\r\n    "user": "User",\r\n    "rejectInvite": " has declined your invitation",\r\n    "timeoutInvite": " limit exceeded expectations ",\r\n    "seconds": " seconds",\r\n    "askDraw": " offers a draw",\r\n    "cancelDraw": "declined your proposal for a draw",\r\n    "askTakeBack": "asks to cancel turn. Allow him?",\r\n    "cancelTakeBack": " declined your request to cancel turn",\r\n    "accept": "Accept",\r\n    "decline": "Decline",\r\n    "yes": "Yes",\r\n    "no": "No",\r\n    "win": "Win",\r\n    "lose": "Lose",\r\n    "draw": "Draw",\r\n    "gameOver": "Game over",\r\n    "scores": "scores",\r\n    "opponentTimeout": "Opponent time is over",\r\n    "playerTimeout": "Your time is over",\r\n    "opponentThrow": "Opponent surrendered",\r\n    "playerThrow": "You surrendered",\r\n    "ratingUp": "You have risen in the overall ranking from ",\r\n    "ratingPlace": "You take ",\r\n    "on": " to ",\r\n    "place": " place in ranking",\r\n    "dialogPlayAgain": "Play with your opponent again?",\r\n    "playAgain": "Yes, play again",\r\n    "leave": "No, leave",\r\n    "waitingOpponent": "Waiting for opponent..",\r\n    "waitingTimeout": "Timeout",\r\n    "opponentLeave": "left the game",\r\n    "banMessage": "You can not write messages in chat since added to the black list ",\r\n    "banReason": "for the use of foul language and / or spam  ",\r\n    "loginError": "Authorisation Error. Refresh the page"\r\n  },\r\n  "history": {\r\n    "columns": {\r\n      "date": "Date",\r\n      "opponent": "Opponent",\r\n      "time": "Time",\r\n      "number": "#",\r\n      "elo": "Rating"\r\n    },\r\n    "close": "Close history window",\r\n    "showMore": "Show more",\r\n    "noHistory": "no history",\r\n    "placeholder": "Search by name",\r\n    "months": ["jan", "feb", "mar", "apr", "may", "jun", "jul", "aug", "sep", "oct", "nov", "dec"]\r\n  },\r\n  "rating": {\r\n    "tabs": {\r\n      "allPlayers": "All players"\r\n    },\r\n    "columns": {\r\n      "rank": "Place",\r\n      "userName": "Name",\r\n      "ratingElo": "Rating <br> Elo",\r\n      "win": "Win",\r\n      "lose": "Lose",\r\n      "dateCreate": "Registration <br> date"\r\n    },\r\n    "close": "Close rating window",\r\n    "placeholder": "Search by name",\r\n    "showMore": "More 500 players",\r\n    "jumpTop": "to rating top",\r\n    "place": " place",\r\n    "you": "You",\r\n    "search": "Search",\r\n    "novice": "novice"\r\n  }\r\n}'}),define("modules/localization_manager",["EE","text!localization/ru.JSON","text!localization/en.JSON"],function(a,b,c){var d=function(a){this.client=a,this.localization=e,"string"!=typeof this.client.lang&&(this.client.lang=!1),this.client.lang=this.initLanguage(),console.log("localization_manager;","lang",this.client.lang),this.client.locale=this.initLocalization(),console.log("localization_manager;","locale",this.client.locale)};d.prototype.initLanguage=function(){var a=window.navigator,b=this.client.lang||(a.languages?a.languages[0]:a.language||a.userLanguage)||"ru";try{b=b.substr(0,2).toLocaleLowerCase()}catch(c){console.error("localization_manager;","initLanguage",c)}return("string"!=typeof b||2!=b.length)&&(b="ru"),b},d.prototype.initLocalization=function(){this.localization.ru=JSON.parse(b),this.localization.en=JSON.parse(c),this.localization=$.extend(!0,this.localization,this.client.opts.localization);var a=this.localization[this.client.lang]||this.localization.en;return a=$.extend(!0,{},this.localization[this.localization["default"]],a),a.get=e._get,a};var e={"default":"ru",_get:function(a){for(var b=a.split("."),c=this;b.length&&(c=c[b.shift()]););return c}};return d}),!function(a){a.idleTimer=function(b,c){var d;"object"==typeof b?(d=b,b=null):"number"==typeof b&&(d={timeout:b},b=null),c=c||document,d=a.extend({idle:!1,timeout:3e4,events:"mousemove keydown wheel DOMMouseScroll mousewheel mousedown touchstart touchmove MSPointerDown MSPointerMove"},d);var e=a(c),f=e.data("idleTimerObj")||{},g=function(b){var d=a.data(c,"idleTimerObj")||{};d.idle=!d.idle,d.olddate=+new Date;var e=a.Event((d.idle?"idle":"active")+".idleTimer");a(c).trigger(e,[c,a.extend({},d),b])},h=function(b){var d=a.data(c,"idleTimerObj")||{};if(null==d.remaining){if("mousemove"===b.type){if(b.pageX===d.pageX&&b.pageY===d.pageY)return;if("undefined"==typeof b.pageX&&"undefined"==typeof b.pageY)return;var e=+new Date-d.olddate;if(200>e)return}clearTimeout(d.tId),d.idle&&g(b),d.lastActive=+new Date,d.pageX=b.pageX,d.pageY=b.pageY,d.tId=setTimeout(g,d.timeout)}},i=function(){var b=a.data(c,"idleTimerObj")||{};b.idle=b.idleBackup,b.olddate=+new Date,b.lastActive=b.olddate,b.remaining=null,clearTimeout(b.tId),b.idle||(b.tId=setTimeout(g,b.timeout))},j=function(){var b=a.data(c,"idleTimerObj")||{};null==b.remaining&&(b.remaining=b.timeout-(+new Date-b.olddate),clearTimeout(b.tId))},k=function(){var b=a.data(c,"idleTimerObj")||{};null!=b.remaining&&(b.idle||(b.tId=setTimeout(g,b.remaining)),b.remaining=null)},l=function(){var b=a.data(c,"idleTimerObj")||{};clearTimeout(b.tId),e.removeData("idleTimerObj"),e.off("._idleTimer")},m=function(){var b=a.data(c,"idleTimerObj")||{};if(b.idle)return 0;if(null!=b.remaining)return b.remaining;var d=b.timeout-(+new Date-b.lastActive);return 0>d&&(d=0),d};if(null===b&&"undefined"!=typeof f.idle)return i(),e;if(null===b);else{if(null!==b&&"undefined"==typeof f.idle)return!1;if("destroy"===b)return l(),e;if("pause"===b)return j(),e;if("resume"===b)return k(),e;if("reset"===b)return i(),e;if("getRemainingTime"===b)return m();if("getElapsedTime"===b)return+new Date-f.olddate;if("getLastActiveTime"===b)return f.lastActive;if("isIdle"===b)return f.idle}return e.on(a.trim((d.events+" ").split(" ").join("._idleTimer ")),function(a){h(a)}),f=a.extend({},{olddate:+new Date,lastActive:+new Date,idle:d.idle,idleBackup:d.idle,timeout:d.timeout,remaining:null,tId:null,pageX:null,pageY:null}),f.idle||(f.tId=setTimeout(g,f.timeout)),a.data(c,"idleTimerObj",f),e},a.fn.idleTimer=function(b){return this[0]?a.idleTimer(b,this[0]):this}}(jQuery),define("idleTimer",function(){}),define("client",["modules/game_manager","modules/invite_manager","modules/user_list","modules/socket","modules/views_manager","modules/chat_manager","modules/history_manager","modules/rating_manager","modules/sound_manager","modules/admin_manager","modules/localization_manager","EE","idleTimer"],function(a,b,c,d,e,f,g,h,i,j,k,l){var m=function(l){this.version="0.9.18",l.resultDialogDelay=l.resultDialogDelay||0,l.modes=l.modes||l.gameModes||["default"],l.reload=!1,l.turnTime=l.turnTime||60,l.blocks=l.blocks||{},l.images=o,l.sounds=$.extend({},p,l.sounds||{}),l.autoReconnect=0!=l.autoReconnect,l.idleTimeout=1e3*(l.idleTimeout||60),l.loadRanksInRating=!1,l.autoShowProfile=!!l.autoShowProfile||!1,l.shortGuestNames=!!l.shortGuestNames||!1,l.newGameFormat=!!l.newGameFormat||!1,l.vk=l.vk||{},l.showSpectators=l.showSpectators||!1,l.localization=l.localization||{},l.autoScrollPlayerList=!1,l.showHidden=!1,l.showCheaters=!1;try{this.isAdmin=l.isAdmin||LogicGame.isSuperUser()}catch(m){this.isAdmin=!1,console.error(m)}var q=this;this.opts=this.conf=l,this.game=l.game||"test",this.defaultSettings=$.extend(!0,{},n,l.settings||{}),this.settings=$.extend(!0,{},this.defaultSettings),this.lang=l.lang,this.locale=l.localization,this.modesAlias={},this.localizationManager=new k(this),this.gameManager=new a(this),this.userList=new c(this),this.inviteManager=new b(this),this.chatManager=new f(this),this.viewsManager=new e(this),this.historyManager=new g(this),this.ratingManager=new h(this),this.soundManager=new i(this),this.adminManager=new j(this),this.vkWallPost=l.vk.url?this.checkVKWallPostEnabled():!1,this.vkEnable=window.VK&&window.VK.api&&window._isVk,this.currentMode=null,this.reconnectTimeout=null,this.timeoutUserChanged=null,this.lastTimeUserChanged=0,this.isFocused=!0,this.TIME_BETWEEN_RECONNECTION=3e3,this.socket=new d(l),this.socket.on("connection",function(){console.log("client;","socket connected"),clearTimeout(q.reconnectTimeout),q.relogin=q.reconnection,q.isLogin=!1,q.socket.send({module:"server",type:"login",target:"server",data:q.loginData}),q.reconnection=!1}),this.socket.on("disconnection",function(){console.log("client;","socket disconnected"),q.reconnection=!1,q.isLogin=!1,q.emit("disconnected"),!q.closedByServer&&q.opts.autoReconnect&&(q.reconnectTimeout=setTimeout(q.reconnect.bind(q),0==q.socket.connectionCount?100:q.TIME_BETWEEN_RECONNECTION))}),this.socket.on("failed",function(){console.log("client;","socket connection failed"),q.reconnection=!1,q.emit("disconnected"),!q.closedByServer&&q.opts.autoReconnect&&(q.reconnectTimeout=setTimeout(q.reconnect.bind(q),5*q.TIME_BETWEEN_RECONNECTION))}),this.socket.on("message",function(a){console.log("client;","socket message",a),q.onMessage(a)}),this.getUser=this.userList.getUser.bind(this.userList),q.unload=!1,window.onbeforeunload=function(){q.unload=!0},l.idleTimeout>0&&$(document).idleTimer(l.idleTimeout),$(document).on("idle.idleTimer",function(){q.isActive=!1,q.sendChanged()}),$(document).on("active.idleTimer",function(){q.isActive=!0,q.sendChanged()})};m.prototype=new l,m.prototype.init=function(a){if(a=a||{},a.userId=a.userId||window._userId,a.userName=a.userName||window._username,a.sign=a.sign||window._sign||"",!a.userName||!a.userId||!a.sign||"undefined"==a.userName||"undefined"==a.userId||"undefined"==a.sign)throw new Error("Client init error, wrong user parameters userId: "+a.userId," userName: "+a.userName+" sign"+a.sign);return document.cookie="_userId="+a.userId+"; path=/;",this.loginData=a,this.socket.init(),this.viewsManager.init(),console.log("client;","init version:",this.version),this},m.prototype.reconnect=function(a){clearTimeout(this.reconnectTimeout);var b=Date.now()-this.socket.timeConnection;return console.log("client;","reconnect, last was",b,"ms ago"),b<this.TIME_BETWEEN_RECONNECTION?void(this.reconnectTimeout=setTimeout(this.reconnect.bind(this),this.TIME_BETWEEN_RECONNECTION-b)):this.isLogin&&!a?void console.log("client;","connected!"):this.socket.connectionCount>10||this.opts.reload?void location.reload(!1):(this.reconnection=!0,void this.socket.init())},m.prototype.onMessage=function(a){switch(a.module){case"server":this.onServerMessage(a);break;case"invite_manager":this.inviteManager.onMessage(a);break;case"game_manager":this.gameManager.onMessage(a);break;case"chat_manager":this.chatManager.onMessage(a);break;case"history_manager":this.historyManager.onMessage(a);break;case"rating_manager":this.ratingManager.onMessage(a);break;case"admin":this.adminManager.onMessage(a)}},m.prototype.onServerMessage=function(a){var b=a.data;switch(a.type){case"login":this.onLogin(b);break;case"user_relogin":var c=this.userList.getUser(b.userId);console.log("client;","user relogin",c),c&&this.emit("user_relogin",c);break;case"user_login":this.userList.onUserLogin(b);break;case"user_leave":this.userList.onUserLeave(b);break;case"user_changed":this.userList.onUserChanged(b);break;case"new_game":this.userList.onGameStart(b.room,b.players),this.gameManager.onMessage(a);break;case"end_game":this.userList.onGameEnd(b.room,b.players);break;case"error":this.onError(b)}},m.prototype.onLogin=function(a){var b=a.you,c=a.userlist,d=a.rooms,e=a.ban,f=a.settings,g=a.opts,h=a.waiting;console.log("client;","login",b,c,d,g,e,f,h),f=f||{},this.game=this.opts.game=g.game,this.modes=this.opts.modes=g.modes,this.modesAlias=this.opts.modesAlias=g.modesAlias||this.modesAlias,this.locale.modes=$.extend(!0,this.modesAlias,this.locale.modes),this.opts.turnTime=g.turnTime,this.opts.loadRanksInRating=!!g.loadRanksInRating,this.chatManager.ban=e,this.currentMode=this.modes[0],this.settings=$.extend({},this.defaultSettings,f),console.log("client;","settings",this.settings),this.userList.onUserLogin(b,!0);for(var i=0;i<c.length;i++)this.userList.onUserLogin(c[i]);for(this.userList.onWaiting(h),i=0;i<d.length;i++)this.userList.onGameStart(d[i].room,d[i].players);this.isLogin=!0,this.emit(this.relogin?"relogin":"login",b),this.ratingManager.init(),this.historyManager.init(),this.relogin=!1},m.prototype.send=function(a,b,c,d){return this.socket.isConnected?this.isLogin?("object"==typeof a&&a.module&&a.type&&a.data&&(b=a.type,d=a.data,c=a.target,a=a.module),a&&b&&d&&c?("server"!=c&&(this.userList.getUser(c)||console.warn("client;","send message to offline user!",c)),void this.socket.send({module:a,type:b,target:c,data:d})):void console.warn("client;","some arguments undefined!",a,b,c,d)):void console.error("Client can not send message, client is not login!"):void console.error("Client can not send message, socket is not connected!")},m.prototype.setMode=function(a){if(!this.socket.isConnected||!this.isLogin)return void console.error("Client can set mode, socket is not connected!");if(!this.modes||this.modes.length<1)return void console.error("Client can set mode, no modes!");if(this.modes[a]&&this.currentMode!=this.modes[a])return this.currentMode=this.modes[a],void this.emit("mode_switch",this.currentMode);for(var b=0;b<this.modes.length;b++)if(this.modes[b]==a)return this.currentMode=a,void this.emit("mode_switch",this.currentMode);console.error("wrong mode:",a,"client modes:",this.modes)},m.prototype.onError=function(a){switch(console.error("client;","server error",a),a){case"login_error":this.emit("login_error"),this.socket.ws.close();break;case"new_connection":this.viewsManager.dialogsView.showDialog("Запущена еще одна копия игры",{}),this.closedByServer=!0}},m.prototype.onShowProfile=function(a,b){if(this.isLogin){if(!b){var c=this.userList.getUser(a);if(!c)return void console.error("client;","user",a," is not online!, can not get his name");b=c.fullName}this.emit("show_profile",{userId:a,userName:b}),this.opts.autoShowProfile&&this.viewsManager.showUserProfile(a,b)}},m.prototype.getPlayer=function(){return this.userList.player},m.prototype.getModeAlias=function(a){return this.modesAlias[a]?this.modesAlias[a]:a},m.prototype.saveSettings=function(a){a=a||this.settings;var b={};for(var c in this.defaultSettings)this.defaultSettings.hasOwnProperty(c)&&(b[c]=a[c]);console.log("client;","save settings:",b),this.send("server","settings","server",b),this.emit("settings_saved",a),this.viewsManager.settingsView.changedProperties.indexOf(!0)&&this.sendChanged()},m.prototype.sendChanged=function(){Date.now()-this.lastTimeUserChanged>1e3?(clearTimeout(this.timeoutUserChanged),this.lastTimeUserChanged=Date.now(),this.send("server","changed","server",{isActive:this.isActive})):(console.log("client;","user_changed!","to fast to send user changed!"),setTimeout(this.sendChanged.bind(this),1100-(Date.now()-this.lastTimeUserChanged)))},m.prototype._onSettingsChanged=function(a){this.emit("settings_changed",a),"disableInvite"==a.property&&(this.getPlayer().disableInvite=a.value,this.userList.onUserChanged(this.getPlayer()))},m.prototype.checkVKWallPostEnabled=function(){this.vkWallPost=!1,this.vkEnable&&window.VK.api("account.getAppPermissions",function(a){a&&a.response&&console.log("client; checkVKWallPostEnabled; permissions",a.response),this.vkWallPost=!!(8192&a.response)}.bind(this))},m.prototype.vkInviteFriend=function(){this.vkEnable&&window.VK.callMethod("showInviteBox")},m.prototype.vkWallPostResult=function(a){console.log("client;","vkWallPostResult",a),this.opts.vk.title&&(a+=" в "+this.opts.vk.title);var b=(this.opts.vk.photo||"")+","+(this.opts.vk.url||"");try{VK.api("wall.post",{message:a,attachments:b},function(a){console.log(a)})}catch(c){console.log("client;","vkWallPostResult",c)}},m.prototype.showCheaters=function(){this.opts.showCheaters=!0;for(var a=0;a<this.userList.users.length;a++)for(var b=0;b<this.modes.length;b++)if(this.userList.users[a][this.modes[b]].timeLastCheatGame){this.userList.users[a].userName="cheater!"+this.userList.users[a].userName;break}};var n={disableInvite:!1,sounds:!0},o={close:"//logic-games.spb.ru/v6-game-client/app/i/close.png",spin:"//logic-games.spb.ru/v6-game-client/app/i/spin.gif",sortAsc:"//logic-games.spb.ru/v6-game-client/app/i/sort-asc.png",sortDesc:"//logic-games.spb.ru/v6-game-client/app/i/sort-desc.png",sortBoth:"//logic-games.spb.ru/v6-game-client/app/i/sort-both.png",del:"//logic-games.spb.ru/v6-game-client/app/i/delete.png",block:"//logic-games.spb.ru/v6-game-client/app/i/stop.png"},p={start:{src:"//logic-games.spb.ru/v6-game-client/app/audio/v6-game-start.ogg"},turn:{src:"//logic-games.spb.ru/v6-game-client/app/audio/v6-game-turn.ogg",volume:.5,enable:!1},win:{src:"//logic-games.spb.ru/v6-game-client/app/audio/v6-game-win.ogg"},lose:{src:"//logic-games.spb.ru/v6-game-client/app/audio/v6-game-lose.ogg"},invite:{src:"//logic-games.spb.ru/v6-game-client/app/audio/v6-invite.ogg"},timeout:{src:"//logic-games.spb.ru/v6-game-client/app/audio/v6-timeout.ogg"}};return m}),define("v6-game-client",["client"],function(a){return console.log("main;",new Date,"ready"),a});